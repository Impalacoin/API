VERSION 5.00
Object = "{831FDD16-0C5C-11D2-A9FC-0000F8754DA1}#2.1#0"; "MSCOMCTL.OCX"
Object = "{248DD890-BB45-11CF-9ABC-0080C7E7B78D}#1.0#0"; "MSWINSCK.OCX"
Begin VB.Form ZapBridge 
   AutoRedraw      =   -1  'True
   BackColor       =   &H00C0C0C0&
   Caption         =   "EmServ Payment Gateway"
   ClientHeight    =   10335
   ClientLeft      =   225
   ClientTop       =   870
   ClientWidth     =   15540
   FillColor       =   &H8000000F&
   FillStyle       =   0  'Solid
   ForeColor       =   &H00C0C0C0&
   Icon            =   "ZapBridge.frx":0000
   LinkTopic       =   "Form1"
   ScaleHeight     =   10335
   ScaleWidth      =   15540
   StartUpPosition =   3  'Windows Default
   WindowState     =   2  'Maximized
   Begin VB.Frame Frame3 
      Caption         =   "Transaction Monitor"
      ClipControls    =   0   'False
      Height          =   1935
      Left            =   120
      TabIndex        =   20
      Top             =   8160
      Visible         =   0   'False
      Width           =   15135
      Begin VB.ListBox List3 
         BackColor       =   &H8000000B&
         Height          =   1425
         ItemData        =   "ZapBridge.frx":030A
         Left            =   13200
         List            =   "ZapBridge.frx":030C
         TabIndex        =   29
         Top             =   240
         Width           =   6735
      End
      Begin VB.ListBox List2 
         BackColor       =   &H80000018&
         Height          =   1425
         ItemData        =   "ZapBridge.frx":030E
         Left            =   6200
         List            =   "ZapBridge.frx":0310
         TabIndex        =   28
         Top             =   240
         Width           =   6975
      End
      Begin VB.ListBox List1 
         BackColor       =   &H8000000B&
         Height          =   1425
         ItemData        =   "ZapBridge.frx":0312
         Left            =   120
         List            =   "ZapBridge.frx":0314
         TabIndex        =   27
         Top             =   240
         Width           =   6015
      End
   End
   Begin VB.CommandButton Command5 
      BackColor       =   &H00E0E0E0&
      Caption         =   "Clear Events"
      Height          =   855
      Left            =   5280
      Picture         =   "ZapBridge.frx":0316
      Style           =   1  'Graphical
      TabIndex        =   14
      Top             =   3000
      Width           =   735
   End
   Begin VB.CommandButton Command4 
      BackColor       =   &H00E0E0E0&
      Caption         =   "View Events"
      Height          =   855
      Left            =   5280
      Picture         =   "ZapBridge.frx":1398
      Style           =   1  'Graphical
      TabIndex        =   13
      Top             =   2160
      Width           =   735
   End
   Begin VB.CommandButton Command3 
      BackColor       =   &H00E0E0E0&
      Caption         =   "Trace OFF"
      Height          =   855
      Left            =   5280
      Picture         =   "ZapBridge.frx":17DA
      Style           =   1  'Graphical
      TabIndex        =   12
      Top             =   1320
      Width           =   735
   End
   Begin VB.CommandButton Command2 
      BackColor       =   &H00E0E0E0&
      Caption         =   "Start Trace"
      Height          =   855
      Left            =   5280
      Picture         =   "ZapBridge.frx":2554
      Style           =   1  'Graphical
      TabIndex        =   11
      Top             =   480
      Width           =   735
   End
   Begin VB.Frame Frame2 
      Caption         =   "Client Type Connections Monitoring && Control"
      Height          =   3855
      Left            =   7320
      TabIndex        =   8
      Top             =   4320
      Width           =   7575
      Begin VB.CheckBox IsControl 
         Appearance      =   0  'Flat
         BackColor       =   &H00FFC0C0&
         Caption         =   "Start Service"
         ForeColor       =   &H80000008&
         Height          =   255
         Index           =   0
         Left            =   2040
         TabIndex        =   10
         Top             =   240
         Visible         =   0   'False
         Width           =   1215
      End
      Begin VB.Image Image8 
         Height          =   240
         Left            =   5640
         Picture         =   "ZapBridge.frx":32CE
         Top             =   1680
         Visible         =   0   'False
         Width           =   240
      End
      Begin VB.Image Image6 
         Height          =   240
         Left            =   5640
         Picture         =   "ZapBridge.frx":4048
         Top             =   1680
         Width           =   240
      End
      Begin VB.Line Line2 
         BorderColor     =   &H00404040&
         BorderWidth     =   2
         Index           =   0
         Visible         =   0   'False
         X1              =   3240
         X2              =   5280
         Y1              =   480
         Y2              =   480
      End
      Begin VB.Shape Shape4 
         BorderColor     =   &H00C0C0C0&
         BorderWidth     =   2
         Height          =   3255
         Left            =   5280
         Top             =   240
         Width           =   975
      End
      Begin VB.Label IssLabel 
         Appearance      =   0  'Flat
         BackColor       =   &H00FFC0C0&
         BorderStyle     =   1  'Fixed Single
         Caption         =   "Issuers"
         ForeColor       =   &H80000008&
         Height          =   255
         Index           =   0
         Left            =   120
         TabIndex        =   9
         Top             =   240
         Visible         =   0   'False
         Width           =   1910
      End
   End
   Begin VB.Timer Timer1 
      Interval        =   10000
      Left            =   7080
      Top             =   0
   End
   Begin MSWinsockLib.Winsock MerchantSocket 
      Index           =   0
      Left            =   6600
      Top             =   0
      _ExtentX        =   741
      _ExtentY        =   741
      _Version        =   393216
   End
   Begin VB.Frame Frame6 
      Caption         =   "Server Type Conections Monitoring && Control"
      Height          =   3855
      Left            =   120
      TabIndex        =   4
      Top             =   4320
      Width           =   6975
      Begin VB.CheckBox MchControl 
         Appearance      =   0  'Flat
         BackColor       =   &H00FFC0C0&
         Caption         =   "Start Service"
         ForeColor       =   &H80000008&
         Height          =   225
         Index           =   0
         Left            =   2040
         TabIndex        =   6
         Top             =   240
         Visible         =   0   'False
         Width           =   1245
      End
      Begin VB.Image Image7 
         Height          =   240
         Left            =   5640
         Picture         =   "ZapBridge.frx":4DC2
         Top             =   1560
         Visible         =   0   'False
         Width           =   240
      End
      Begin VB.Line Line1 
         BorderColor     =   &H00404040&
         BorderWidth     =   2
         Index           =   0
         Visible         =   0   'False
         X1              =   3360
         X2              =   5280
         Y1              =   480
         Y2              =   480
      End
      Begin VB.Image Image5 
         Height          =   240
         Left            =   5640
         Picture         =   "ZapBridge.frx":5B3C
         Top             =   1560
         Width           =   240
      End
      Begin VB.Shape Shape3 
         BorderColor     =   &H00C0C0C0&
         BorderWidth     =   2
         Height          =   3255
         Left            =   5280
         Top             =   240
         Width           =   975
      End
      Begin VB.Label MchntLabel 
         Appearance      =   0  'Flat
         BackColor       =   &H00FFC0C0&
         BorderStyle     =   1  'Fixed Single
         Caption         =   "Merchants"
         ForeColor       =   &H80000008&
         Height          =   255
         Index           =   0
         Left            =   120
         TabIndex        =   5
         Top             =   240
         Visible         =   0   'False
         Width           =   1910
      End
   End
   Begin VB.Timer expiryTimer 
      Interval        =   60000
      Left            =   6120
      Top             =   0
   End
   Begin VB.Timer ISConnectionTimer 
      Interval        =   15000
      Left            =   4440
      Top             =   3480
   End
   Begin MSWinsockLib.Winsock SwitchSocket 
      Index           =   0
      Left            =   2640
      Top             =   3480
      _ExtentX        =   741
      _ExtentY        =   741
      _Version        =   393216
   End
   Begin MSWinsockLib.Winsock MobileSocket 
      Index           =   0
      Left            =   3240
      Top             =   3480
      _ExtentX        =   741
      _ExtentY        =   741
      _Version        =   393216
   End
   Begin VB.Frame Frame4 
      BackColor       =   &H00E0E0E0&
      Caption         =   "Message and Event Log"
      Height          =   3975
      Left            =   6000
      TabIndex        =   2
      Top             =   120
      Width           =   8775
      Begin VB.TextBox txt_log 
         BackColor       =   &H00C0FFFF&
         Height          =   3615
         Left            =   120
         MultiLine       =   -1  'True
         ScrollBars      =   2  'Vertical
         TabIndex        =   3
         Top             =   240
         Width           =   8535
      End
   End
   Begin MSComctlLib.StatusBar StatusBar 
      Align           =   2  'Align Bottom
      DragIcon        =   "ZapBridge.frx":68B6
      Height          =   360
      Left            =   0
      TabIndex        =   1
      Top             =   9975
      Width           =   15540
      _ExtentX        =   27411
      _ExtentY        =   635
      _Version        =   393216
      BeginProperty Panels {8E3867A5-8586-11D1-B16A-00C0F0283628} 
         NumPanels       =   1
         BeginProperty Panel1 {8E3867AB-8586-11D1-B16A-00C0F0283628} 
         EndProperty
      EndProperty
   End
   Begin VB.Frame Frame1 
      Height          =   3975
      Left            =   120
      TabIndex        =   0
      Top             =   120
      Width           =   4815
      Begin VB.Timer FrateTmer 
         Interval        =   60000
         Left            =   1560
         Top             =   480
      End
      Begin VB.Timer TransTmr 
         Enabled         =   0   'False
         Index           =   0
         Interval        =   30000
         Left            =   240
         Top             =   240
      End
      Begin MSWinsockLib.Winsock HsmSck 
         Left            =   1320
         Top             =   3360
         _ExtentX        =   741
         _ExtentY        =   741
         _Version        =   393216
      End
      Begin VB.CommandButton Command1 
         Height          =   735
         Left            =   3720
         Picture         =   "ZapBridge.frx":6BC0
         Style           =   1  'Graphical
         TabIndex        =   19
         Top             =   120
         Width           =   975
      End
      Begin MSWinsockLib.Winsock sckClientPostilion 
         Left            =   3720
         Top             =   3360
         _ExtentX        =   741
         _ExtentY        =   741
         _Version        =   393216
      End
      Begin VB.Timer TransLiveTimer 
         Index           =   0
         Interval        =   5000
         Left            =   960
         Top             =   3360
      End
      Begin VB.Timer TmrProcessor 
         Interval        =   5000
         Left            =   480
         Top             =   3360
      End
      Begin VB.Timer ConnectionTimer 
         Interval        =   10000
         Left            =   0
         Top             =   3360
      End
      Begin MSWinsockLib.Winsock PostilionSck 
         Left            =   1920
         Top             =   3360
         _ExtentX        =   741
         _ExtentY        =   741
         _Version        =   393216
      End
      Begin VB.Image Image13 
         Height          =   480
         Left            =   3960
         Picture         =   "ZapBridge.frx":95AA
         Top             =   2760
         Visible         =   0   'False
         Width           =   480
      End
      Begin VB.Image Image11 
         Height          =   480
         Left            =   3960
         Picture         =   "ZapBridge.frx":99EC
         Top             =   2760
         Width           =   480
      End
      Begin VB.Label Label11 
         BackColor       =   &H0000FF00&
         Caption         =   "Connection Down ...."
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   9.75
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   255
         Left            =   960
         TabIndex        =   26
         Top             =   3045
         Visible         =   0   'False
         Width           =   2535
      End
      Begin VB.Label Label10 
         BackColor       =   &H000000FF&
         Caption         =   "Connection Down ...."
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   9.75
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   255
         Left            =   960
         TabIndex        =   25
         Top             =   3040
         Width           =   2535
      End
      Begin VB.Label Label9 
         BorderStyle     =   1  'Fixed Single
         Caption         =   "WebServer connection"
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   9.75
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   255
         Left            =   960
         TabIndex        =   24
         Top             =   2760
         Width           =   2895
      End
      Begin VB.Shape Shape6 
         BorderColor     =   &H80000003&
         FillColor       =   &H00FFFFFF&
         Height          =   735
         Left            =   120
         Top             =   2640
         Width           =   4695
      End
      Begin VB.Shape Shape5 
         BorderColor     =   &H80000003&
         FillColor       =   &H00FFFFFF&
         Height          =   735
         Left            =   120
         Top             =   1800
         Width           =   4695
      End
      Begin VB.Label Label8 
         BackColor       =   &H000000FF&
         Caption         =   "Connection Down ...."
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   9.75
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   255
         Left            =   960
         TabIndex        =   23
         Top             =   2220
         Width           =   2535
      End
      Begin VB.Label Label7 
         BackColor       =   &H0000FF00&
         Caption         =   "Connection Up ...."
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   9.75
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   255
         Left            =   960
         TabIndex        =   22
         Top             =   2220
         Visible         =   0   'False
         Width           =   2535
      End
      Begin VB.Image Image10 
         Height          =   480
         Left            =   3960
         Picture         =   "ZapBridge.frx":9E2E
         Top             =   1800
         Width           =   480
      End
      Begin VB.Image Image9 
         Height          =   480
         Left            =   3960
         Picture         =   "ZapBridge.frx":A270
         Top             =   1800
         Visible         =   0   'False
         Width           =   480
      End
      Begin VB.Label Label6 
         BorderStyle     =   1  'Fixed Single
         Caption         =   "HSM connection"
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   9.75
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   255
         Left            =   960
         TabIndex        =   21
         Top             =   1920
         Width           =   2895
      End
      Begin VB.Label Label5 
         Caption         =   "Resync New Connections"
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   9.75
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         ForeColor       =   &H00000000&
         Height          =   375
         Left            =   960
         TabIndex        =   18
         Top             =   240
         Width           =   2415
      End
      Begin VB.Shape Shape2 
         BorderColor     =   &H80000002&
         Height          =   855
         Left            =   3600
         Top             =   120
         Width           =   1215
      End
      Begin VB.Label Label4 
         BackColor       =   &H0000FF00&
         Caption         =   "Connection Up ...."
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   9.75
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   255
         Left            =   960
         TabIndex        =   17
         Top             =   1400
         Visible         =   0   'False
         Width           =   2535
      End
      Begin VB.Label Label3 
         BackColor       =   &H000000FF&
         Caption         =   "Connection Down ...."
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   9.75
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   255
         Left            =   960
         TabIndex        =   16
         Top             =   1400
         Width           =   2535
      End
      Begin VB.Shape Shape1 
         BorderColor     =   &H80000003&
         FillColor       =   &H00FFFFFF&
         Height          =   735
         Left            =   120
         Top             =   960
         Width           =   4695
      End
      Begin VB.Image Image2 
         Height          =   480
         Left            =   3960
         Picture         =   "ZapBridge.frx":A6B2
         Top             =   1080
         Visible         =   0   'False
         Width           =   480
      End
      Begin VB.Image Image1 
         Height          =   480
         Left            =   3960
         Picture         =   "ZapBridge.frx":AAF4
         Top             =   1080
         Width           =   480
      End
      Begin VB.Label Label2 
         BorderStyle     =   1  'Fixed Single
         Caption         =   "Connection Status Data Server: "
         BeginProperty Font 
            Name            =   "MS Sans Serif"
            Size            =   9.75
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   255
         Left            =   945
         TabIndex        =   15
         Top             =   1080
         Width           =   2895
      End
   End
   Begin VB.Image Image12 
      Height          =   480
      Left            =   4080
      Picture         =   "ZapBridge.frx":AF36
      Top             =   2880
      Visible         =   0   'False
      Width           =   480
   End
   Begin VB.Image Image4 
      Height          =   480
      Left            =   5400
      Picture         =   "ZapBridge.frx":B378
      Top             =   0
      Width           =   480
   End
   Begin VB.Image Image3 
      Height          =   480
      Left            =   5400
      Picture         =   "ZapBridge.frx":B7BA
      Top             =   0
      Visible         =   0   'False
      Width           =   480
   End
   Begin VB.Label Label1 
      BackColor       =   &H00C0C0C0&
      Caption         =   "Payment Engine is online"
      BeginProperty Font 
         Name            =   "MS Sans Serif"
         Size            =   9.75
         Charset         =   0
         Weight          =   700
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      ForeColor       =   &H8000000D&
      Height          =   300
      Left            =   120
      TabIndex        =   7
      Top             =   4080
      Width           =   3975
   End
   Begin VB.Menu File 
      Caption         =   "&File"
      Begin VB.Menu Stop 
         Caption         =   "&Stop Interface Services"
      End
      Begin VB.Menu Settings 
         Caption         =   "Settings"
      End
   End
   Begin VB.Menu Interchanges 
      Caption         =   "&Interchanges"
      Index           =   0
   End
   Begin VB.Menu CountryCode 
      Caption         =   "&View Exchange Rates"
   End
   Begin VB.Menu Rates 
      Caption         =   "&Upload Currency Rates"
   End
   Begin VB.Menu CurrencyCodes 
      Caption         =   "&Currency Codes"
   End
   Begin VB.Menu Trace 
      Caption         =   "&Trace Viewer"
   End
   Begin VB.Menu interdetails 
      Caption         =   "Interchange Services &Details"
      Begin VB.Menu Uptime 
         Caption         =   "Interface &Uptime"
      End
      Begin VB.Menu switchedIn 
         Caption         =   "Start iGateway Interface"
      End
   End
   Begin VB.Menu TransHist 
      Caption         =   "&Host Security Module"
   End
   Begin VB.Menu help 
      Caption         =   "&Help"
   End
End
Attribute VB_Name = "ZapBridge"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False

Option Explicit



Private VMisidn As Variant ' message type
Private VMisidn_2 As Variant
Private VAuthorizationCode As Variant
Private VRandomBase As Integer
Private VModulaBase As Integer
Private VVerificationState As Boolean
Private Trace_Flag As Integer
Private MobileSocketArray() As Integer
Private DisConPointerArray() As Integer
Private IssConPointerArray() As Integer
Private TransTimers() As Integer
Private mobileConnectionCounter As Integer
Private TRACEFILE() As String
Private EventsTrap As Variant
Private strStatusBarText As String
Private POSTILION_IP As String
Private ZAP_IP As String
Private POSTILION_PORT As String
Private ZAP_PORT As String
Private HSM_IP As String
Private HSM_PORT As String
Private SwtcIP As String
Private swtcPort As String
Private mobIp As String
Private mobPort As String
Public DB As String
Public USER_ID As String
Public PSW As String
Public MessageMerc As String
Public EM_SERVER As String
Private TmrTran_counter As Integer
Private Airtel_settlement_Acc As String
Private MaxTransLiveTime() As String
Private Encyptor As EBL_Encryption.clsEncryption
'Mobile connection variables
Private LOCAL_IP As String
Private REMOTE_MOBILE_IP As String
Private LOCAL_MOBILE_PORT As String
Private REMOTE_MOBILE_PORT As String
Public DbConnectionString As String
Private ConnectionCount As Integer
Public SKey As Variant

Private POSTILION_SERVER_IP As Variant
Private POSTILION_KSW_PORT As Variant
Private KSW_SERVER_IP As Variant
Private KSW_SERVER_PORT As Variant
Private PPT_PORT As Variant
Private PPT_IP As Variant
Private POSTILION_PPT_PORT As Variant

Private dbConnection As ADODB.Connection

Private Declare Function GetTickCount Lib "kernel32" () As Long

Private Const XKEY  As String = "24ABC1234DED1234"
Private Const AddIcon = &H0
Private Const ModifyIcon = &H1
Private Const DeleteIcon = &H2

Private Const WM_MOUSEMOVE = &H200
Private Const WM_LBUTTONDBLCLK = &H203
Private Const WM_LBUTTONDOWN = &H201
Private Const WM_LBUTTONUP = &H202

Private Const WM_RBUTTONDBLCLK = &H206
Private Const WM_RBUTTONDOWN = &H204
Private Const WM_RBUTTONUP = &H205

Private Const MessageFlag = &H1
Private Const IconFlag = &H2
Private Const TipFlag = &H4



Private Declare Function Shell_NotifyIcon _
  Lib "shell32" Alias "Shell_NotifyIconA" ( _
  ByVal Message As Long, Data As NotifyIconData) As Boolean

Private Data As NotifyIconData

' Type passed to Shell_NotifyIcon
Private Type NotifyIconData
  Size As Long
  HANDLE As Long
  ID As Long
  Flags As Long
  CallBackMessage As Long
  Icon As Long
  Tip As String * 64
End Type

Public meStateIcon As Boolean

Private Sub AddIconToTray()

  Data.Size = Len(Data)
  Data.HANDLE = hWnd
  Data.ID = vbNull
  Data.Flags = IconFlag Or TipFlag Or MessageFlag
  Data.CallBackMessage = WM_MOUSEMOVE
  Data.Icon = Icon
  Data.Tip = Trim("PayServ Money Bridge")
  Call Shell_NotifyIcon(AddIcon, Data)

End Sub

Private Sub DeleteIconFromTray()
    With Data
      .Size = Len(Data)
      .HANDLE = hWnd
      .ID = vbNull
      .Flags = IconFlag Or TipFlag Or MessageFlag
      .CallBackMessage = WM_MOUSEMOVE
      .Icon = Icon
    End With
  Shell_NotifyIcon DeleteIcon, Data
End Sub

Private Sub cmdEnd_Click()
      
    'remove icon from tray
    DeleteIconFromTray
       
End Sub


Private Sub Command2_Click()
Trace_Flag = 1
Command2.Caption = "Trace ON"
Command3.Caption = "Stop Trace"
Command2.BackColor = &HC0FFC0
Command3.BackColor = &H8080FF
Image3.Visible = True
Image4.Visible = False

'MainForm.Command1.Caption = "Stop Trace"
'MainForm.Command1.BackColor = "&H8080FF"

End Sub

Private Sub Command3_Click()
Trace_Flag = 0
Command2.Caption = "Start Trace"
Command3.Caption = "Trace OFF"
Command2.BackColor = &HE0E0E0
Command3.BackColor = &HE0E0E0
Image3.Visible = False
Image4.Visible = True
'MainForm.Command1.Caption = "Start Trace"
'MainForm.Command1.BackColor = "&HE0E0E0"

End Sub

Private Sub Command4_Click()
txt_log.Text = EventsTrap
End Sub

Private Sub Command5_Click()
txt_log.Text = ""
EventsTrap = ""
Command4.BackColor = &HE0E0E0
End Sub



Private Sub ConnectionTimer_Timer()
  Dim RecSet As New ADODB.Recordset
    On Error GoTo errHandler
    RecSet.Open "Select count(*) from em_merchants", dbConnection
    If RecSet.State = 1 Then
    
     Set dbConnection = New ADODB.Connection
     dbConnection.Open "Provider=SQLOLEDB;" & _
    "Data Source=" & EM_SERVER & ";" & _
    "Initial Catalog=" & DB & ";" & _
    "User ID=" & USER_ID & ";" & _
    "Password=" & PSW
    End If
    
    If sckClientPostilion.State <> sckConnected Then
    Image1.Visible = True
    Image2.Visible = False
    Label3.Visible = True
    Label4.Visible = False
            sckClientPostilion.Close
            'set remote server connection parameters
            sckClientPostilion.Connect POSTILION_IP, POSTILION_PORT
            
            PostilionSck.Close
            'set remote server connection parameters
            PostilionSck.Connect ZAP_IP, ZAP_PORT
            
    Else
    Image1.Visible = False
    Image2.Visible = True
    Label3.Visible = False
    Label4.Visible = True
    End If
    
    
    
    Exit Sub
errHandler:
EventsTrap = EventsTrap & vbNewLine & " Process ConnectionTimer: " & err.Description

    
End Sub

Private Sub CountryCode_Click()
If frmODBCLogon.LOGINSUCCESS = 1 Then
frmQuery.Show
Else
frmODBCLogon.FORMNAME = 3
frmODBCLogon.Show
End If
End Sub

Private Sub expiryTimer_Timer()
On Error GoTo Handler
Dim Q_string As String
Dim time_stamp As String
time_stamp = Year(Date) & "-" & Format(Month(Date), "00") & "-" & Format(Day(Date), "00") & " " & Format(Hour(Time), "00") & ":" & Format(Minute(Time), "00") & ":" & Format(Second(Time), "00")

Q_string = "Update em_mobile_auth_record " & _
"set state = 54,date_time_exp ='" & time_stamp & "' " & _
"where  DATEDIFF (minute ,date_time_req,'" & time_stamp & "'  )> 30 " & _
"and state in (0,1,2,3)"

dbConnection.Execute Q_string
Exit Sub
Handler:
 Exit Sub

End Sub

Private Sub Form_Resize()
On Error GoTo Errta

  Frame4.Width = Me.Width - 6300
  txt_log.Width = Me.Width - 6500
  Frame6.Width = Me.Width / 2 - 300
  Frame2.Left = Frame6.Left + Frame6.Width - 100
  Frame2.Width = Me.Width / 2 - 100
  Frame3.Width = Me.Width - 500
  Frame3.Height = 1700
  If Me.WindowState = 2 Then
  Frame3.Visible = True
  Else
  Frame3.Visible = False
  End If
  Dim K As Long
  K = StatusBar.Top
  Frame3.Height = Me.Height / 5 - 500
  List1.Height = Frame3.Height - 300
  List2.Height = Frame3.Height - 300
  List3.Height = Frame3.Height - 300
  
  List1.Width = Frame3.Width / 3 - 100
  List2.Width = Frame3.Width / 3 - 100
  List3.Width = Frame3.Width / 3 - 100
  
  List2.Left = List1.Left + List1.Width + 25
  List3.Left = List1.Left + List1.Width + 25 + List2.Width + 20
  
Errta:
End Sub

Private Sub Form_Unload(Cancel As Integer)
On Error GoTo ErrTrap
dbConnection.Execute "delete from dbo.em_merchant_pos_index"
dbConnection.Execute "delete from dbo.em_issuer_pos_index"
Exit Sub

ErrTrap:
     
End Sub

Private Sub FrateTmer_Timer()
Call FrateBroacast
End Sub

Private Sub help_Click()
frmAbout.Show vbModal
End Sub

Private Sub HsmSck_Close()
    HsmSck.Close
    HsmSck.Connect HSM_IP, HSM_PORT
End Sub

Private Sub HsmSck_Connect()
       
    If HsmSck.State = sckConnected Then
    End If
End Sub

Private Sub HsmSck_DataArrival(ByVal bytesTotal As Long)
    Dim strData As String
    Dim ServaData As String
    HsmSck.GetData strData
    ServaData = ServaData & strData
    'If bytesTotal = 8096 Then DoEvent
    Dim str As String
    Dim Strace As String
   ' ProcessHSMessage ServaData, Str, Strace
End Sub

Private Sub HsmSck_Error(ByVal Number As Integer, Description As String, ByVal Scode As Long, ByVal Source As String, ByVal HelpFile As String, ByVal HelpContext As Long, CancelDisplay As Boolean)

 HsmSck.Close
    strStatusBarText = Replace(strStatusBarText, "=online", "=offline", , , vbTextCompare)
    StatusBar.SimpleText = strStatusBarText
    HsmSck.Connect HSM_IP, HSM_PORT
End Sub

Private Sub Image3_Click()
 'do something
 
 
End Sub

Private Sub Interchanges_Click(Index As Integer)
If frmODBCLogon.LOGINSUCCESS = 1 Then
MchAddFrm.Show

Else
frmODBCLogon.FORMNAME = 1
frmODBCLogon.Show

End If

End Sub



Private Sub ISConnectionTimer_Timer()
On Error GoTo ErrTrap
  If HsmSck.State <> sckConnected Then
     HsmSck.Close
     HsmSck.Connect HSM_IP, HSM_PORT
     
     Image10.Visible = True
     Image9.Visible = False
     Label7.Visible = False
     Label8.Visible = True
           
    Else
     Image10.Visible = False
     Image9.Visible = True
     Label7.Visible = True
     Label8.Visible = False
          
  End If
  
    Dim i As Integer
    Dim J As Integer
    For i = 1 To 600
        J = MobileSocketArray(i)
      If J = 1 Then
          i = 600
            Image13.Visible = True
            Image12.Visible = False
            Label10.Visible = False
            Label11.Visible = True
           
      Else
             Image13.Visible = False
             Image12.Visible = True
             Label10.Visible = True
             Label11.Visible = False
        
     End If
    Next i
    
ErrTrap:
    
  End Sub
Private Sub FrateBroacast()
Dim RecSet As New ADODB.Recordset
Dim RecSetX As New ADODB.Recordset
Dim rstObj As New ADODB.Recordset
Dim CountryCode As String
Dim Frate As Double
Dim Trace As String
Dim StrMessage As String
On Error GoTo QuitE
Dim post As New PostBridgeISO8583
RecSet.Open "select * from em_frate_log", dbConnection
If RecSet.EOF = False Then
 
  If RecSet!Status = 1 Then

   
    RecSet.Close
     With post
         .ResetBitMaps
         .MessageTypeID = "0200"
         .Pan = ""
         .ProcessingCODE = "300000"
         .AcquiringInstIdCode = "254"
         .ForwardingInstIdCode = "254"
         .AmtTransaction = "000000000000"
         
         
         
         If .Pan <> "" Then .CreatePBBitMap (2): Trace = Trace & "Field 002: " & .Pan & vbNewLine
         If .ProcessingCODE <> "" Then .CreatePBBitMap (3): Trace = Trace & "Field 003: " & .ProcessingCODE & vbNewLine
         If .AmtTransaction <> "" Then: .CreatePBBitMap (4): Trace = Trace & "Field 004: " & .AmtTransaction & vbNewLine
         If .AmtSettlement <> "" Then: .CreatePBBitMap (5): Trace = Trace & "Field 005: " & .AmtSettlement & vbNewLine
         If .DatetimeTransmission <> "" Then .CreatePBBitMap (7): Trace = Trace & "Field 007: " & .DatetimeTransmission & vbNewLine
         If .ConvRateSettle <> "" Then .CreatePBBitMap (9): Trace = Trace & "Field 009: " & .ConvRateSettle & vbNewLine
         If .SysTraceAuditNum <> "" Then .CreatePBBitMap (11): Trace = Trace & "Field 011: " & .SysTraceAuditNum & vbNewLine
         If .TimeLocTxn <> "" Then .CreatePBBitMap (12): Trace = Trace & "Field 012: " & .DateLocTxn & vbNewLine
         If .DateLocTxn <> "" Then .CreatePBBitMap (13): Trace = Trace & "Field 013: " & .TimeLocTxn & vbNewLine
         If .DateExpiry <> "" Then .CreatePBBitMap (14): Trace = Trace & "Field 014: " & .DateExpiry & vbNewLine
         If .DateSettle <> "" Then .CreatePBBitMap (15): Trace = Trace & "Field 015: " & .DateSettle & vbNewLine
         If .DateConversion <> "" Then .CreatePBBitMap (16): Trace = Trace & "Field 016: " & .DateConversion & vbNewLine
         If .MerchantType <> "" Then .CreatePBBitMap (18): Trace = Trace & "Field 018: " & .MerchantType & vbNewLine
         If .POSEntryMode <> "" Then .CreatePBBitMap (22): Trace = Trace & "Field 022: " & .POSEntryMode & vbNewLine
         If .CardSeqNum <> "" Then .CreatePBBitMap (23): Trace = Trace & "Field 023: " & .CardSeqNum & vbNewLine
         If .POSConditionCode <> "" Then .CreatePBBitMap (25): Trace = Trace & "Field 025: " & .POSConditionCode & vbNewLine
         If .POSPinCaptureCode <> "" Then .CreatePBBitMap (26): Trace = Trace & "Field 026: " & .POSPinCaptureCode & vbNewLine
         If .AmtTxnFee <> "" Then .CreatePBBitMap (28): Trace = Trace & "Field 028: " & .AmtTxnFee & vbNewLine
         If .AmtTxnProcessingFee <> "" Then .CreatePBBitMap (30): Trace = Trace & "Field 030: " & .AmtTxnProcessingFee & vbNewLine
         If .AcquiringInstIdCode <> "" Then .CreatePBBitMap (32): Trace = Trace & "Field 032: " & .AcquiringInstIdCode & vbNewLine
         If .ForwardingInstIdCode <> "" Then .CreatePBBitMap (33): Trace = Trace & "Field 033: " & .ForwardingInstIdCode & vbNewLine
         If .Track2Data <> "" Then .CreatePBBitMap (35): Trace = Trace & "Field 035: " & .Track2Data & vbNewLine
         If .RetrievalRefNum <> "" Then .CreatePBBitMap (37): Trace = Trace & "Field 037: " & .RetrievalRefNum & vbNewLine
         If .AuthIdResp <> "" Then .CreatePBBitMap (38): Trace = Trace & "Field 038: " & .AuthIdResp & vbNewLine
         If .RespCode <> "" Then .CreatePBBitMap (39): Trace = Trace & "Field 039: " & .RespCode & vbNewLine
         If .ServiceRestrictionCode <> "" Then .CreatePBBitMap (40): Trace = Trace & "Field 040: " & .ServiceRestrictionCode & vbNewLine
         If .CardAcceptorTermId <> "" Then .CreatePBBitMap (41): Trace = Trace & "Field 041: " & .CardAcceptorTermId & vbNewLine
         If .CardAcceptorIdCode <> "" Then .CreatePBBitMap (42): Trace = Trace & "Field 042: " & .CardAcceptorIdCode & vbNewLine
         If .CardAcceptorNameLoc <> "" Then .CreatePBBitMap (43): Trace = Trace & "Field 043: " & .CardAcceptorNameLoc & vbNewLine
         If .AdditionalRespData <> "" Then .CreatePBBitMap (44):: Trace = Trace & "Field 044: " & .AdditionalRespData & vbNewLine
         If .AdditionalData <> "" Then .CreatePBBitMap (48): Trace = Trace & "Field 048: " & .AdditionalData & vbNewLine
         If .CurrencyCodeTxn <> "" Then .CreatePBBitMap (49): Trace = Trace & "Field 049: " & .CurrencyCodeTxn & vbNewLine
         If .CurrencyCodeSettle <> "" Then .CreatePBBitMap (50): Trace = Trace & "Field 050: " & .CurrencyCodeSettle & vbNewLine
          '.PinData = "0123456789ABCDEF": .CreatePBBitMap (52): Trace = Trace & "Field 052: " & "****************" & vbNewLine
         If .AdditionalAmts <> "" Then .CreatePBBitMap (54): Trace = Trace & "Field 054: " & .AdditionalAmts & vbNewLine
         If .MsgReasonCode <> "" Then .CreatePBBitMap (56): Trace = Trace & "Field 056: " & .MsgReasonCode & vbNewLine
        
        
               
                
    Dim OutLetIndex As Integer
    Dim OutLetMode As Integer
    Dim MessageSentIndicator As Integer
    
    RecSetX.Open "select * from em_currency", dbConnection
    
    Do While RecSetX.EOF = False
        CountryCode = RecSetX!country_code
        Frate = RecSetX!fx_rate
        .ReceivingInstIdCode = CountryCode: .CreatePBBitMap (100)
        
        
         rstObj.Open "select pindex, ip_address, port,mode,node_name from em_merchant_pos_index where bin_code = '" & CountryCode & "'", dbConnection
                    
                        If rstObj.EOF = False Then

                                 OutLetIndex = rstObj!Pindex
                                 OutLetMode = rstObj!Mode
                                                                 
                           RecSet.Open "select Country_Code,fx_rate from em_currency", dbConnection
                            Do While RecSet.EOF = False
                            'post rate
                            'Frate = RecSet!fx_rate
                            .ConvRateSettle = Format(RecSet!fx_rate / Frate * 1000, "00000000"): .CreatePBBitMap (9)
                            .AcquiringInstIdCode = RecSet!country_code
                            
                            If CountryCode <> RecSet!country_code Then
                                StrMessage = .CREATEMsgISO8538
                                 If OutLetIndex <> 0 And OutLetMode = 1 Then
                                   SendMessageToSwitch StrMessage, OutLetIndex, MessageSentIndicator
                                 ElseIf OutLetIndex <> 0 And OutLetMode = 0 Then
                                   SendMessageToMerchant StrMessage, GetIndexOut(OutLetIndex), MessageSentIndicator 'GetIndexOut(OutLetIndex)
                                 End If
                                 SlowDown (1000)
                            End If
                            RecSet.MoveNext
                             Loop
                           RecSet.Close

                        End If
                    rstObj.Close
        
        
        
    RecSetX.MoveNext
    Loop
    RecSetX.Close

   End With
   
  dbConnection.Execute "Update em_frate_log set status = 0"
 End If
 
 
 End If
 
QuitE:

End Sub

Private Sub MerchantSocket_Close(Index As Integer)

On Error GoTo ErrTrap
MerchantSocket(Index).Close
Unload MerchantSocket(Index)
DisConPointerArray(Index) = 0

Dim RecSet As New ADODB.Recordset

dbConnection.Execute ("update  em_merchant_pos_index set status = 0 WHERE pindex = " & Left(Index, 1) & " and mode = 0")

RecSet.Open "Select * from em_merchant_pos_index where pindex = " & Left(Index, 1) & " and mode= 0", dbConnection
If RecSet.EOF = False Then
    Load MerchantSocket(CInt(Left(Index, 1) & "1"))
    MerchantSocket(CInt(Left(Index, 1) & "1")).LocalPort = RecSet.Fields(1).Value
    MerchantSocket(CInt(Left(Index, 1) & "1")).Listen
    DisConPointerArray(CInt(Left(Index, 1) & "1")) = 2

    Call UpdateUptime(RecSet!Node_Name, 0)
End If

ErrTrap:

End Sub

Private Sub MerchantSocket_ConnectionRequest(Index As Integer, ByVal requestID As Long)

Dim i As Integer
Dim col As Integer
Dim IPr As String
Dim HostPort As Long
Dim Pindex As Integer
Dim RecSet As New ADODB.Recordset
On Error GoTo ErrTrap
IPr = MerchantSocket(Index).RemoteHostIP
HostPort = MerchantSocket(Index).LocalPort

RecSet.Open "Select * from em_merchant_pos_index where ip_address = '" & IPr & "' and port = " & HostPort & " and mode= 0", dbConnection
If RecSet.EOF = False Then
    Pindex = RecSet!Pindex
    i = GetIndex(Pindex)
    DisConPointerArray(i) = 1
    
    Load MerchantSocket(i)
    MerchantSocket(i).Accept requestID
    dbConnection.Execute ("update  em_merchant_pos_index set status = 1 WHERE pindex = " & Left(Index, 1) & " and mode = 0")
    Call UpdateUptime(RecSet!Node_Name, 1)
   
 End If
Exit Sub
ErrTrap:
EventsTrap = EventsTrap & vbNewLine & err.Description

End Sub

Private Sub MerchantSocket_DataArrival(Index As Integer, ByVal bytesTotal As Long)
Dim RecSet As New ADODB.Recordset
Dim MsgStr As String
Dim MessageFromMerchant As String
Dim Recv_port As Long
Dim Recv_ip As String
Dim Source_Key As String


Dim StrMessageTOProcess As String
Dim intStreamLen As Integer
Dim intMsgLength As Integer

    On Error GoTo ErrorTrap
    MerchantSocket(Index).GetData MsgStr
    
    Recv_port = MerchantSocket(Index).LocalPort
    Recv_ip = MerchantSocket(Index).RemoteHostIP
         RecSet.Open "Select node_Name from em_merchant_pos_index where ip_address = '" & Recv_ip & "' And Port =" & Recv_port & " and mode = 0", dbConnection
         If RecSet.EOF = False Then
            Source_Key = Index & "_" & RecSet!Node_Name & "_" & Recv_port & ":0"
            MessageFromMerchant = MsgStr
            
            
              Do While MessageFromMerchant <> ""
                     
                     intStreamLen = Len(MessageFromMerchant)
                     intMsgLength = GetMsgLen(Mid(MessageFromMerchant, 1, 4))           ' get message length
                     
                     StrMessageTOProcess = Mid(MessageFromMerchant, 1, intMsgLength)    ' get message from stream
                     If Mid(StrMessageTOProcess, 5, 4) = "0200" Then
                     ProcessMerchantMessage0200 StrMessageTOProcess, Source_Key, RecSet!Node_Name
                     ElseIf Mid(StrMessageTOProcess, 5, 4) = "0210" Then
                     ProcessMerchantMessage0210 StrMessageTOProcess, Source_Key, RecSet!Node_Name
                     ElseIf Mid(StrMessageTOProcess, 5, 4) = "0230" Then
                     ProcessMerchantMessage0230 StrMessageTOProcess, Source_Key, RecSet!Node_Name
                     ElseIf Mid(StrMessageTOProcess, 5, 4) = "0430" Then
                     ProcessMerchantMessage0430 StrMessageTOProcess, Source_Key, RecSet!Node_Name
                     ElseIf Mid(StrMessageTOProcess, 5, 4) = "0420" Then
                     ProcessMerchantMessage0420 StrMessageTOProcess, Source_Key, RecSet!Node_Name
                     End If
                     MessageFromMerchant = Mid(MessageFromMerchant, intMsgLength + 1, intStreamLen - intMsgLength)  ' return rest of the stream
                    
                     
              Loop
            
                       

        Else
        MerchantSocket(Index).SendData MsgStr
        End If
        MsgStr = ""
    Exit Sub
ErrorTrap:
    EventsTrap = EventsTrap & vbNewLine & err.Description
End Sub

Private Sub MerchantSocket_Error(Index As Integer, ByVal Number As Integer, Description As String, ByVal Scode As Long, ByVal Source As String, ByVal HelpFile As String, ByVal HelpContext As Long, CancelDisplay As Boolean)
On Error GoTo ErrTrap
MerchantSocket(Index).Close
Unload MerchantSocket(Index)
'Load MerchantSocket(Index)
DisConPointerArray(Index) = 0

Dim RecSet As New ADODB.Recordset

RecSet.Open "Select * from em_merchant_pos_index where pindex = " & Left(Index, 1) & " and mode= 0", dbConnection
If RecSet.EOF = False Then
    Call UpdateUptime(RecSet!Node_Name, 0)
End If

ErrTrap:

End Sub

Private Function GetMsgLen(ByVal bytes2header As String) As Integer
    
    Dim byte1 As String
    Dim byte2 As String
    Dim intMsgLen As Integer
    On Error GoTo ErrTrap
    GetMsgLen = 0
'    byte1 = Asc(Mid(bytes2header, 1, 1)) ' get first
'    byte2 = Asc(Mid(bytes2header, 2, 1)) ' get second
'    intMsgLen = byte1 * 256 + byte2      ' sum first and second with first multiplied by 256
'
'    GetMsgLen = intMsgLen + 2
     GetMsgLen = CInt(bytes2header) + 4
     Exit Function
ErrTrap:
     
End Function


''''''''''''''''''DATA COMING FROM MOBILE TO SWITCH'''''''''''''''''''''''''''''''''''''''''
'                   get message from MOBILE port                                          '
'process the message IN postbridge format and send to Switch or C-banking                    '
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
 Private Sub Mobile_message_processor(ByVal str_message As String)
    Dim newtransreq As String
    Dim extraMessage As String
    Dim strLen As Integer
    Dim message_type As String
    Dim Tran_type As String
    Dim Tran_ref As String
    Dim Msisdn As String
    Dim Msisdn2 As String
    Dim amount_transaction As String
    Dim account_id As String
    Dim DateTime As String
    Dim response As String
    Dim Error_Flag As Integer
    Dim message_unpacking_event As Variant
    Dim Ret_ref As String
   
    'length: 0000|SARQ|00|000000000023|0720677928||000000200000|035000017280|2012-03-26 07:08:12|
    
    Dim mlen As Integer
    strLen = Len(str_message)
    mlen = Val(Mid$(str_message, 1, 4))
    
    
    If mlen + 5 < strLen Then 'more data
      extraMessage = Mid$(str_message, mlen + 4, strLen - mlen + 4)
    End If
    
        newtransreq = Mid$(str_message, 5, mlen + 1)
      
        message_type = Mid$(newtransreq, 2, 4)
        If message_type <> "SARQ" Then
              message_unpacking_event = "Error occurred on unpacking message type. Received: " & message_type
              GoTo LabelError:
         End If
        newtransreq = Mid$(newtransreq, 6, mlen - 4)
        Tran_type = Mid$(newtransreq, 2, 2)
        
        If Tran_type <> "00" And Tran_type <> "42" Then
        
              message_unpacking_event = "Error occurred on unpacking tran type field. Received: " & Tran_type
              GoTo LabelError:
        End If
           
        newtransreq = Mid$(newtransreq, 4, mlen - 3)
        Tran_ref = Mid$(newtransreq, 2, 12)
        
        If Len(Tran_ref) <> 12 Or IsNumeric(Tran_ref) = False Then
              message_unpacking_event = "Error occurred on unpacking reference number field. Received: " & Tran_ref
              GoTo LabelError:
        End If
        
        newtransreq = Mid$(newtransreq, 14, mlen - 13)
        Msisdn = Mid$(newtransreq, 2, 10)
        If Len(Msisdn) <> 10 Or IsNumeric(Msisdn) = False Then
              message_unpacking_event = "Error occurred on unpacking msisdn id field. Received: " & Msisdn
              GoTo LabelError:
        End If
        newtransreq = Mid$(newtransreq, 12, mlen - 11)
        
        If Tran_type = 42 Then
            Msisdn2 = Mid$(newtransreq, 2, 10)
                If Len(Msisdn2) <> 10 Or IsNumeric(Msisdn2) = False Then
                message_unpacking_event = "Error occurred on unpacking msisdn2 id field. Received: " & Msisdn2
                GoTo LabelError:
                End If
            newtransreq = Mid$(newtransreq, 12, mlen - 11)
        Else
          Msisdn2 = "0000000000"
          newtransreq = Mid$(newtransreq, 2, mlen - 1)
        End If
        
        amount_transaction = Mid$(newtransreq, 2, 12)
        If Len(amount_transaction) <> 12 Or IsNumeric(amount_transaction) = False Then
              message_unpacking_event = "Error occurred on unpacking amount field. Received: " & amount_transaction
              GoTo LabelError:
        End If
        newtransreq = Mid$(newtransreq, 14, mlen - 14)
        
        account_id = Mid$(newtransreq, 2, InStr(2, newtransreq, "|", vbTextCompare) - 2)
        If IsNumeric(account_id) = False Then
              message_unpacking_event = "Error occurred on unpacking account id field. Received: " & account_id
              GoTo LabelError:
        End If
        newtransreq = Mid$(newtransreq, Len(account_id) + 2, mlen - Len(account_id) - 1)
        
        Dim Issuer As String
        Issuer = Mid$(newtransreq, 2, Len(newtransreq) - 1)
     
        DateTime = Year(Date) & "-" & Format(Month(Date), "00") & "-" & Format(Day(Date), "00") & _
               " " & Format(Hour(Time), "00") & ":" & Format(Minute(Time), "00") & ":" & Format(Second(Time), "00") & ".000"
    
     
        Call AddNewTransaction_Mobile_Req(message_type, Tran_type, Ret_ref, Msisdn, amount_transaction, account_id, DateTime, Issuer, Error_Flag, Msisdn2)
        If Error_Flag = 0 Then
             Call GetTransactionsDetails_From_MobileReq(Tran_type, Msisdn, Msisdn2, amount_transaction, account_id, Issuer, Format(Ret_ref, "000000000000"))
        Else
        message_unpacking_event = "Processing Error Occurred"
        GoTo LabelError
        End If
       Exit Sub
LabelError:
       
      Call SendMessageToMobileApp(message_unpacking_event, 0)
                
       
End Sub

''''''''''''''''''DATA COMING FROM SWITCH TO PAYSERV'''''''''''''''''''''''''''''''''''''''''
'                       get message from SWITCH port                                          '
'process the message IN postbridge format and send to 1). Merchants or 2). B-banking                    '
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
Private Sub Switch_Message_Processor(ByVal Message As String, Optional ByVal Decline As Integer, Optional ByRef Trace As String)

    Dim PostMsg As PostBridgeISO8583
    Dim strNewMessage As String
    Dim Source_Node As String
    Dim Index As Integer
'    Dim Recset As New ADODB.Recordset
    Trace = ""
    On Error GoTo ErrorTrap
    Set PostMsg = New PostBridgeISO8583
    
    
    With PostMsg
        .ISO8583MsgBD Message
        .ResetBitMaps
        
       
        Trace = "Message type: " & .MessageTypeID & vbNewLine
        
        If Decline = 91 Then .RespCode = "91": .MessageTypeID = "0210"
        
        If .Pan <> "" Then .CreatePBBitMap (2): Trace = Trace & "Field 002: " & .Pan & vbNewLine
        If .ProcessingCODE <> "" Then .CreatePBBitMap (3): Trace = Trace & "Field 003: " & .ProcessingCODE & vbNewLine
        If .AmtTransaction <> "" Then: .CreatePBBitMap (4): Trace = Trace & "Field 004: " & .AmtTransaction & vbNewLine
        If .DatetimeTransmission <> "" Then .CreatePBBitMap (7): Trace = Trace & "Field 007: " & .DatetimeTransmission & vbNewLine
        If .SysTraceAuditNum <> "" Then .CreatePBBitMap (11): Trace = Trace & "Field 011: " & .SysTraceAuditNum & vbNewLine
        If .TimeLocTxn <> "" Then .CreatePBBitMap (12): Trace = Trace & "Field 012: " & .DateLocTxn & vbNewLine
        If .DateLocTxn <> "" Then .CreatePBBitMap (13): Trace = Trace & "Field 013: " & .TimeLocTxn & vbNewLine
        If .DateExpiry <> "" Then .CreatePBBitMap (14): Trace = Trace & "Field 014: " & .DateExpiry & vbNewLine
        If .DateSettle <> "" Then .CreatePBBitMap (15): Trace = Trace & "Field 015: " & .DateSettle & vbNewLine
        If .MerchantType <> "" Then .CreatePBBitMap (18): Trace = Trace & "Field 018: " & .MerchantType & vbNewLine
        If .POSEntryMode <> "" Then .CreatePBBitMap (22): Trace = Trace & "Field 022: " & .POSEntryMode & vbNewLine
        If .CardSeqNum <> "" Then .CreatePBBitMap (23): Trace = Trace & "Field 023: " & .CardSeqNum & vbNewLine
        If .POSConditionCode <> "" Then .CreatePBBitMap (25): Trace = Trace & "Field 025: " & .POSConditionCode & vbNewLine
        If .POSPinCaptureCode <> "" Then .CreatePBBitMap (26): Trace = Trace & "Field 026: " & .POSPinCaptureCode & vbNewLine
        If .AmtTxnFee <> "" Then .CreatePBBitMap (28): Trace = Trace & "Field 028: " & .AmtTxnFee & vbNewLine
        If .AmtTxnProcessingFee <> "" Then .CreatePBBitMap (30): Trace = Trace & "Field 030: " & .AmtTxnProcessingFee & vbNewLine
        If .AcquiringInstIdCode <> "" Then .CreatePBBitMap (32): Trace = Trace & "Field 032: " & .AcquiringInstIdCode & vbNewLine
        If .ForwardingInstIdCode <> "" Then .CreatePBBitMap (33): Trace = Trace & "Field 033: " & .ForwardingInstIdCode & vbNewLine
        If .Track2Data <> "" Then .CreatePBBitMap (35): Trace = Trace & "Field 035: " & .Track2Data & vbNewLine
        If .RetrievalRefNum <> "" Then .CreatePBBitMap (37): Trace = Trace & "Field 037: " & .RetrievalRefNum & vbNewLine
        If .AuthIdResp <> "" Then .CreatePBBitMap (38): Trace = Trace & "Field 038: " & .AuthIdResp & vbNewLine
        If .RespCode <> "" Then .CreatePBBitMap (39): Trace = Trace & "Field 039: " & .RespCode & vbNewLine
        If .ServiceRestrictionCode <> "" Then .CreatePBBitMap (40): Trace = Trace & "Field 040: " & .ServiceRestrictionCode & vbNewLine
        If .CardAcceptorTermId <> "" Then .CreatePBBitMap (41): Trace = Trace & "Field 041: " & .CardAcceptorTermId & vbNewLine
        If .CardAcceptorIdCode <> "" Then .CreatePBBitMap (42): Trace = Trace & "Field 042: " & .CardAcceptorIdCode & vbNewLine
        If .CardAcceptorNameLoc <> "" Then .CreatePBBitMap (43): Trace = Trace & "Field 043: " & .CardAcceptorNameLoc & vbNewLine
        If .AdditionalRespData <> "" Then .CreatePBBitMap (44):: Trace = Trace & "Field 044: " & .AdditionalRespData & vbNewLine
        If .AdditionalData <> "" Then .CreatePBBitMap (48): Trace = Trace & "Field 048: " & .AdditionalData & vbNewLine
        If .CurrencyCodeTxn <> "" Then .CreatePBBitMap (49): Trace = Trace & "Field 049: " & .CurrencyCodeTxn & vbNewLine
        If .PinData <> "" Then .CreatePBBitMap (52): Trace = Trace & "Field 052: " & "****************" & vbNewLine
        If .AdditionalAmts <> "" Then .CreatePBBitMap (54): Trace = Trace & "Field 054: " & .AdditionalAmts & vbNewLine
        If .MsgReasonCode <> "" Then .CreatePBBitMap (56): Trace = Trace & "Field 056: " & .MsgReasonCode & vbNewLine
        If .EchoData <> "" Then .CreatePBBitMap (59): Trace = Trace & "Field 059: " & .EchoData & vbNewLine
        If .NetMangtInfoCode <> "" Then .CreatePBBitMap (70): Trace = Trace & "Field 070: " & .NetMangtInfoCode & vbNewLine
        If .OriginalDataElements <> "" Then .CreatePBBitMap (90): Trace = Trace & "Field 090: " & .OriginalDataElements & vbNewLine
        If .ReplacementAmts <> "" Then .CreatePBBitMap (95): Trace = Trace & "Field 095: " & .ReplacementAmts & vbNewLine
        If .ReceivingInstIdCode <> "" Then .CreatePBBitMap (100): Trace = Trace & "Field 100: " & .ReceivingInstIdCode & vbNewLine
        If .AccIdOne <> "" Then .CreatePBBitMap (102): Trace = Trace & "Field 102: " & .AccIdOne & vbNewLine
        If .AccIdTwo <> "" Then .CreatePBBitMap (103): Trace = Trace & "Field 103: " & .AccIdTwo & vbNewLine
        If .POSDataCode <> "" Then .CreatePBBitMap (123): Trace = Trace & "Field 123: " & .POSDataCode & vbNewLine
        
                 
           Call UpdateRespTransaaction(.MessageTypeID, .ProcessingCODE, .SysTraceAuditNum, .ForwardingInstIdCode, .RetrievalRefNum, .RespCode, .EchoData, Index, Source_Node)
               If Source_Node <> "" Then
                Index = Val(Mid(Source_Node, 1, Len(Source_Node) - InStr(1, Source_Node, "_")))
                  'SendMessageToMerchant strNewMessage, Index
               End If
               If Trace_Flag = 1 Then
               txt_log.Text = txt_log.Text & "Message From Issuer: " & vbNewLine & Trace
               MainForm.TXTMonitor.Text = MainForm.TXTMonitor.Text & "Message From Issuer: " & vbNewLine & Trace
                        
               End If
               Dim RSP_Code As String
               Dim PIN_Val As String
               If Left(.ProcessingCODE, 2) = "52" And .RespCode = "91" Then
                                    Call AddNewTransaction_MerchantEval_Reg(.ForwardingInstIdCode, .AccIdTwo, _
                                    .DatetimeTransmission, .SysTraceAuditNum, .AdditionalData, Val(.AmtTransaction) / 100, .CardAcceptorNameLoc, .RetrievalRefNum, _
                                    Left(.ProcessingCODE, 2), .CardAcceptorIdCode, RSP_Code, PIN_Val, .CardAcceptorNameLoc)
                                    
                                If RSP_Code = "" Then
                                    .MessageTypeID = "0210"
                                    .CreatePBBitMap (39): .RespCode = "00"
                                    .CreatePBBitMap (44): .AdditionalRespData = GetID(PIN_Val)
                                     strNewMessage = .CREATEMsgISO8538
                                    ' Call SendMessageToMerchant(strNewMessage, Index)
                                     
                               End If
                        End If
               
                                         
               If Decline <> 91 Then
                  Dim i As Integer
                  i = 1
                  Do While (MaxTransLiveTime(i) <> CLng(.EchoData) And i < 200)
                  
                  i = i + 1
                  Loop
                  Unload TransLiveTimer(i)
               End If
        End With
    
        Set PostMsg = Nothing
         
        
    Exit Sub
ErrorTrap:
     Set PostMsg = Nothing
         EventsTrap = EventsTrap & vbNewLine & "Process Switch_Message_Processor " & err.Description
  
      
End Sub

Private Sub Form_MouseMove(Button As Integer, Shift As Integer, X As Single, Y As Single)
  Dim Message As Long
  Message = X / Screen.TwipsPerPixelX
  
  Select Case Message
    Case WM_LBUTTONDBLCLK
      Visible = Not Visible
      WindowState = Abs(Not Visible)
  End Select
End Sub

Private Sub Form_QueryUnload(Cancel As Integer, UnloadMode As Integer)
    Select Case UnloadMode
    Case 0:
        'return to application without quiting
        Cancel = 1
        'make menu visible
        Me.Hide
    Case Else 'for future use
       
    End Select
End Sub



Private Sub PostilionSck_Close()
    PostilionSck.Close
    strStatusBarText = Replace(strStatusBarText, "=online", "=offline", , , vbTextCompare)
    StatusBar.SimpleText = strStatusBarText
       
      ' close socket forcefully
    
    PostilionSck.Connect ZAP_IP, ZAP_PORT
    
End Sub

Private Sub PostilionSck_Connect()
    If PostilionSck.State = sckConnected Then
        strStatusBarText = Replace(strStatusBarText, "=offline", "=online", , , vbTextCompare)
        StatusBar.SimpleText = strStatusBarText
        'PostTxt.Text = "Switch Connected"
    End If
End Sub


''''''''DATA COMING FROM MERCHANT TO PAYSERV BRIDGE TO SWITCH''''''''''''''''''''''''''
'       message is receieved at postbridge port                             '
'         The mesage is process into ZAP format and send                    '

     '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
Private Sub ProcessMerchantMessage0200(ByVal StrPostMessage As String, ByVal Source_Key As String, ByVal Interchange As String)
    Dim StrMessage As String
    On Error GoTo ErrorTrap
    Dim Trace As String
   
    Dim AmntSrcCurr As String
    Dim AmntDstCurr As String
    Dim ExchangeRate As String
    Dim AmtBaseCurrency As String
    Dim AmtBaseFeeCurrency As String
    Dim SrcCountry As String
    Dim DstCountry As String
      
    Dim SrcCurrencyCode As String
    Dim DstCurrencyCode As String
    
    Dim surcharge As String
    
    Dim Card_Accept_ID As String
    Dim RstCommand As ADODB.Command
    Dim RecSet As New ADODB.Recordset
    
    Dim PostMsg As New PostBridgeISO8583
    Dim DState As Integer
    Dim RSP_Code As Variant
    Dim PIN_Val As Variant
    Dim Rsp As Variant
    Dim Status As Long
    Dim MsgSentIndicator As Integer
    
    
    Dim DstCountryCode As String
    Dim RecsetE As New ADODB.Recordset
    Dim RecsetC As New ADODB.Recordset
    Dim AgentAccount As String
    Dim AgentCommissionAccount As String
    Dim AgentID As String
    Dim ExciseTax As String
    Dim WithHoldingTax As String
    Dim inComingFee As String
    Dim outGoingFee As String
    Dim CommissionDueFBL As String
    Dim CustomerPhone As String
    Dim AmountAtransaction As Double
    
    Dim DoesCountryExit As Boolean
    DoesCountryExit = False
    
    
    Dim RecInstID As String
    Dim rstObj As ADODB.Recordset
    Dim strSQL As String
    Set rstObj = New ADODB.Recordset
    Dim OutLetIndex As Integer
    Dim OutLetMode As Integer
    Dim DstNodeName As Variant
    Dim ProcEvents As String
    Dim StrMsgToSend As String
    Dim MessageSentIndicator As Integer
    Dim Debit As Integer
    Dim IndexKey As Integer
    Dim SessionID As String
    Dim TranRefnumber As String
      
      
    MsgSentIndicator = 0
    AmtBaseCurrency = "000000000000"
       IndexKey = Left(Source_Key, InStr(1, Source_Key, "_", vbTextCompare) - 1)
    With PostMsg
        .ISO8583MsgBD StrPostMessage
        .ResetBitMaps
        
        Trace = "Message type: " & .MessageTypeID & vbNewLine
        
        
        If Left(.ProcessingCODE, 2) = "21" Or Left(.ProcessingCODE, 2) = "31" Or Left(.ProcessingCODE, 2) = "42" Then    'Debit
                 Debit = 0
        ElseIf Left(.ProcessingCODE, 2) = "00" Or Left(.ProcessingCODE, 2) = "01" Then
                 Debit = 0
        ElseIf Left(.ProcessingCODE, 2) = "32" Then
                Debit = 1
        End If
        
'        .SessionID = "7865657"
'        .TranRefnumber = "86565857868"
        
        If .MessageTypeID = "0200" Or .MessageTypeID = "0420" Or .MessageTypeID = "0421" Then
          .CardAcceptorTermId = Right(.Pan, 8)
           AmntSrcCurr = .AmtTransaction
           SrcCurrencyCode = .CurrencyCodeTxn
           DstCountryCode = .ReceivingInstIdCode
           SrcCountry = .AcquiringInstIdCode
           
           
           inComingFee = Right(.AmtTxnFee, 8)
           
           'Does Countries Exists
           'DstCountryCode (customer country)
           'SrcCountry (Second party country or agent country)
           
           SrcCurrencyCode = SrcCountry
        
                 If DstCountryCode <> "" And SrcCountry <> "" Then
                  
                    If Left(.ProcessingCODE, 2) = 31 Then 'New change for forex
                    
                     Call CURRENCYPICK(SrcCountry, SrcCurrencyCode, AmntSrcCurr, DstCountryCode, ExchangeRate, DstCurrencyCode, AmntDstCurr, AmtBaseCurrency, DoesCountryExit)
                 
                            .CurrencyCodeSettle = .CurrencyCodeTxn: .CreatePBBitMap (50)
                            .CurrencyCodeTxn = DstCurrencyCode: .CreatePBBitMap (49)
                            .ConvRateSettle = Format(Val(ExchangeRate) * 100, "00000000"): .CreatePBBitMap (9)
                            .DateSettle = .DateLocTxn: .CreatePBBitMap (15)
                            .DateConversion = .DateLocTxn: .CreatePBBitMap (16)
                            
                            .CardAcceptorNameLoc = Left(.CardAcceptorNameLoc, 38) & Left(.CardAcceptorNameLoc, 2)
                            
'                              Call CURRENCYPICK(.AcquiringInstIdCode, SrcCurrencyCode, inComingFee, DstCountryCode, ExchangeRate, DstCurrencyCode, outGoingFee, AmtBaseFeeCurrency, DoesCountryExit)
'
'                             .AmtTxnFee = "D" & Right(outGoingFee, 8)
                    Else
                           
                           strSQL = "select amount_req, amount_base,conversion_rate from em_agent_trans_1_a where acq_inst_id = '" & .AcquiringInstIdCode & "' and second_ref_nr = '" & SessionID & "' and rec_inst_id = '" & .ReceivingInstIdCode & "'"
                           rstObj.Open strSQL, dbConnection
                            
                            If rstObj.EOF = False Then
                                 AmntSrcCurr = rstObj!amount_req
                                 AmtBaseCurrency = rstObj!amount_base
                                .ConvRateSettle = rstObj!conversion_rate
                                 AmntDstCurr = .AmtTransaction
                                 rstObj.Close
                            Else
                                Call AddAGENTTransaction(99, .Pan, .DateExpiry, .MessageTypeID, .ProcessingCODE, .AmtTransaction, _
                                            .DatetimeTransmission, .SysTraceAuditNum, .TimeLocTxn, .DateLocTxn, .AcquiringInstIdCode, .RetrievalRefNum, _
                                            .CardAcceptorTermId, .CardAcceptorIdCode, .CardAcceptorNameLoc, .CurrencyCodeTxn, .EchoData, .AccIdOne, .AccIdTwo, .ReceivingInstIdCode, AgentID, "", .ConvRateSettle, Right(.AmtTxnFee, 8), "", .RetrievalRefNum, IndexKey, AmtBaseCurrency, Status)
                                                        
                                                     
                               DoesCountryExit = False
                               rstObj.Close
                               GoTo routeError
                               
                            End If
                            
                    End If
                     
                     SessionID = .SessionID
                     TranRefnumber = .TranRefnumber 'new changes
                                        
                     Call AddAGENTTransaction(1, .Pan, .DateExpiry, .MessageTypeID, .ProcessingCODE, AmntSrcCurr, _
                                              .DatetimeTransmission, .SysTraceAuditNum, .TimeLocTxn, .DateLocTxn, .AcquiringInstIdCode, TranRefnumber, _
                                              .CardAcceptorTermId, .CardAcceptorIdCode, .CardAcceptorNameLoc, SrcCurrencyCode, .EchoData, .AccIdOne, .AccIdTwo, .ReceivingInstIdCode, AgentID, AmntDstCurr, .ConvRateSettle, inComingFee, outGoingFee, SessionID, IndexKey, AmtBaseCurrency, Status)
                                                        
                        
                     If Debit = 1 Then  'currency request (32)
                        .AmtTransaction = AmntSrcCurr: .CreatePBBitMap (4)
                        .AmtSettlement = AmntDstCurr: .CreatePBBitMap (5)
                        
                     ElseIf Debit = 0 Then  'debit (00,01,42)
                       .AmtTransaction = AmntDstCurr: .CreatePBBitMap (4)
                       .AmtSettlement = AmntSrcCurr: .CreatePBBitMap (5)
                     End If
                        
                            If .PinData <> "" Then 'Determine if PIN translation is needed
                                If DstCountryCode <> "" And SrcCountry <> "" And .Pan <> "" Then
                                
                                End If
                            End If
                
                   Else
                
                     Call AddAGENTTransaction(99, .Pan, .DateExpiry, .MessageTypeID, .ProcessingCODE, .AmtTransaction, _
                                              .DatetimeTransmission, .SysTraceAuditNum, .TimeLocTxn, .DateLocTxn, .AcquiringInstIdCode, .RetrievalRefNum, _
                                              .CardAcceptorTermId, .CardAcceptorIdCode, .CardAcceptorNameLoc, .CurrencyCodeTxn, .EchoData, .AccIdOne, .AccIdTwo, .ReceivingInstIdCode, AgentID, "", .ConvRateSettle, Right(.AmtTxnFee, 8), "", .RetrievalRefNum, IndexKey, AmtBaseCurrency, Status)
                                                        
                                                     
                     DoesCountryExit = False
                
                 End If
                 
        End If
        
        If Status < 1 Then
           .MessageTypeID = "0210"
           .RespCode = "96"
           .AmtTransaction = AmntSrcCurr
        End If
routeError:
        If DoesCountryExit = False Then 'return message
           .MessageTypeID = "0210"
           .RespCode = "92"
           .AmtTransaction = AmntSrcCurr
        End If
        
        
        
        
         If .Pan <> "" Then .CreatePBBitMap (2): Trace = Trace & "Field 002: " & .Pan & vbNewLine
         If .ProcessingCODE <> "" Then .CreatePBBitMap (3): Trace = Trace & "Field 003: " & .ProcessingCODE & vbNewLine
         If .AmtTransaction <> "" Then: .CreatePBBitMap (4): Trace = Trace & "Field 004: " & .AmtTransaction & vbNewLine
         If .AmtSettlement <> "" Then: .CreatePBBitMap (5): Trace = Trace & "Field 005: " & .AmtSettlement & vbNewLine
         If .DatetimeTransmission <> "" Then .CreatePBBitMap (7): Trace = Trace & "Field 007: " & .DatetimeTransmission & vbNewLine
         If .ConvRateSettle <> "" Then .CreatePBBitMap (9): Trace = Trace & "Field 009: " & .ConvRateSettle & vbNewLine
         If .SysTraceAuditNum <> "" Then .CreatePBBitMap (11): Trace = Trace & "Field 011: " & .SysTraceAuditNum & vbNewLine
         If .TimeLocTxn <> "" Then .CreatePBBitMap (12): Trace = Trace & "Field 012: " & .DateLocTxn & vbNewLine
         If .DateLocTxn <> "" Then .CreatePBBitMap (13): Trace = Trace & "Field 013: " & .TimeLocTxn & vbNewLine
         If .DateExpiry <> "" Then .CreatePBBitMap (14): Trace = Trace & "Field 014: " & .DateExpiry & vbNewLine
         If .DateSettle <> "" Then .CreatePBBitMap (15): Trace = Trace & "Field 015: " & .DateSettle & vbNewLine
         If .DateConversion <> "" Then .CreatePBBitMap (16): Trace = Trace & "Field 016: " & .DateConversion & vbNewLine
         If .MerchantType <> "" Then .CreatePBBitMap (18): Trace = Trace & "Field 018: " & .MerchantType & vbNewLine
         If .POSEntryMode <> "" Then .CreatePBBitMap (22): Trace = Trace & "Field 022: " & .POSEntryMode & vbNewLine
         If .CardSeqNum <> "" Then .CreatePBBitMap (23): Trace = Trace & "Field 023: " & .CardSeqNum & vbNewLine
         If .POSConditionCode <> "" Then .CreatePBBitMap (25): Trace = Trace & "Field 025: " & .POSConditionCode & vbNewLine
         If .POSPinCaptureCode <> "" Then .CreatePBBitMap (26): Trace = Trace & "Field 026: " & .POSPinCaptureCode & vbNewLine
         If .AmtTxnFee <> "" Then .CreatePBBitMap (28): Trace = Trace & "Field 028: " & .AmtTxnFee & vbNewLine
         If .AmtTxnProcessingFee <> "" Then .CreatePBBitMap (30): Trace = Trace & "Field 030: " & .AmtTxnProcessingFee & vbNewLine
         If .AcquiringInstIdCode <> "" Then .CreatePBBitMap (32): Trace = Trace & "Field 032: " & .AcquiringInstIdCode & vbNewLine
         If .ForwardingInstIdCode <> "" Then .CreatePBBitMap (33): Trace = Trace & "Field 033: " & .ForwardingInstIdCode & vbNewLine
         If .Track2Data <> "" Then .CreatePBBitMap (35): Trace = Trace & "Field 035: " & .Track2Data & vbNewLine
         If .RetrievalRefNum <> "" Then .CreatePBBitMap (37): Trace = Trace & "Field 037: " & .RetrievalRefNum & vbNewLine
         If .AuthIdResp <> "" Then .CreatePBBitMap (38): Trace = Trace & "Field 038: " & .AuthIdResp & vbNewLine
         If .RespCode <> "" Then .CreatePBBitMap (39): Trace = Trace & "Field 039: " & .RespCode & vbNewLine
         If .ServiceRestrictionCode <> "" Then .CreatePBBitMap (40): Trace = Trace & "Field 040: " & .ServiceRestrictionCode & vbNewLine
         If .CardAcceptorTermId <> "" Then .CreatePBBitMap (41): Trace = Trace & "Field 041: " & .CardAcceptorTermId & vbNewLine
         If .CardAcceptorIdCode <> "" Then .CreatePBBitMap (42): Trace = Trace & "Field 042: " & .CardAcceptorIdCode & vbNewLine
         If .CardAcceptorNameLoc <> "" Then .CreatePBBitMap (43): Trace = Trace & "Field 043: " & .CardAcceptorNameLoc & vbNewLine
         If .AdditionalRespData <> "" Then .CreatePBBitMap (44):: Trace = Trace & "Field 044: " & .AdditionalRespData & vbNewLine
         If .AdditionalData <> "" Then .CreatePBBitMap (48): Trace = Trace & "Field 048: " & .AdditionalData & vbNewLine
         If .CurrencyCodeTxn <> "" Then .CreatePBBitMap (49): Trace = Trace & "Field 049: " & .CurrencyCodeTxn & vbNewLine
         If .CurrencyCodeSettle <> "" Then .CreatePBBitMap (50): Trace = Trace & "Field 050: " & .CurrencyCodeSettle & vbNewLine
          '.PinData = "0123456789ABCDEF": .CreatePBBitMap (52): Trace = Trace & "Field 052: " & "****************" & vbNewLine
         If .AdditionalAmts <> "" Then .CreatePBBitMap (54): Trace = Trace & "Field 054: " & .AdditionalAmts & vbNewLine
         If .MsgReasonCode <> "" Then .CreatePBBitMap (56): Trace = Trace & "Field 056: " & .MsgReasonCode & vbNewLine
         
         .EchoData = Format(Status, "0000000000"): .CreatePBBitMap (59): Trace = Trace & "Field 059: " & .EchoData & vbNewLine
         If .SessionID <> "" Then .CreatePBBitMap (61):  Trace = Trace & "Field 061: " & .SessionID & vbNewLine
         If .TranRefnumber <> "" Then .CreatePBBitMap (62):  Trace = Trace & "Field 062: " & .TranRefnumber & vbNewLine
         If .NetMangtInfoCode <> "" Then .CreatePBBitMap (70): Trace = Trace & "Field 070: " & .NetMangtInfoCode & vbNewLine
         If .OriginalDataElements <> "" Then .CreatePBBitMap (90): Trace = Trace & "Field 090: " & .OriginalDataElements & vbNewLine
         If .ReplacementAmts <> "" Then .CreatePBBitMap (95): Trace = Trace & "Field 095: " & .ReplacementAmts & vbNewLine
         If .Payee <> "" Then .CreatePBBitMap (98): Trace = Trace & "Field 098: " & .Payee & vbNewLine
         If .ReceivingInstIdCode <> "" Then .CreatePBBitMap (100): Trace = Trace & "Field 100: " & .ReceivingInstIdCode & vbNewLine
         If .AccIdOne <> "" Then .CreatePBBitMap (102): Trace = Trace & "Field 102: " & .AccIdOne & vbNewLine
         If .AccIdTwo <> "" Then .CreatePBBitMap (103): Trace = Trace & "Field 103: " & .AccIdTwo
         
                
                
         

         StrMessage = .CREATEMsgISO8538
         
         If List1.ListCount < 20 Then
         List1.AddItem "INCOMING REQ: CUST 1" & .AccIdOne & " CUST 2:" & .AccIdTwo & " TRAN: " & Left(.ProcessingCODE, 2) & " AMT: " & Val(.AmtTransaction) / 100 & " CURNCY: " & .CurrencyCodeTxn, 0
         
         Else
         
         If Trace_Flag = 1 Then
         List1.RemoveItem (19)
         List1.AddItem "INCOMING REQ: CUST 1:" & .AccIdOne & " CUST 2:" & .AccIdTwo & " TRAN: " & Left(.ProcessingCODE, 2) & " AMT: " & Val(.AmtTransaction) / 100 & " CURNCY: " & .CurrencyCodeTxn, 0
         
         End If
                  FrmTrace.Text1 = FrmTrace.Text1 & vbNewLine & "Message from WebService Source" & vbNewLine & StrMsgToSend
                  FrmTrace.Text1 = FrmTrace.Text1 & vbNewLine & Trace
         End If
         
        If .MessageTypeID = "0800" Then 'return message
          .MessageTypeID = "0810"
          .RespCode = "00": .CreatePBBitMap (39)
           StrMessage = .CREATEMsgISO8538
           SendMessageToMobileApp StrMessage, IndexKey
           Exit Sub
        End If
                        
        If Left(.ProcessingCODE, 2) = "32" Then 'return message
          .MessageTypeID = "0210"
          .RespCode = "00": .CreatePBBitMap (39)
           StrMessage = .CREATEMsgISO8538
           SendMessageToMobileApp StrMessage, IndexKey
           Exit Sub
        End If
        
        
        If Trace_Flag = 1 Then
                  FrmTrace.Text1 = FrmTrace.Text1 & vbNewLine & "Message From Mobile" & vbNewLine & StrMsgToSend
                  FrmTrace.Text1 = FrmTrace.Text1 & vbNewLine & Trace
                  End If
        
                        
        If DoesCountryExit = False Then 'return message
           strSQL = "select pindex, ip_address, port,mode,node_name from em_merchant_pos_index where bin_code = '" & .AcquiringInstIdCode & "'"
'                    rstObj.Open strSQL, dbConnection
'


'credit score service

    Dim AgeRate As Double
    Dim BankLocateRate As Double
    Dim BankActivityRate As Double
    Dim CreditHistRate As Double
    Dim DependantsRate As Double
    Dim EducationLevelRate As Double
    Dim EmpRate As Double
    Dim LoanFrmOtherBankRate As Double
    Dim LoanTenuretoPensionPeriodRate As Double
    Dim LoanTenureRate As Double
    Dim LocaleRate As Double
    Dim MaritalRate As Double
    Dim NetIncomeRate As Double
    Dim SexRate As Double
    Dim WorkingPeriodCurrentRate As Double
    Dim WorkingPeriodFormerRate As Double
    
    Dim XrecSet As New ADODB.Recordset
    Dim YrecSet As New ADODB.Recordset
    Dim Xcon As ADODB.Connection
    
    
    Set Xcon = New ADODB.Connection
    
    Xcon.Open "Provider=SQLOLEDB;" & _
    "Data Source=" & EM_SERVER & ";" & _
    "Initial Catalog=waptx;" & _
    "User ID=" & USER_ID & ";" & _
    "Password=" & PSW
    
    
    strSQL = "select *  from customer_info where card_number = '" & .Pan & "'"
    XrecSet.Open strSQL, Xcon
     If XrecSet.EOF = True Then
     
                            .RespCode = "92": .CreatePBBitMap (39)
                            .MessageTypeID = "0210"
                            StrMessage = .CREATEMsgISO8538
                            SendMessageToMobileApp StrMessage, IndexKey
                            dbConnection.Execute "update em_agent_trans_1_a set state = 99, resp_code = '92' where tran_nr = '" & Status & "'"
           
    Exit Sub
    Else
    
    strSQL = "select rate from age_rates where  lower_limit <=  " & XrecSet!Age & " And upper_limit >= " & XrecSet!Age
    YrecSet.Open strSQL, Xcon
    If YrecSet.EOF = False Then
    AgeRate = YrecSet!Rate
    Else
    AgeRate = 0
    End If
    YrecSet.Close
    
    strSQL = "select rates from bank_locale_rates where  locatin =  '" & XrecSet!bank_locale & "'"
    YrecSet.Open strSQL, Xcon
    If YrecSet.EOF = False Then
    BankLocateRate = YrecSet!Rates
    Else
    BankLocateRate = 0
    End If
    YrecSet.Close
    
    strSQL = "select rates from banking_activity_rates where  level =  " & XrecSet!banking_level
    YrecSet.Open strSQL, Xcon
    If YrecSet.EOF = False Then
    BankActivityRate = YrecSet!Rates
    Else
    BankActivityRate = 0
    End If
    YrecSet.Close
    
    
    
    strSQL = "select rates from credit_hist_rates where  days_default_level =  " & XrecSet!days_default_level
    YrecSet.Open strSQL, Xcon
    If YrecSet.EOF = False Then
    CreditHistRate = YrecSet!Rates
    Else
    CreditHistRate = 0
    End If
    YrecSet.Close
    
    strSQL = "select rates from dependents_rates where  nr_of_dependents =  " & XrecSet!nr_dependants
    YrecSet.Open strSQL, Xcon
    If YrecSet.EOF = False Then
    DependantsRate = YrecSet!Rates
    Else
    DependantsRate = 0
    End If
    YrecSet.Close
    
    
    strSQL = "select credit_rate from edu_rates where  edu_level =  " & XrecSet!education_level
    YrecSet.Open strSQL, Xcon
    If YrecSet.EOF = False Then
    EducationLevelRate = YrecSet!credit_rate
    Else
    EducationLevelRate = 0
    End If
    YrecSet.Close
    
    strSQL = "select credit_rate from emp_rates where  emp_status =  " & XrecSet!emp_status
    YrecSet.Open strSQL, Xcon
    If YrecSet.EOF = False Then
    EmpRate = YrecSet!credit_rate
    Else
    EmpRate = 0
    End If
    YrecSet.Close
    
    strSQL = "select rates from loan_from_other_bank_rates where  has_loan =  '" & XrecSet!has_loan & "'"
    YrecSet.Open strSQL, Xcon
    If YrecSet.EOF = False Then
    LoanFrmOtherBankRate = YrecSet!Rates
    Else
    LoanFrmOtherBankRate = 0
    End If
    YrecSet.Close
    
    
    strSQL = "select rates from loan_period_to_pension_rates where  level =  " & IIf((CInt(55 - XrecSet!Age / XrecSet!loan_period) >= 1), 1, 0)
    YrecSet.Open strSQL, Xcon
    If YrecSet.EOF = False Then
    LoanTenuretoPensionPeriodRate = YrecSet!Rates
    Else
    LoanTenuretoPensionPeriodRate = 0
    End If
    YrecSet.Close
    
    strSQL = "select rates from loan_tenure_rates where  nr_of_years =  " & XrecSet!loan_period
    YrecSet.Open strSQL, Xcon
    If YrecSet.EOF = False Then
    LoanTenureRate = YrecSet!Rates
    Else
    LoanTenureRate = 0
    End If
    YrecSet.Close
    
     strSQL = "select rates from locale_rates where  location =  " & XrecSet!locale_rate
    YrecSet.Open strSQL, Xcon
    If YrecSet.EOF = False Then
    LocaleRate = YrecSet!Rates
    Else
    LocaleRate = 0
    End If
    YrecSet.Close
        
    strSQL = "select rates from marital_rates where  status =  '" & XrecSet!marital_status & "'"
    YrecSet.Open strSQL, Xcon
    If YrecSet.EOF = False Then
    MaritalRate = YrecSet!Rates
    Else
    MaritalRate = 0
    End If
    YrecSet.Close
    
    strSQL = "select rates from netincome_rates where   lower_lim <=  " & XrecSet!income_level & " And upper_lim >= " & XrecSet!income_level
    YrecSet.Open strSQL, Xcon
    If YrecSet.EOF = False Then
    NetIncomeRate = YrecSet!Rates
    Else
    NetIncomeRate = 0
    End If
    YrecSet.Close
    
    
    strSQL = "select rates from sex_rates where   sex =  '" & XrecSet!sex & "'"
    YrecSet.Open strSQL, Xcon
    If YrecSet.EOF = False Then
    SexRate = YrecSet!Rates
    Else
    SexRate = 0
    End If
    YrecSet.Close
    
    strSQL = "select rates from working_period_cur_emp_rates where  nr_of_years =  " & XrecSet!current_emp_yrs
    YrecSet.Open strSQL, Xcon
    If YrecSet.EOF = False Then
    WorkingPeriodCurrentRate = YrecSet!Rates
    Else
    WorkingPeriodCurrentRate = 0
    End If
    YrecSet.Close
    
    
    strSQL = "select rates from working_period_last_emp_rates where  nr_of_years =  " & XrecSet!former_emp_yrs
    YrecSet.Open strSQL, Xcon
    If YrecSet.EOF = False Then
    WorkingPeriodFormerRate = YrecSet!Rates
    Else
    WorkingPeriodFormerRate = 0
    End If
    YrecSet.Close
    
    
    'coefficients apply
    Dim TScore As Double
    
    TScore = 0
    
    strSQL = "select rate,variable_nr  from coefnt_rates   "
    YrecSet.Open strSQL, Xcon
    Do While YrecSet.EOF = False
     If YrecSet!variable_nr = 1 Then
        TScore = TScore + AgeRate * YrecSet!Rate
     ElseIf YrecSet!variable_nr = 2 Then
        TScore = TScore + EducationLevelRate * YrecSet!Rate
     ElseIf YrecSet!variable_nr = 3 Then
        TScore = TScore + BankLocateRate * YrecSet!Rate
     ElseIf YrecSet!variable_nr = 4 Then
        TScore = TScore + LocaleRate * YrecSet!Rate
      ElseIf YrecSet!variable_nr = 5 Then
        TScore = TScore + MaritalRate * YrecSet!Rate
      ElseIf YrecSet!variable_nr = 6 Then
        TScore = TScore + DependantsRate * YrecSet!Rate
      ElseIf YrecSet!variable_nr = 7 Then
        TScore = TScore + LoanTenureRate * YrecSet!Rate
      ElseIf YrecSet!variable_nr = 8 Then
        TScore = TScore + EmpRate * YrecSet!Rate
      ElseIf YrecSet!variable_nr = 9 Then
        TScore = TScore + WorkingPeriodFormerRate * YrecSet!Rate
      ElseIf YrecSet!variable_nr = 10 Then
        TScore = TScore + WorkingPeriodCurrentRate * YrecSet!Rate
      ElseIf YrecSet!variable_nr = 11 Then
        TScore = TScore + LoanTenureRate * YrecSet!Rate
      ElseIf YrecSet!variable_nr = 12 Then
        TScore = TScore + NetIncomeRate * YrecSet!Rate
      ElseIf YrecSet!variable_nr = 13 Then
        TScore = TScore + CreditHistRate * YrecSet!Rate
      ElseIf YrecSet!variable_nr = 14 Then
        TScore = TScore + LoanFrmOtherBankRate * YrecSet!Rate
      End If

     
     YrecSet.MoveNext
    Loop
    YrecSet.Close
    
'1   Age in years    -1.333
'2   Level of education  -0.135
'3   Bank Proximity - 0.625
'4   location 0.15
'5   Marital Status - 0.173
'6   Dependents -0.611
'7   Loan Tenure 0.72
'8   Occupation -3.106
'9   Working period with last employer   -0.413
'10  Working Period with current employer    2.504
'11  Loan Period - 0.999
'12  Monthly net income  2.441
'13  Credit History  1.826
'14  other Loans 0.458
    
    Dim TAmount As Double
    Dim ScoreAmount As Double
    Dim PendingLoan As Double
    TAmount = 250000
    
    
    ScoreAmount = (TScore * 2) / 100 * TAmount
    
    YrecSet.Open "select sum(amount_req) from cust_trans where pan = '" & .Pan & "' and date_time_repaid is null", Xcon
    If IsNumeric(YrecSet.Fields(0).Value) Then
    PendingLoan = YrecSet.Fields(0).Value
     End If
    
    
    If (Val(.AmtTransaction) / 100 + PendingLoan) <= ScoreAmount Then
    .MessageTypeID = "0210"
    .RespCode = "00": .CreatePBBitMap (39)
    
    ScoreAmount = ScoreAmount - (Val(.AmtTransaction) / 100 + PendingLoan)
    .AmtSettlement = Format(ScoreAmount * 100, "000000000000"): .CreatePBBitMap (5)
    dbConnection.Execute "update em_agent_trans_1_a set state = 99, resp_code = '00' where tran_nr = '" & Status & "'"
    
    Xcon.Execute "INSERT INTO [cust_trans]([pan],[amount_req],[date_time_req],[date_time_grant]) Values ( '" & .Pan & "'," & Val(.AmtTransaction / 100) & ",'" & Format(Now, "yyyy-MM-dd hh:mm:ss") & "','" & Format(Now, "yyyy-MM-dd hh:mm:ss") & "')"
    
    
    
    Else
    
    .MessageTypeID = "0210"
    .RespCode = "05": .CreatePBBitMap (39)
    dbConnection.Execute "update em_agent_trans_1_a set state = 99, resp_code = '05' where tran_nr = '" & Status & "'"

       
    End If
    StrMessage = .CREATEMsgISO8538
    SendMessageToMobileApp StrMessage, IndexKey
    
     
    Exit Sub
    End If
   
   End If
            'Determine Routing;;;;;;
            
                        
         If .MessageTypeID = "0200" Or .MessageTypeID = "0221" Or .MessageTypeID = "0420" Or .MessageTypeID = "0421" Or .MessageTypeID = "0520" Or .MessageTypeID = "0521" Then
                     
                       If Debit = 0 Then
                       strSQL = "select pindex, ip_address, port,mode,node_name from em_merchant_pos_index where bin_code = '" & .ReceivingInstIdCode & "'"
                       ElseIf Debit = 1 Then
                       strSQL = "select pindex, ip_address, port,mode,node_name from em_merchant_pos_index where bin_code = '" & .AcquiringInstIdCode & "'"
                       End If
                       
                        rstObj.Open strSQL, dbConnection
                            
                            If rstObj.EOF = False Then
                                 OutLetIndex = rstObj!Pindex
                                 OutLetMode = rstObj!Mode
                                 DstNodeName = rstObj!Node_Name
                       
                                 
                            Else
                             'ProcEvents = "Transaction reference number:" & .RetrievalRefNum & " system trace audit number " & .SysTraceAuditNum & " cannot routed. Destination offline"
                                  .RespCode = "91": .CreatePBBitMap (39)
                                    
                                   dbConnection.Execute "update em_agent_trans_1_a set state = 99, resp_code = '91' where TRAN_NR = " & Status
                
                                    
                                    If .MessageTypeID = "0200" Then
                                    .MessageTypeID = "0210"
                                    ElseIf .MessageTypeID = "0420" Then
                                    .MessageTypeID = "0430"
                                    ElseIf .MessageTypeID = "0421" Then
                                    .MessageTypeID = "0430"
                                    ElseIf .MessageTypeID = "0520" Then
                                    .MessageTypeID = "0530"
                                    ElseIf .MessageTypeID = "0521" Then
                                    .MessageTypeID = "0530"
                                    End If
                                    
                                    StrMessage = .CREATEMsgISO8538
                                    
                                    
                             End If
                             rstObj.Close
                    Else
                        ProcEvents = "Transaction reference number:" & .RetrievalRefNum & " system trace audit number " & .SysTraceAuditNum & " cannot routed. No receiving institution ID"
                        .RespCode = "92": .CreatePBBitMap (39)
                        
                                    dbConnection.Execute "update em_agent_trans_1_a set state = 99, resp_code = '92' where tran_nr = " & Status
                                    
                                    If .MessageTypeID = "0200" Then
                                    .MessageTypeID = "0210"
                                    ElseIf .MessageTypeID = "0420" Then
                                    .MessageTypeID = "0430"
                                    If .MessageTypeID = "0421" Then
                                    .MessageTypeID = "0430"
                                    ElseIf .MessageTypeID = "0520" Then
                                    .MessageTypeID = "0530"
                                     ElseIf .MessageTypeID = "0521" Then
                                    .MessageTypeID = "0530"
                                    End If
                                    StrMessage = .CREATEMsgISO8538
                                    
                    End If
                              
                End If
                   
            
                 'Get Agent's Country Institution ID
                
           
           If .MessageTypeID = "0210" Or .MessageTypeID = "0430" Or .MessageTypeID = "0810" Then
              SendMessageToMobileApp StrMessage, IndexKey
              Exit Sub
           Else  '0200,0420,0421,0520      'Request Message to Sink
           
                 
           
           
                If OutLetIndex <> 0 And OutLetMode = 1 Then
                   SendMessageToSwitch StrMessage, OutLetIndex, MessageSentIndicator
                ElseIf OutLetIndex <> 0 And OutLetMode = 0 Then
                   SendMessageToMerchant StrMessage, GetIndexOut(OutLetIndex), MessageSentIndicator
                End If
                
               
                If MessageSentIndicator = 1 Then
                  Dim Timer_Number As Integer
                  SendMessageToPostilion StrMessage, MsgSentIndicator 'forward message
                  
                  
                  Timer_Number = GetTranTimerIndex
                  TransTimers(Timer_Number) = 1
                  Load TransTmr(Timer_Number)
                  TransTmr(Timer_Number).Tag = .EchoData
                  TransTmr(Timer_Number).Enabled = True
                  
                 
                  If Trace_Flag = 1 And DstNodeName = FrmTrace.Combo1.List(FrmTrace.Combo1.ListIndex) Then
                  FrmTrace.Text1 = FrmTrace.Text1 & vbNewLine & "Message To " & DstNodeName & vbNewLine & StrMsgToSend
                  FrmTrace.Text1 = FrmTrace.Text1 & vbNewLine & Trace
                  End If
                
                Else
                   
                    dbConnection.Execute "update em_agent_trans_1_a set state = 99, resp_code = '91' where tran_nr = " & Status
                
                    .MessageTypeID = "0210"
                    .RespCode = "91": .CreatePBBitMap (39)
                    StrMessage = .CREATEMsgISO8538
                    
                    SendMessageToMobileApp StrMessage, IndexKey
                    
'                     strSQL = "select pindex, ip_address, port,mode,node_name from em_merchant_pos_index where bin_code = '" & .AcquiringInstIdCode & "'"
'                     rstObj.Open strSQL, dbConnection
'
'
'                            If rstObj.EOF = False Then
'
'                                 OutLetIndex = rstObj!Pindex
'                                 OutLetMode = rstObj!Mode
'                                 DstNodeName = rstObj!Node_Name
'
'                                 If OutLetIndex <> 0 And OutLetMode = 1 Then
'                                   SendMessageToSwitch strMessage, OutLetIndex, MessageSentIndicator
'                                 ElseIf OutLetIndex <> 0 And OutLetMode = 0 Then
'                                   SendMessageToMerchant strMessage, GetIndexOut(OutLetIndex), MessageSentIndicator
'                                 End If
'
'                            End If
'                            rstObj.Close
'
                    Exit Sub
                    
                    
                  If Trace_Flag = 1 And DstNodeName = FrmTrace.Combo1.List(FrmTrace.Combo1.ListIndex) Then
                  FrmTrace.Text1 = FrmTrace.Text1 & vbNewLine & "Message to " & DstNodeName & vbNewLine & StrMsgToSend
                  FrmTrace.Text1 = FrmTrace.Text1 & vbNewLine & "Message to  " & DstNodeName & ".Interchange is offline."
                  
                  End If
                End If
           
             End If
        
        
        End With
        
        
        'Determine ASA Port to send message
        
                
 Exit Sub
            
ErrorTrap:
txt_log.Text = txt_log.Text & vbNewLine & "Process ProcessMerchantRequest " & err.Description
EventsTrap = err.Description
                        
End Sub



Private Sub ProcessMerchantMessage0210(ByVal StrPostMessage As String, ByVal Source_Key As String, ByVal Interchange As String)
    Dim StrMessage As String
    On Error GoTo ErrorTrap
    Dim Trace As String
    Dim AmountDst As String
    Dim AmountSrc As String
    Dim ConversionRate As String
    Dim RstCommand As ADODB.Command
    Dim RecSet As New ADODB.Recordset
    Dim DoesCountryExit As Boolean
    Dim DstNodeName As Variant
    Dim rstObj As New ADODB.Recordset
    Dim RecInstID As String
    Dim strSQL As String
    Dim PostMsg As New PostBridgeISO8583
    Dim MsgSentIndicator As Integer
    Dim Status As Integer
    Dim OutLetIndex As Integer
    Dim OutLetMode As Integer
    Dim ProcEvents As String
    Dim MessageSentIndicator As Integer
    Dim StrMsgToSend As String
    Dim Debit As Integer
    Dim IndexKey As Integer
    MsgSentIndicator = 0
    With PostMsg
        .ISO8583MsgBD StrPostMessage
        .ResetBitMaps
        
       
        Trace = "Message type: " & .MessageTypeID & vbNewLine
        
        
        
        
             If Left(.ProcessingCODE, 2) = "21" Or Left(.ProcessingCODE, 2) = "31" Or Left(.ProcessingCODE, 2) = "38" Or Left(.ProcessingCODE, 2) = "42" Then   'Debit
               Debit = 0
             ElseIf Left(.ProcessingCODE, 2) = "00" Or Left(.ProcessingCODE, 2) = "01" Then
               Debit = 0
             End If

             
             
             
            If List2.ListCount < 20 Then
               List2.AddItem "CUST 1:" & .AccIdOne & " CUST 2:" & .AccIdTwo & " TRAN: " & Left(.ProcessingCODE, 2) & " AMT: " & Val(.AmtTransaction) / 100 & " CURNCY: " & .CurrencyCodeTxn & " RSP CODE: " & .RespCode, 0
            
            Else
                List2.RemoveItem (19)
                List2.AddItem "CUST 1:" & .AccIdOne & " CUST 2:" & .AccIdTwo & " TRAN: " & Left(.ProcessingCODE, 2) & " AMT: " & Val(.AmtTransaction) / 100 & " CURNCY: " & .CurrencyCodeTxn & " RSP CODE: " & .RespCode, 0
                
            End If
          
          
        
             
              If .RespCode <> "" Then
                rstObj.Open "select * from em_agent_trans_1_a where tran_nr= " & CLng(.EchoData), dbConnection
                    If rstObj.EOF = False Then
                      
                         AmountSrc = rstObj!amount_req
                         AmountDst = rstObj!Amount_forward
                        .ReceivingInstIdCode = rstObj!Rec_Inst_id 'Routes's to customer country
                        .AcquiringInstIdCode = rstObj!Acq_inst_id
                        .AccIdOne = rstObj!Account_id1
                        .AccIdTwo = rstObj!Account_id2
                        ConversionRate = rstObj!conversion_rate
                        IndexKey = rstObj!Transform
                        
'                     If Debit = 1 Then 'Debit
'                        .AmtTransaction = rstObj!Amount_forward
'                        RecInstID = rstObj!Rec_Inst_id
'                     ElseIf Debit = 0 Then 'Credit
                     
                       .AmtTransaction = AmountDst: .CreatePBBitMap (4)
                       .AmtSettlement = AmountSrc: .CreatePBBitMap (5)
                       .ConvRateSettle = ConversionRate
                       
                        RecInstID = rstObj!Acq_inst_id
                        
'                     End If
                      
                        rstObj.Close
                    
                       dbConnection.Execute "update em_agent_trans_1_a set state = 99,advice_message = '0220', resp_code = '" & .RespCode & "'  where tran_nr= " & CLng(.EchoData) & " and message_type = '0200'"
                                 
'                        strSQL = "select pindex, ip_address, port,mode,node_name from em_merchant_pos_index where bin_code = '" & RecInstID & "'"
'                        rstObj.Open strSQL, dbConnection
'
'                            If rstObj.EOF = False Then
'                                 .MessageTypeID = "0210"
'                                 OutLetIndex = rstObj!Pindex
'                                 OutLetMode = rstObj!Mode
'                                 DstNodeName = rstObj!Node_Name
'                                 dbConnection.Execute "update em_agent_trans_1_a set state = 99,advice_message = '0220', resp_code = '" & .RespCode & "'  where tran_nr= " & .EchoData & " and message_type = '0200'"
'
'
'                            Else
'                             .RespCode = "91"
'                             .MessageTypeID = "0420"
'                             .AmtTransaction = AmountDst
'                             dbConnection.Execute "update em_agent_trans_1_a set state = 99,reversal_message = '0420', resp_code = '" & .RespCode & "'  where tran_nr= " & .EchoData & " and message_type = '0200'"
'
'                            End If
'                            rstObj.Close
                    Else
                        .RespCode = "96": .CreatePBBitMap (39)
                        '.MessageTypeID = "0420" 'reversal shud be sent
                        
                        
                        dbConnection.Execute "update em_agent_trans_1_a set state = 99,reversal_message = '0420', resp_code = '" & .RespCode & "'  where  tran_nr= " & CLng(.EchoData) & " and message_type = '0200'"
                           
                        'Amount is taken care of
                    End If
                    
'
'                    If .MessageTypeID = "0420" Then
'                            If Debit = 1 Then
'                             .AmtTransaction = AmountSrc
'                            Else
'                            .AmtTransaction = AmountDst
'                            End If
'                    End If
                    
                Else
                
                dbConnection.Execute "update em_agent_trans_1_a set state = 99, resp_code = '" & .RespCode & "'  where  tran_nr= " & CLng(.EchoData) & " and message_type = '0200'"
                'Send resp back to USSD
                End If
                
                
        
          
        
         If .Pan <> "" Then .CreatePBBitMap (2): Trace = Trace & "Field 002: " & .Pan & vbNewLine
         If .ProcessingCODE <> "" Then .CreatePBBitMap (3): Trace = Trace & "Field 003: " & .ProcessingCODE & vbNewLine
         If .AmtTransaction <> "" Then: .CreatePBBitMap (4): Trace = Trace & "Field 004: " & .AmtTransaction & vbNewLine
         If .AmtSettlement <> "" Then: .CreatePBBitMap (5): Trace = Trace & "Field 005: " & .AmtSettlement & vbNewLine
         If .DatetimeTransmission <> "" Then .CreatePBBitMap (7): Trace = Trace & "Field 007: " & .DatetimeTransmission & vbNewLine
         If .ConvRateSettle <> "" Then .CreatePBBitMap (9): Trace = Trace & "Field 009: " & .ConvRateSettle & vbNewLine
         If .SysTraceAuditNum <> "" Then .CreatePBBitMap (11): Trace = Trace & "Field 011: " & .SysTraceAuditNum & vbNewLine
         If .TimeLocTxn <> "" Then .CreatePBBitMap (12): Trace = Trace & "Field 012: " & .DateLocTxn & vbNewLine
         If .DateLocTxn <> "" Then .CreatePBBitMap (13): Trace = Trace & "Field 013: " & .TimeLocTxn & vbNewLine
         If .DateExpiry <> "" Then .CreatePBBitMap (14): Trace = Trace & "Field 014: " & .DateExpiry & vbNewLine
         If .DateSettle <> "" Then .CreatePBBitMap (15): Trace = Trace & "Field 015: " & .DateSettle & vbNewLine
         If .DateConversion <> "" Then .CreatePBBitMap (16): Trace = Trace & "Field 016: " & .DateConversion & vbNewLine
         If .MerchantType <> "" Then .CreatePBBitMap (18): Trace = Trace & "Field 018: " & .MerchantType & vbNewLine
         If .POSEntryMode <> "" Then .CreatePBBitMap (22): Trace = Trace & "Field 022: " & .POSEntryMode & vbNewLine
         If .CardSeqNum <> "" Then .CreatePBBitMap (23): Trace = Trace & "Field 023: " & .CardSeqNum & vbNewLine
         If .POSConditionCode <> "" Then .CreatePBBitMap (25): Trace = Trace & "Field 025: " & .POSConditionCode & vbNewLine
         If .POSPinCaptureCode <> "" Then .CreatePBBitMap (26): Trace = Trace & "Field 026: " & .POSPinCaptureCode & vbNewLine
         If .AmtTxnFee <> "" Then .CreatePBBitMap (28): Trace = Trace & "Field 028: " & .AmtTxnFee & vbNewLine
         If .AmtTxnProcessingFee <> "" Then .CreatePBBitMap (30): Trace = Trace & "Field 030: " & .AmtTxnProcessingFee & vbNewLine
         If .AcquiringInstIdCode <> "" Then .CreatePBBitMap (32): Trace = Trace & "Field 032: " & .AcquiringInstIdCode & vbNewLine
         If .ForwardingInstIdCode <> "" Then .CreatePBBitMap (33): Trace = Trace & "Field 033: " & .ForwardingInstIdCode & vbNewLine
         If .Track2Data <> "" Then .CreatePBBitMap (35): Trace = Trace & "Field 035: " & .Track2Data & vbNewLine
         If .RetrievalRefNum <> "" Then .CreatePBBitMap (37): Trace = Trace & "Field 037: " & .RetrievalRefNum & vbNewLine
         If .AuthIdResp <> "" Then .CreatePBBitMap (38): Trace = Trace & "Field 038: " & .AuthIdResp & vbNewLine
         If .RespCode <> "" Then .CreatePBBitMap (39): Trace = Trace & "Field 039: " & .RespCode & vbNewLine
         If .ServiceRestrictionCode <> "" Then .CreatePBBitMap (40): Trace = Trace & "Field 040: " & .ServiceRestrictionCode & vbNewLine
         If .CardAcceptorTermId <> "" Then .CreatePBBitMap (41): Trace = Trace & "Field 041: " & .CardAcceptorTermId & vbNewLine
         If .CardAcceptorIdCode <> "" Then .CreatePBBitMap (42): Trace = Trace & "Field 042: " & .CardAcceptorIdCode & vbNewLine
         If .CardAcceptorNameLoc <> "" Then .CreatePBBitMap (43): Trace = Trace & "Field 043: " & .CardAcceptorNameLoc & vbNewLine
         If .AdditionalRespData <> "" Then .CreatePBBitMap (44):: Trace = Trace & "Field 044: " & .AdditionalRespData & vbNewLine
         If .AdditionalData <> "" Then .CreatePBBitMap (48): Trace = Trace & "Field 048: " & .AdditionalData & vbNewLine
         If .CurrencyCodeTxn <> "" Then .CreatePBBitMap (49): Trace = Trace & "Field 049: " & .CurrencyCodeTxn & vbNewLine
         If .CurrencyCodeSettle <> "" Then .CreatePBBitMap (50): Trace = Trace & "Field 050: " & .CurrencyCodeSettle & vbNewLine
         If .AdditionalAmts <> "" Then .CreatePBBitMap (54): Trace = Trace & "Field 054: " & .AdditionalAmts & vbNewLine
         If .MsgReasonCode <> "" Then .CreatePBBitMap (56): Trace = Trace & "Field 056: " & .MsgReasonCode & vbNewLine
         If .EchoData <> "" Then .CreatePBBitMap (59): Trace = Trace & "Field 059: " & .EchoData & vbNewLine
         If .OriginalTranRefnumber <> "" Then .CreatePBBitMap (60):  Trace = Trace & "Field 060: " & .OriginalTranRefnumber & vbNewLine
         If .SessionID <> "" Then .CreatePBBitMap (61):  Trace = Trace & "Field 061: " & .SessionID & vbNewLine
         If .TranRefnumber <> "" Then .CreatePBBitMap (62):  Trace = Trace & "Field 062: " & .TranRefnumber & vbNewLine
             
         If .NetMangtInfoCode <> "" Then .CreatePBBitMap (70): Trace = Trace & "Field 070: " & .NetMangtInfoCode & vbNewLine
         If .OriginalDataElements <> "" Then .CreatePBBitMap (90): Trace = Trace & "Field 090: " & .OriginalDataElements & vbNewLine
         If .ReplacementAmts <> "" Then .CreatePBBitMap (95): Trace = Trace & "Field 095: " & .ReplacementAmts & vbNewLine
         If .Payee <> "" Then .CreatePBBitMap (98): Trace = Trace & "Field 098: " & .Payee & vbNewLine
         If .ReceivingInstIdCode <> "" Then .CreatePBBitMap (100): Trace = Trace & "Field 100: " & .ReceivingInstIdCode & vbNewLine
         If .AccIdOne <> "" Then .CreatePBBitMap (102): Trace = Trace & "Field 102: " & .AccIdOne & vbNewLine
         If .AccIdTwo <> "" Then .CreatePBBitMap (103): Trace = Trace & "Field 103: " & .AccIdTwo
         
                
         

         StrMessage = .CREATEMsgISO8538
                        
                        
      
          
          
210:
          If .MessageTypeID = "0210" Or .MessageTypeID = "0430" Then  'respond back to USSD, declined trans
               strSQL = "select pindex, ip_address, port,mode,node_name from em_merchant_pos_index where bin_code = '" & .ReceivingInstIdCode & "'"
               rstObj.Open strSQL, dbConnection

                            If rstObj.EOF = False Then
                                 OutLetIndex = rstObj!Pindex
                                 OutLetMode = rstObj!Mode
                                 DstNodeName = rstObj!Node_Name

'                                If OutLetIndex <> 0 And OutLetMode = 1 Then
'                                   SendMessageToSwitch strMessage, OutLetIndex, MessageSentIndicator
'                                ElseIf OutLetIndex <> 0 And OutLetMode = 0 Then
'                                   SendMessageToMerchant strMessage, IndexKey, MessageSentIndicator
'                                End If
                            End If

    
         SendMessageToMobileApp StrMessage, IndexKey
                               
           If Trace_Flag = 1 And DstNodeName = FrmTrace.Combo1.List(FrmTrace.Combo1.ListIndex) Then
                  FrmTrace.Text1 = FrmTrace.Text1 & vbNewLine & "Message from " & DstNodeName & vbNewLine & StrMessage
                  FrmTrace.Text1 = FrmTrace.Text1 & vbNewLine & Trace
                  
          End If
              Exit Sub
          End If
          
          
'          If .MessageTypeID = "0420" Then  'Request Message to Sink
'           If Debit = 0 Then
'              strSQL = "select pindex, ip_address, port,mode,node_name from em_merchant_pos_index where bin_code = '" & .ReceivingInstIdCode & "'"
'           ElseIf Debit = 1 Then
'              strSQL = "select pindex, ip_address, port,mode,node_name from em_merchant_pos_index where bin_code = '" & .AcquiringInstIdCode & "'"
'           End If
'               rstObj.Open strSQL, dbConnection
'
'                            If rstObj.EOF = False Then
'                                 OutLetIndex = rstObj!Pindex
'                                 OutLetMode = rstObj!Mode
'                                 DstNodeName = rstObj!Node_Name
'
'                                If OutLetIndex <> 0 And OutLetMode = 1 Then
'                                   SendMessageToSwitch strMessage, OutLetIndex, MessageSentIndicator
'                                ElseIf OutLetIndex <> 0 And OutLetMode = 0 Then
'                                   SendMessageToMerchant strMessage, GetIndexOut(OutLetIndex), MessageSentIndicator
'                                End If
'
'                                .MessageTypeID = "0210"
'                                GoTo 210 'Respond back
'
'                            Else
'                                .MessageTypeID = "0210"
'                                GoTo 210
'                            End If
'                     Exit Sub
'          End If
'
'          If .MessageTypeID = "0220" Then  'Forward Message to Sink
'
'            If Debit = 0 Then
'              strSQL = "select pindex, ip_address, port,mode,node_name from em_merchant_pos_index where bin_code = '" & .AcquiringInstIdCode & "'"
'            ElseIf Debit = 1 Then
'              strSQL = "select pindex, ip_address, port,mode,node_name from em_merchant_pos_index where bin_code = '" & .ReceivingInstIdCode & "'"
'            End If
'               rstObj.Open strSQL, dbConnection
'
'                            If rstObj.EOF = False Then
'                                 OutLetIndex = rstObj!Pindex
'                                 OutLetMode = rstObj!Mode
'                                 DstNodeName = rstObj!Node_Name
'                            End If
'                            rstObj.Close
'
'                If OutLetIndex <> 0 And OutLetMode = 1 Then
'                   SendMessageToSwitch strMessage, OutLetIndex, MessageSentIndicator
'                ElseIf OutLetIndex <> 0 And OutLetMode = 0 Then
'                   SendMessageToMerchant strMessage, GetIndexOut(OutLetIndex), MessageSentIndicator
'                End If
'
'                If MessageSentIndicator = 1 Then
'                  Dim Timer_Number As Integer
'                  SendMessageToPostilion strMessage, MsgSentIndicator 'forward message
'
'
'                  Timer_Number = GetTranTimerIndex
'                  TransTimers(Timer_Number) = 1
'                  Load TransTmr(Timer_Number)
'                  TransTmr(Timer_Number).Tag = .RetrievalRefNum
'                  TransTmr(Timer_Number).Enabled = True
'
'
'                  If Trace_Flag = 1 And DstNodeName = FrmTrace.Combo1.List(FrmTrace.Combo1.ListIndex) Then
'                  FrmTrace.Text1 = FrmTrace.Text1 & vbNewLine & "Message To " & DstNodeName & vbNewLine & StrMsgToSend
'                  FrmTrace.Text1 = FrmTrace.Text1 & vbNewLine & Trace
'                  End If
'
'                Else
'
'                    .MessageTypeID = "0210"
'                    .RespCode = "91": .CreatePBBitMap (39)
'                    .AmtTransaction = AmountSrc
'                    strMessage = .CREATEMsgISO8538
'
'                    dbConnection.Execute "update em_agent_trans_1_a set state = 99,reversal_message = '0420',resp_code_adv = '91'  where ref_nr= '" & .RetrievalRefNum & "' and message_type = '0200'"
'
'                    SendMessageToMobileApp strMessage 'Send response back
'
'                    'Reverse Trans
'
'                    If Debit = 0 Then
'                       strSQL = "select pindex, ip_address, port,mode,node_name from em_merchant_pos_index where bin_code = '" & .ReceivingInstIdCode & "'"
'                    ElseIf Debit = 1 Then
'                       strSQL = "select pindex, ip_address, port,mode,node_name from em_merchant_pos_index where bin_code = '" & .AcquiringInstIdCode & "'"
'                    End If
'                       rstObj.Open strSQL, dbConnection
'
'                            If rstObj.EOF = False Then
'                                 OutLetIndex = rstObj!Pindex
'                                 OutLetMode = rstObj!Mode
'                                 DstNodeName = rstObj!Node_Name
'
'
'
'                                 .MessageTypeID = "0420"
'                                 .AmtTransaction = AmountDst
'                                 .RespCode = "91"
'                                 strMessage = .CREATEMsgISO8538
'
'                                If OutLetIndex <> 0 And OutLetMode = 1 Then
'                                   SendMessageToSwitch strMessage, OutLetIndex, MessageSentIndicator
'                                ElseIf OutLetIndex <> 0 And OutLetMode = 0 Then
'                                   SendMessageToMerchant strMessage, GetIndexOut(OutLetIndex), MessageSentIndicator
'                                End If
'
'                            Else
'
'
'                            End If
                    
                  
               
        
          
          
          
          
          
'         If MsgSentIndicator = 1 Then
'           If Trace_Flag = 1 And Interchange = FrmTrace.Combo1.List(FrmTrace.Combo1.ListIndex) Then
'             FrmTrace.Text1 = FrmTrace.Text1 & vbNewLine & "Message from " & Interchange & vbNewLine & StrPostMessage
'             FrmTrace.Text1 = FrmTrace.Text1 & vbNewLine & Trace
'             FrmTrace.Text1 = FrmTrace.Text1 & vbNewLine & "Message sent to Data Server." & vbNewLine
'
'          End If
'
'          Else
'
'           If Trace_Flag = 1 And Interchange = FrmTrace.Combo1.List(FrmTrace.Combo1.ListIndex) Then
'             FrmTrace.Text1 = FrmTrace.Text1 & vbNewLine & "Message from " & Interchange & vbNewLine & StrPostMessage
'             FrmTrace.Text1 = FrmTrace.Text1 & vbNewLine & Trace
'             FrmTrace.Text1 = FrmTrace.Text1 & vbNewLine & "Data Server offline. Message could not be sent." & vbNewLine
'           End If
'
'         End If
'
       
        End With
        
        
        'Determine ASA Port to send message
        
                
 Exit Sub
            
ErrorTrap:
txt_log.Text = txt_log.Text & vbNewLine & "Process ProcessMerchantMessageResponse " & err.Description
EventsTrap = err.Description
                        
  
End Sub


Private Sub ProcessMerchantMessage0230(ByVal StrPostMessage As String, ByVal Source_Key As String, ByVal Interchange As String)
    Dim StrMessage As String
    On Error GoTo ErrorTrap
    Dim Trace As String
    Dim Status As Integer
    Dim RecInstID As String
    Dim AmountDst As String
    Dim AmountSrc As String
    Dim ConversionRate As String
    Dim rstObj As New ADODB.Recordset
    Dim RecSet As New ADODB.Recordset
    Dim DoesCountryExit As Boolean
    Dim MessageSentIndicator As Integer
    Dim DstNodeName As Variant
    Dim OutLetMode As Integer
    Dim PostMsg As New PostBridgeISO8583
    Dim OutLetIndex As Integer
    Dim MsgSentIndicator As Integer
    Dim strSQL  As String
    Dim Debit As Integer
    MsgSentIndicator = 0
    With PostMsg
        .ISO8583MsgBD StrPostMessage
        .ResetBitMaps
        
       
        Trace = "Message type: " & .MessageTypeID & vbNewLine
              
              
              
              If Left(.ProcessingCODE, 2) = "21" Or Left(.ProcessingCODE, 2) = "31" Or Left(.ProcessingCODE, 2) = "38" Or Left(.ProcessingCODE, 2) = "42" Then  'Debit
                       Debit = 1
              ElseIf Left(.ProcessingCODE, 2) = "00" Or Left(.ProcessingCODE, 2) = "01" Then
                       Debit = 0
              End If
        
        
              If List3.ListCount < 20 Then
               List3.AddItem "CUST 1:" & .AccIdOne & " CUST 2:" & .AccIdTwo & " TRAN: " & Left(.ProcessingCODE, 2) & " AMT: " & Val(.AmtTransaction) / 100 & " CURNCY: " & .CurrencyCodeTxn & " RSP CODE: " & .RespCode, 0
            
              Else
                List3.RemoveItem (19)
                List3.AddItem "CUST 1:" & .AccIdOne & " CUST 2:" & .AccIdTwo & " TRAN: " & Left(.ProcessingCODE, 2) & " AMT: " & Val(.AmtTransaction) / 100 & " CURNCY: " & .CurrencyCodeTxn & " RSP CODE: " & .RespCode, 0
                
              End If
        
        
            
             
              If .RespCode = "00" Then
                 .MessageTypeID = "0210"
                 dbConnection.Execute "update em_agent_trans_1_a set state = 99, resp_code_adv = '" & .RespCode & "'  where ref_nr= '" & .RetrievalRefNum & "'"
              Else
              
                    rstObj.Open "select * from em_agent_trans_1_a where ref_nr= '" & .RetrievalRefNum & "' and message_type = '0200'", dbConnection
                    If rstObj.EOF = False Then
                      
                         AmountSrc = rstObj!amount_req
                         AmountDst = rstObj!Amount_forward
                        .AmtTransaction = rstObj!amount_req
                        .AcquiringInstIdCode = rstObj!Acq_inst_id
                        .ReceivingInstIdCode = rstObj!Rec_Inst_id
                        .AccIdOne = rstObj!Account_id1
                        .AccIdTwo = rstObj!Account_id2
                        ConversionRate = rstObj!conversion_rate
                        RecInstID = rstObj!Acq_inst_id
                        rstObj.Close
              
              
                         dbConnection.Execute "update em_agent_trans_1_a set state = 99, resp_code_adv = '" & .RespCode & "'  where ref_nr= '" & .RetrievalRefNum & "'"
                         .MessageTypeID = "0420"
                         
                                                                                                           
                     End If
                     rstObj.Close
                                   
                End If
                
                If .MessageTypeID = "0420" Then
                    If Debit = 1 Then
                      .AmtTransaction = AmountSrc
                    Else: Debit = 0
                     .AmtTransaction = AmountDst
                    End If
                End If
        
        
         If .Pan <> "" Then .CreatePBBitMap (2): Trace = Trace & "Field 002: " & .Pan & vbNewLine
         If .ProcessingCODE <> "" Then .CreatePBBitMap (3): Trace = Trace & "Field 003: " & .ProcessingCODE & vbNewLine
         If .AmtTransaction <> "" Then: .CreatePBBitMap (4): Trace = Trace & "Field 004: " & .AmtTransaction & vbNewLine
         If .AmtSettlement <> "" Then: .CreatePBBitMap (5): Trace = Trace & "Field 005: " & .AmtSettlement & vbNewLine
         If .DatetimeTransmission <> "" Then .CreatePBBitMap (7): Trace = Trace & "Field 007: " & .DatetimeTransmission & vbNewLine
         If .ConvRateSettle <> "" Then .CreatePBBitMap (9): Trace = Trace & "Field 009: " & .ConvRateSettle & vbNewLine
         If .SysTraceAuditNum <> "" Then .CreatePBBitMap (11): Trace = Trace & "Field 011: " & .SysTraceAuditNum & vbNewLine
         If .TimeLocTxn <> "" Then .CreatePBBitMap (12): Trace = Trace & "Field 012: " & .DateLocTxn & vbNewLine
         If .DateLocTxn <> "" Then .CreatePBBitMap (13): Trace = Trace & "Field 013: " & .TimeLocTxn & vbNewLine
         If .DateExpiry <> "" Then .CreatePBBitMap (14): Trace = Trace & "Field 014: " & .DateExpiry & vbNewLine
         If .DateSettle <> "" Then .CreatePBBitMap (15): Trace = Trace & "Field 015: " & .DateSettle & vbNewLine
         If .DateConversion <> "" Then .CreatePBBitMap (16): Trace = Trace & "Field 016: " & .DateConversion & vbNewLine
         If .MerchantType <> "" Then .CreatePBBitMap (18): Trace = Trace & "Field 018: " & .MerchantType & vbNewLine
         If .POSEntryMode <> "" Then .CreatePBBitMap (22): Trace = Trace & "Field 022: " & .POSEntryMode & vbNewLine
         If .CardSeqNum <> "" Then .CreatePBBitMap (23): Trace = Trace & "Field 023: " & .CardSeqNum & vbNewLine
         If .POSConditionCode <> "" Then .CreatePBBitMap (25): Trace = Trace & "Field 025: " & .POSConditionCode & vbNewLine
         If .POSPinCaptureCode <> "" Then .CreatePBBitMap (26): Trace = Trace & "Field 026: " & .POSPinCaptureCode & vbNewLine
         If .AmtTxnFee <> "" Then .CreatePBBitMap (28): Trace = Trace & "Field 028: " & .AmtTxnFee & vbNewLine
         If .AmtTxnProcessingFee <> "" Then .CreatePBBitMap (30): Trace = Trace & "Field 030: " & .AmtTxnProcessingFee & vbNewLine
         If .AcquiringInstIdCode <> "" Then .CreatePBBitMap (32): Trace = Trace & "Field 032: " & .AcquiringInstIdCode & vbNewLine
         If .ForwardingInstIdCode <> "" Then .CreatePBBitMap (33): Trace = Trace & "Field 033: " & .ForwardingInstIdCode & vbNewLine
         If .Track2Data <> "" Then .CreatePBBitMap (35): Trace = Trace & "Field 035: " & .Track2Data & vbNewLine
         If .RetrievalRefNum <> "" Then .CreatePBBitMap (37): Trace = Trace & "Field 037: " & .RetrievalRefNum & vbNewLine
         If .AuthIdResp <> "" Then .CreatePBBitMap (38): Trace = Trace & "Field 038: " & .AuthIdResp & vbNewLine
         If .RespCode <> "" Then .CreatePBBitMap (39): Trace = Trace & "Field 039: " & .RespCode & vbNewLine
         If .ServiceRestrictionCode <> "" Then .CreatePBBitMap (40): Trace = Trace & "Field 040: " & .ServiceRestrictionCode & vbNewLine
         If .CardAcceptorTermId <> "" Then .CreatePBBitMap (41): Trace = Trace & "Field 041: " & .CardAcceptorTermId & vbNewLine
         If .CardAcceptorIdCode <> "" Then .CreatePBBitMap (42): Trace = Trace & "Field 042: " & .CardAcceptorIdCode & vbNewLine
         If .CardAcceptorNameLoc <> "" Then .CreatePBBitMap (43): Trace = Trace & "Field 043: " & .CardAcceptorNameLoc & vbNewLine
         If .AdditionalRespData <> "" Then .CreatePBBitMap (44):: Trace = Trace & "Field 044: " & .AdditionalRespData & vbNewLine
         If .AdditionalData <> "" Then .CreatePBBitMap (48): Trace = Trace & "Field 048: " & .AdditionalData & vbNewLine
         If .CurrencyCodeTxn <> "" Then .CreatePBBitMap (49): Trace = Trace & "Field 049: " & .CurrencyCodeTxn & vbNewLine
         If .CurrencyCodeSettle <> "" Then .CreatePBBitMap (50): Trace = Trace & "Field 050: " & .CurrencyCodeSettle & vbNewLine
         
         '.PinData = "0123456789ABCDEF": .CreatePBBitMap (52): Trace = Trace & "Field 052: " & "****************" & vbNewLine
         If .AdditionalAmts <> "" Then .CreatePBBitMap (54): Trace = Trace & "Field 054: " & .AdditionalAmts & vbNewLine
         If .MsgReasonCode <> "" Then .CreatePBBitMap (56): Trace = Trace & "Field 056: " & .MsgReasonCode & vbNewLine
         If .EchoData <> "" Then .CreatePBBitMap (59): Trace = Trace & "Field 059: " & .EchoData & vbNewLine
         If .NetMangtInfoCode <> "" Then .CreatePBBitMap (70): Trace = Trace & "Field 070: " & .NetMangtInfoCode & vbNewLine
         If .OriginalDataElements <> "" Then .CreatePBBitMap (90): Trace = Trace & "Field 090: " & .OriginalDataElements & vbNewLine
         If .ReplacementAmts <> "" Then .CreatePBBitMap (95): Trace = Trace & "Field 095: " & .ReplacementAmts & vbNewLine
         If .ReceivingInstIdCode <> "" Then .CreatePBBitMap (100): Trace = Trace & "Field 100: " & .ReceivingInstIdCode & vbNewLine
         If .AccIdOne <> "" Then .CreatePBBitMap (102): Trace = Trace & "Field 102: " & .AccIdOne & vbNewLine
         If .AccIdTwo <> "" Then .CreatePBBitMap (103): Trace = Trace & "Field 103: " & .AccIdTwo
         
                
         

          StrMessage = .CREATEMsgISO8538
                       

          'SendMessageToPostilion strMessage, MsgSentIndicator
                    
210:
          If .MessageTypeID = "0210" Then
              SendMessageToMobileApp StrMessage, 0
              Exit Sub
                   
          ElseIf .MessageTypeID = "0420" Then  'Request Message to Sink
                If Debit = 1 Then 'Debit
                 strSQL = "select pindex, ip_address, port,mode,node_name from em_merchant_pos_index where bin_code = '" & .AcquiringInstIdCode & "'"
                ElseIf Debit = 0 Then
                 strSQL = "select pindex, ip_address, port,mode,node_name from em_merchant_pos_index where bin_code = '" & .ReceivingInstIdCode & "'"
                End If
                      rstObj.Open strSQL, dbConnection
                            
                            If rstObj.EOF = False Then
                                 
                                 OutLetIndex = rstObj!Pindex
                                 OutLetMode = rstObj!Mode
                                 DstNodeName = rstObj!Node_Name
                                 
                             End If
           
                            If OutLetIndex <> 0 And OutLetMode = 1 Then
                               SendMessageToSwitch StrMessage, OutLetIndex, MessageSentIndicator
                            ElseIf OutLetIndex <> 0 And OutLetMode = 0 Then
                               SendMessageToMerchant StrMessage, GetIndexOut(OutLetIndex), MessageSentIndicator
                            End If
                           
                    
                        If MessageSentIndicator = 1 Then
                          Dim Timer_Number As Integer
                          SendMessageToPostilion StrMessage, MsgSentIndicator 'forward message
                          
                          
                          Timer_Number = GetTranTimerIndex
                          TransTimers(Timer_Number) = 1
                          Load TransTmr(Timer_Number)
                          TransTmr(Timer_Number).Tag = .RetrievalRefNum
                          TransTmr(Timer_Number).Enabled = True
                          
                         
                          If Trace_Flag = 1 And DstNodeName = FrmTrace.Combo1.List(FrmTrace.Combo1.ListIndex) Then
                          FrmTrace.Text1 = FrmTrace.Text1 & vbNewLine & "Message To " & DstNodeName & vbNewLine & StrMessage
                          FrmTrace.Text1 = FrmTrace.Text1 & vbNewLine & Trace
                          End If
                        
                        End If
                            
                        If Trace_Flag = 1 And DstNodeName = FrmTrace.Combo1.List(FrmTrace.Combo1.ListIndex) Then
                          FrmTrace.Text1 = FrmTrace.Text1 & vbNewLine & "Message to " & DstNodeName & vbNewLine & StrMessage
                          FrmTrace.Text1 = FrmTrace.Text1 & vbNewLine & "Message to  " & DstNodeName & ".Interchange is offline."
                          
                        End If
                          
                         'reply  to USSD service
                        .MessageTypeID = "0210"
                        .RespCode = "06"
                        StrMessage = .CREATEMsgISO8538
                        GoTo 210
                        
             End If
             
        End With
                
        'Determine ASA Port to send message
        
                
 Exit Sub
            
ErrorTrap:
txt_log.Text = txt_log.Text & vbNewLine & "Process ProcessMerchantMessage " & err.Description
EventsTrap = err.Description
                        
  
End Sub

Private Sub ProcessMerchantMessage0420(ByVal StrPostMessage As String, ByVal Source_Key As String, ByVal Interchange As String)
    Dim StrMessage As String
    On Error GoTo ErrorTrap
    Dim Trace As String
    
    Dim Msisdn As Variant
    Dim Msisdn2 As Variant
    Dim Agent_Number As Variant
    Dim ATM_Authcode As Variant
    Dim AmntSrcCurr As String
    Dim AmntDstCurr As String
    Dim AmtBaseCurrency As String
    Dim ExchangeRate As String
       
    Dim SrcCountry As String
    Dim DstCountry As String
      
    Dim SrcCurrencyCode As String
    Dim DstCurrencyCode As String
    Dim rstObj As New ADODB.Recordset
    Dim surcharge As String
    
    Dim Card_Accept_ID As String
    Dim RstCommand As ADODB.Command
    Dim RecSet As New ADODB.Recordset
    Dim DoesCountryExit As Boolean
   
    'Dim Sink_Key As String
    'Dim PostMsg As New PostBridgeISO8583
    Dim PostMsg As New PostBridgeISO8583
    Dim DState As Integer
    Dim RSP_Code As Variant
    Dim PIN_Val As Variant
    Dim Rsp As Variant
    Dim OutLetIndex As Integer
    Dim OutLetMode As Integer
    Dim DstNodeName As String
    Dim MessageSentIndicator As Integer
    Dim inComingFee As String
    Dim outGoingFee As String
    Dim AgentID As String
    Dim Status As Long
    Dim RecInstID As String
    Dim strSQL As String
    Dim MsgSentIndicator As Integer
    MsgSentIndicator = 0
    With PostMsg
        .ISO8583MsgBD StrPostMessage
        .ResetBitMaps
        
       
        Trace = "Message type: " & .MessageTypeID & vbNewLine
        AmtBaseCurrency = "000000000000"
        If .MessageTypeID = "0200" Or .MessageTypeID = "0420" Or .MessageTypeID = "0421" Then
          .AdditionalData = Source_Key
          .CardAcceptorTermId = "40002650"
           Msisdn = .AccIdOne
           Msisdn2 = .AccIdTwo
           
           If .ProcessingCODE = "01" Then
           
                Agent_Number = .AdditionalRespData
                If Agent_Number = "ATM" Then
                    
                ElseIf Agent_Number = "AGENT" Then
                
                End If
              
               ATM_Authcode = .AuthIdResp
               
           End If
           
           Dim DstCountryCode As String
           
           AmntSrcCurr = .AmtTransaction
           SrcCurrencyCode = .CurrencyCodeTxn
           DstCountryCode = .ReceivingInstIdCode
           SrcCountry = .AcquiringInstIdCode
           
           DoesCountryExit = True
           
           If DstCountryCode <> "" And SrcCountry <> "" Then
           
           
           
                            .CurrencyCodeSettle = .CurrencyCodeTxn: .CreatePBBitMap (50)
                            .AmtTransaction = AmntDstCurr: .CreatePBBitMap (4)
                            .CurrencyCodeTxn = DstCurrencyCode: .CreatePBBitMap (49)
                            .AmtSettlement = AmntSrcCurr: .CreatePBBitMap (5)
                            .ConvRateSettle = Format(Val(ExchangeRate) * 100, "00000000"): .CreatePBBitMap (9)
                            .DateSettle = .DateLocTxn: .CreatePBBitMap (15)
                            .DateConversion = .DateLocTxn: .CreatePBBitMap (16)
                            
                            .CardAcceptorNameLoc = Left(.CardAcceptorNameLoc, 38) & Left(.CardAcceptorNameLoc, 2)
                 
                'Insert Record
                
                
                     Call CURRENCYPICK(.AcquiringInstIdCode, SrcCurrencyCode, inComingFee, DstCountryCode, ExchangeRate, DstCurrencyCode, outGoingFee, AmtBaseCurrency, DoesCountryExit)
                      
                           .AmtTxnFee = "D" & Right(outGoingFee, 8)
                     
                     Call AddAGENTTransaction(1, .Pan, .DateExpiry, .MessageTypeID, .ProcessingCODE, AmntSrcCurr, _
                                              .DatetimeTransmission, .SysTraceAuditNum, .TimeLocTxn, .DateLocTxn, .AcquiringInstIdCode, .RetrievalRefNum, _
                                              .CardAcceptorTermId, .CardAcceptorIdCode, .CardAcceptorNameLoc, SrcCurrencyCode, .EchoData, .AccIdOne, .AccIdTwo, .ReceivingInstIdCode, AgentID, AmntDstCurr, .ConvRateSettle, inComingFee, outGoingFee, .RetrievalRefNum, 1, AmtBaseCurrency, Status)
                                                        
                        If .PinData <> "" Then 'Determine if PIN translation is needed
                            If DstCountryCode <> "" And SrcCountry <> "" And .Pan <> "" Then
                            
                            End If
                        End If
                
                   Else
                
                     Call AddAGENTTransaction(99, .Pan, .DateExpiry, .MessageTypeID, .ProcessingCODE, .AmtTransaction, _
                                              .DatetimeTransmission, .SysTraceAuditNum, .TimeLocTxn, .DateLocTxn, .AcquiringInstIdCode, .RetrievalRefNum, _
                                              .CardAcceptorTermId, .CardAcceptorIdCode, .CardAcceptorNameLoc, .CurrencyCodeTxn, .EchoData, .AccIdOne, .AccIdTwo, .ReceivingInstIdCode, AgentID, "", .ConvRateSettle, Right(.AmtTxnFee, 8), "", .RetrievalRefNum, 1, AmtBaseCurrency, Status)
                                                        
                                                     
                     DoesCountryExit = False
                
                   End If
                            
        
        
                If DoesCountryExit = False Then 'return message
                   .MessageTypeID = "0210"
                   .RespCode = "92"
                   .AmtTransaction = AmntSrcCurr
                End If
           
           
        ElseIf .MessageTypeID = "0210" Then
             
              If .RespCode = "00" Then
                rstObj.Open "select * from em_agent_trans_1_a where ref_nr= '" & .RetrievalRefNum & "'", dbConnection
                    If rstObj.EOF = False Then
                      
                        .MessageTypeID = "0220"
                        .AmtTransaction = rstObj!amount_req
                        .ReceivingInstIdCode = rstObj!Rec_Inst_id
                        .AccIdOne = rstObj!Account_id1
                        .AccIdTwo = rstObj!Account_id2
                      
                        RecInstID = rstObj!Acq_inst_id
                        rstObj.Close
                        
                        strSQL = "select pindex, ip_address, port,mode,node_name from em_merchant_pos_index where bin_code = '" & RecInstID & "'"
                        rstObj.Open strSQL, dbConnection
                            
                            If rstObj.EOF = False Then
                                 OutLetIndex = rstObj!Pindex
                                 OutLetMode = rstObj!Mode
                                 DstNodeName = rstObj!Node_Name
                            Else
                                                         .RespCode = "91"
                             .MessageTypeID = "0420"
                                    
                             End If
                             rstObj.Close
                    Else
                        .RespCode = "92": .CreatePBBitMap (39)
                        .MessageTypeID = "0420"
                    End If
                Else
                
                dbConnection.Execute "update em_agent_trans_1_a set state = 99, resp_code = '" & .RespCode & "'  where ref_nr= '" & .RetrievalRefNum & "'"
                'Send resp back to USSD
                End If
           
                    
        End If
        
        
         If .Pan <> "" Then .CreatePBBitMap (2): Trace = Trace & "Field 002: " & .Pan & vbNewLine
         If .ProcessingCODE <> "" Then .CreatePBBitMap (3): Trace = Trace & "Field 003: " & .ProcessingCODE & vbNewLine
         If .AmtTransaction <> "" Then: .CreatePBBitMap (4): Trace = Trace & "Field 004: " & .AmtTransaction & vbNewLine
         If .AmtSettlement <> "" Then: .CreatePBBitMap (5): Trace = Trace & "Field 005: " & .AmtSettlement & vbNewLine
         If .DatetimeTransmission <> "" Then .CreatePBBitMap (7): Trace = Trace & "Field 007: " & .DatetimeTransmission & vbNewLine
         If .ConvRateSettle <> "" Then .CreatePBBitMap (9): Trace = Trace & "Field 009: " & .ConvRateSettle & vbNewLine
         If .SysTraceAuditNum <> "" Then .CreatePBBitMap (11): Trace = Trace & "Field 011: " & .SysTraceAuditNum & vbNewLine
         If .TimeLocTxn <> "" Then .CreatePBBitMap (12): Trace = Trace & "Field 012: " & .DateLocTxn & vbNewLine
         If .DateLocTxn <> "" Then .CreatePBBitMap (13): Trace = Trace & "Field 013: " & .TimeLocTxn & vbNewLine
         If .DateExpiry <> "" Then .CreatePBBitMap (14): Trace = Trace & "Field 014: " & .DateExpiry & vbNewLine
         If .DateSettle <> "" Then .CreatePBBitMap (15): Trace = Trace & "Field 015: " & .DateSettle & vbNewLine
         If .DateConversion <> "" Then .CreatePBBitMap (16): Trace = Trace & "Field 016: " & .DateConversion & vbNewLine
         If .MerchantType <> "" Then .CreatePBBitMap (18): Trace = Trace & "Field 018: " & .MerchantType & vbNewLine
         If .POSEntryMode <> "" Then .CreatePBBitMap (22): Trace = Trace & "Field 022: " & .POSEntryMode & vbNewLine
         If .CardSeqNum <> "" Then .CreatePBBitMap (23): Trace = Trace & "Field 023: " & .CardSeqNum & vbNewLine
         If .POSConditionCode <> "" Then .CreatePBBitMap (25): Trace = Trace & "Field 025: " & .POSConditionCode & vbNewLine
         If .POSPinCaptureCode <> "" Then .CreatePBBitMap (26): Trace = Trace & "Field 026: " & .POSPinCaptureCode & vbNewLine
'         If .AmtTxnFee <> "" Then .CreatePBBitMap (28): Trace = Trace & "Field 028: " & .AmtTxnFee & vbNewLine
'         If .AmtTxnProcessingFee <> "" Then .CreatePBBitMap (30): Trace = Trace & "Field 030: " & .AmtTxnProcessingFee & vbNewLine
         If .AcquiringInstIdCode <> "" Then .CreatePBBitMap (32): Trace = Trace & "Field 032: " & .AcquiringInstIdCode & vbNewLine
         If .ForwardingInstIdCode <> "" Then .CreatePBBitMap (33): Trace = Trace & "Field 033: " & .ForwardingInstIdCode & vbNewLine
         If .Track2Data <> "" Then .CreatePBBitMap (35): Trace = Trace & "Field 035: " & .Track2Data & vbNewLine
         If .RetrievalRefNum <> "" Then .CreatePBBitMap (37): Trace = Trace & "Field 037: " & .RetrievalRefNum & vbNewLine
         If .AuthIdResp <> "" Then .CreatePBBitMap (38): Trace = Trace & "Field 038: " & .AuthIdResp & vbNewLine
         If .RespCode <> "" Then .CreatePBBitMap (39): Trace = Trace & "Field 039: " & .RespCode & vbNewLine
         If .ServiceRestrictionCode <> "" Then .CreatePBBitMap (40): Trace = Trace & "Field 040: " & .ServiceRestrictionCode & vbNewLine
         If .CardAcceptorTermId <> "" Then .CreatePBBitMap (41): Trace = Trace & "Field 041: " & .CardAcceptorTermId & vbNewLine
         If .CardAcceptorIdCode <> "" Then .CreatePBBitMap (42): Trace = Trace & "Field 042: " & .CardAcceptorIdCode & vbNewLine
         If .CardAcceptorNameLoc <> "" Then .CreatePBBitMap (43): Trace = Trace & "Field 043: " & .CardAcceptorNameLoc & vbNewLine
         If .AdditionalRespData <> "" Then .CreatePBBitMap (44):: Trace = Trace & "Field 044: " & .AdditionalRespData & vbNewLine
         If .AdditionalData <> "" Then .CreatePBBitMap (48): Trace = Trace & "Field 048: " & .AdditionalData & vbNewLine
         If .CurrencyCodeTxn <> "" Then .CreatePBBitMap (49): Trace = Trace & "Field 049: " & .CurrencyCodeTxn & vbNewLine
         If .CurrencyCodeSettle <> "" Then .CreatePBBitMap (50): Trace = Trace & "Field 050: " & .CurrencyCodeSettle & vbNewLine
         
         '.PinData = "0123456789ABCDEF": .CreatePBBitMap (52): Trace = Trace & "Field 052: " & "****************" & vbNewLine
         If .AdditionalAmts <> "" Then .CreatePBBitMap (54): Trace = Trace & "Field 054: " & .AdditionalAmts & vbNewLine
         If .MsgReasonCode <> "" Then .CreatePBBitMap (56): Trace = Trace & "Field 056: " & .MsgReasonCode & vbNewLine
         If .EchoData <> "" Then .CreatePBBitMap (59): Trace = Trace & "Field 059: " & .EchoData & vbNewLine
         If .NetMangtInfoCode <> "" Then .CreatePBBitMap (70): Trace = Trace & "Field 070: " & .NetMangtInfoCode & vbNewLine
         If .OriginalDataElements <> "" Then .CreatePBBitMap (90): Trace = Trace & "Field 090: " & .OriginalDataElements & vbNewLine
         If .ReplacementAmts <> "" Then .CreatePBBitMap (95): Trace = Trace & "Field 095: " & .ReplacementAmts & vbNewLine
         If .ReceivingInstIdCode <> "" Then .CreatePBBitMap (100): Trace = Trace & "Field 100: " & .ReceivingInstIdCode & vbNewLine
         If .AccIdOne <> "" Then .CreatePBBitMap (102): Trace = Trace & "Field 102: " & .AccIdOne & vbNewLine
         If .AccIdTwo <> "" Then .CreatePBBitMap (103): Trace = Trace & "Field 103: " & .AccIdTwo
         
                
         

                        StrMessage = .CREATEMsgISO8538
                        Set PostMsg = Nothing
                        

          SendMessageToPostilion StrMessage, MsgSentIndicator
          
          
          
          If .MessageTypeID = "0210" Or .RespCode <> "00" Then
              SendMessageToMobileApp StrMessage, 0
              Exit Sub
          ElseIf .MessageTypeID = "0420" Then  'Request Message to Sink
          
          
          ElseIf .MessageTypeID = "0220" Then  'Request Message to Sink
           
           
                If OutLetIndex <> 0 And OutLetMode = 1 Then
                   SendMessageToSwitch StrMessage, OutLetIndex, MessageSentIndicator
                ElseIf OutLetIndex <> 0 And OutLetMode = 0 Then
                   SendMessageToMerchant StrMessage, GetIndexOut(OutLetIndex), MessageSentIndicator
                End If
                   
               
                If MessageSentIndicator = 1 Then
                  Dim Timer_Number As Integer
                  SendMessageToPostilion StrMessage, MsgSentIndicator 'forward message
                  
                  
                  Timer_Number = GetTranTimerIndex
                  TransTimers(Timer_Number) = 1
                  Load TransTmr(Timer_Number)
                  TransTmr(Timer_Number).Tag = .RetrievalRefNum
                  TransTmr(Timer_Number).Enabled = True
                                  
                Else
                   
                    dbConnection.Execute "update em_agent_trans_1_a set state = 99, resp_code = '91' where ref_nr = '" & .RetrievalRefNum & "'"
                
                    .MessageTypeID = "0210"
                    .RespCode = "91": .CreatePBBitMap (39)
                    StrMessage = .CREATEMsgISO8538
                    SendMessageToMobileApp StrMessage, 0
                  
                End If
           
           End If
        
          
          
          
          
          
         If MsgSentIndicator = 1 Then
           If Trace_Flag = 1 And Interchange = FrmTrace.Combo1.List(FrmTrace.Combo1.ListIndex) Then
             FrmTrace.Text1 = FrmTrace.Text1 & vbNewLine & "Message from " & Interchange & vbNewLine & StrPostMessage
             FrmTrace.Text1 = FrmTrace.Text1 & vbNewLine & Trace
             FrmTrace.Text1 = FrmTrace.Text1 & vbNewLine & "Message sent to Data Server." & vbNewLine
          
          End If
          
          Else
          
           If Trace_Flag = 1 And Interchange = FrmTrace.Combo1.List(FrmTrace.Combo1.ListIndex) Then
             FrmTrace.Text1 = FrmTrace.Text1 & vbNewLine & "Message from " & Interchange & vbNewLine & StrPostMessage
             FrmTrace.Text1 = FrmTrace.Text1 & vbNewLine & Trace
             FrmTrace.Text1 = FrmTrace.Text1 & vbNewLine & "Data Server offline. Message could not be sent." & vbNewLine
           End If
          
         End If
         
       
        End With
        
        
        'Determine ASA Port to send message
        
                
 Exit Sub
            
ErrorTrap:
txt_log.Text = txt_log.Text & vbNewLine & "Process ProcessMerchantMessage " & err.Description
EventsTrap = err.Description
                        
  
End Sub

Private Sub ProcessMerchantMessage0430(ByVal StrPostMessage As String, ByVal Source_Key As String, ByVal Interchange As String)
    Dim StrMessage As String
    On Error GoTo ErrorTrap
    Dim Trace As String
    
    Dim MsgSentIndicator As Integer
    MsgSentIndicator = 0
    Dim PostMsg As New PostBridgeISO8583
    With PostMsg
        .ISO8583MsgBD StrPostMessage
        .ResetBitMaps
        
        Trace = "Message From " & Interchange
        Trace = Trace & vbNewLine & .MessageTypeID
        
        dbConnection.Execute "update em_agent_trans_1_a set state = 99, resp_code_rev = '" & .RespCode & "'  where ref_nr= '" & .RetrievalRefNum & "'"
                'Send resp back to USSD
                 
         If .Pan <> "" Then .CreatePBBitMap (2): Trace = Trace & "Field 002: " & .Pan & vbNewLine
         If .ProcessingCODE <> "" Then .CreatePBBitMap (3): Trace = Trace & "Field 003: " & .ProcessingCODE & vbNewLine
         If .AmtTransaction <> "" Then: .CreatePBBitMap (4): Trace = Trace & "Field 004: " & .AmtTransaction & vbNewLine
         If .AmtSettlement <> "" Then: .CreatePBBitMap (5): Trace = Trace & "Field 005: " & .AmtSettlement & vbNewLine
         If .DatetimeTransmission <> "" Then .CreatePBBitMap (7): Trace = Trace & "Field 007: " & .DatetimeTransmission & vbNewLine
         If .ConvRateSettle <> "" Then .CreatePBBitMap (9): Trace = Trace & "Field 009: " & .ConvRateSettle & vbNewLine
         If .SysTraceAuditNum <> "" Then .CreatePBBitMap (11): Trace = Trace & "Field 011: " & .SysTraceAuditNum & vbNewLine
         If .TimeLocTxn <> "" Then .CreatePBBitMap (12): Trace = Trace & "Field 012: " & .DateLocTxn & vbNewLine
         If .DateLocTxn <> "" Then .CreatePBBitMap (13): Trace = Trace & "Field 013: " & .TimeLocTxn & vbNewLine
         If .DateExpiry <> "" Then .CreatePBBitMap (14): Trace = Trace & "Field 014: " & .DateExpiry & vbNewLine
         If .DateSettle <> "" Then .CreatePBBitMap (15): Trace = Trace & "Field 015: " & .DateSettle & vbNewLine
         If .DateConversion <> "" Then .CreatePBBitMap (16): Trace = Trace & "Field 016: " & .DateConversion & vbNewLine
         If .MerchantType <> "" Then .CreatePBBitMap (18): Trace = Trace & "Field 018: " & .MerchantType & vbNewLine
         If .POSEntryMode <> "" Then .CreatePBBitMap (22): Trace = Trace & "Field 022: " & .POSEntryMode & vbNewLine
         If .CardSeqNum <> "" Then .CreatePBBitMap (23): Trace = Trace & "Field 023: " & .CardSeqNum & vbNewLine
         If .POSConditionCode <> "" Then .CreatePBBitMap (25): Trace = Trace & "Field 025: " & .POSConditionCode & vbNewLine
         If .POSPinCaptureCode <> "" Then .CreatePBBitMap (26): Trace = Trace & "Field 026: " & .POSPinCaptureCode & vbNewLine
'         If .AmtTxnFee <> "" Then .CreatePBBitMap (28): Trace = Trace & "Field 028: " & .AmtTxnFee & vbNewLine
'         If .AmtTxnProcessingFee <> "" Then .CreatePBBitMap (30): Trace = Trace & "Field 030: " & .AmtTxnProcessingFee & vbNewLine
         If .AcquiringInstIdCode <> "" Then .CreatePBBitMap (32): Trace = Trace & "Field 032: " & .AcquiringInstIdCode & vbNewLine
         If .ForwardingInstIdCode <> "" Then .CreatePBBitMap (33): Trace = Trace & "Field 033: " & .ForwardingInstIdCode & vbNewLine
         If .Track2Data <> "" Then .CreatePBBitMap (35): Trace = Trace & "Field 035: " & .Track2Data & vbNewLine
         If .RetrievalRefNum <> "" Then .CreatePBBitMap (37): Trace = Trace & "Field 037: " & .RetrievalRefNum & vbNewLine
         If .AuthIdResp <> "" Then .CreatePBBitMap (38): Trace = Trace & "Field 038: " & .AuthIdResp & vbNewLine
         If .RespCode <> "" Then .CreatePBBitMap (39): Trace = Trace & "Field 039: " & .RespCode & vbNewLine
         If .ServiceRestrictionCode <> "" Then .CreatePBBitMap (40): Trace = Trace & "Field 040: " & .ServiceRestrictionCode & vbNewLine
         If .CardAcceptorTermId <> "" Then .CreatePBBitMap (41): Trace = Trace & "Field 041: " & .CardAcceptorTermId & vbNewLine
         If .CardAcceptorIdCode <> "" Then .CreatePBBitMap (42): Trace = Trace & "Field 042: " & .CardAcceptorIdCode & vbNewLine
         If .CardAcceptorNameLoc <> "" Then .CreatePBBitMap (43): Trace = Trace & "Field 043: " & .CardAcceptorNameLoc & vbNewLine
         If .AdditionalRespData <> "" Then .CreatePBBitMap (44):: Trace = Trace & "Field 044: " & .AdditionalRespData & vbNewLine
         If .AdditionalData <> "" Then .CreatePBBitMap (48): Trace = Trace & "Field 048: " & .AdditionalData & vbNewLine
         If .CurrencyCodeTxn <> "" Then .CreatePBBitMap (49): Trace = Trace & "Field 049: " & .CurrencyCodeTxn & vbNewLine
         If .CurrencyCodeSettle <> "" Then .CreatePBBitMap (50): Trace = Trace & "Field 050: " & .CurrencyCodeSettle & vbNewLine
         
         '.PinData = "0123456789ABCDEF": .CreatePBBitMap (52): Trace = Trace & "Field 052: " & "****************" & vbNewLine
         If .AdditionalAmts <> "" Then .CreatePBBitMap (54): Trace = Trace & "Field 054: " & .AdditionalAmts & vbNewLine
         If .MsgReasonCode <> "" Then .CreatePBBitMap (56): Trace = Trace & "Field 056: " & .MsgReasonCode & vbNewLine
         If .EchoData <> "" Then .CreatePBBitMap (59): Trace = Trace & "Field 059: " & .EchoData & vbNewLine
         If .NetMangtInfoCode <> "" Then .CreatePBBitMap (70): Trace = Trace & "Field 070: " & .NetMangtInfoCode & vbNewLine
         If .OriginalDataElements <> "" Then .CreatePBBitMap (90): Trace = Trace & "Field 090: " & .OriginalDataElements & vbNewLine
         If .ReplacementAmts <> "" Then .CreatePBBitMap (95): Trace = Trace & "Field 095: " & .ReplacementAmts & vbNewLine
         If .ReceivingInstIdCode <> "" Then .CreatePBBitMap (100): Trace = Trace & "Field 100: " & .ReceivingInstIdCode & vbNewLine
         If .AccIdOne <> "" Then .CreatePBBitMap (102): Trace = Trace & "Field 102: " & .AccIdOne & vbNewLine
         If .AccIdTwo <> "" Then .CreatePBBitMap (103): Trace = Trace & "Field 103: " & .AccIdTwo
         
                
         

          StrMessage = .CREATEMsgISO8538
                       

          SendMessageToPostilion StrMessage, MsgSentIndicator
        
          
        If Trace_Flag = 1 And Interchange = FrmTrace.Combo1.List(FrmTrace.Combo1.ListIndex) Then
          FrmTrace.Text1 = FrmTrace.Text1 & vbNewLine & "Message from " & Interchange & vbNewLine & StrPostMessage
          FrmTrace.Text1 = FrmTrace.Text1 & vbNewLine & Trace
          FrmTrace.Text1 = FrmTrace.Text1 & vbNewLine & "Data Server offline. Message could not be sent." & vbNewLine
        End If
               
        End With
        
        
        'Determine ASA Port to send message
        
                
 Exit Sub
            
ErrorTrap:
txt_log.Text = txt_log.Text & vbNewLine & "Process ProcessMerchantMessage " & err.Description
EventsTrap = err.Description
                        
  
End Sub
''''''''DATA COMING FROM MERCHANT TO PAYSERV BRIDGE TO SWITCH''''''''''''''''''''''''''
'       message is receieved at postbridge port                             '
'         The mesage is process into ZAP format and send                    '

     '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
Private Sub ProcessUSSDMessage(ByVal StrPostMessage As String, ByVal Source_Key As String, ByVal Interchange As String)
   Dim StrMessage As String
    On Error GoTo ErrorTrap
    Dim Trace As String
   
    Dim AmntSrcCurr As String
    Dim AmntDstCurr As String
    Dim ExchangeRate As String
    Dim AmtBaseCurrency As String
    Dim AmtBaseFeeCurrency As String
    Dim SrcCountry As String
    Dim DstCountry As String
      
    Dim SrcCurrencyCode As String
    Dim DstCurrencyCode As String
    
    Dim surcharge As String
    
    Dim Card_Accept_ID As String
    Dim RstCommand As ADODB.Command
    Dim RecSet As New ADODB.Recordset
    
    Dim PostMsg As New PostBridgeISO8583
    Dim DState As Integer
    Dim RSP_Code As Variant
    Dim PIN_Val As Variant
    Dim Rsp As Variant
    Dim Status As Long
    Dim MsgSentIndicator As Integer
    
    
    Dim DstCountryCode As String
    Dim RecsetE As New ADODB.Recordset
    Dim RecsetC As New ADODB.Recordset
    Dim AgentAccount As String
    Dim AgentCommissionAccount As String
    Dim AgentID As String
    Dim ExciseTax As String
    Dim WithHoldingTax As String
    Dim inComingFee As String
    Dim outGoingFee As String
    Dim CommissionDueFBL As String
    Dim CustomerPhone As String
    Dim AmountAtransaction As Double
    
    Dim DoesCountryExit As Boolean
    DoesCountryExit = False
    
    
    Dim RecInstID As String
    Dim rstObj As ADODB.Recordset
    Dim strSQL As String
    Set rstObj = New ADODB.Recordset
    Dim OutLetIndex As Integer
    Dim OutLetMode As Integer
    Dim DstNodeName As Variant
    Dim ProcEvents As String
    Dim StrMsgToSend As String
    Dim MessageSentIndicator As Integer
    Dim Debit As Integer
    Dim IndexKey As Integer
    Dim SessionID As Variant
    Dim TranRefnumber As Variant
    Dim OriginalTranNumber As Variant
      
    MsgSentIndicator = 0
    AmtBaseCurrency = "000000000000"
       IndexKey = Left(Source_Key, InStr(1, Source_Key, "_", vbTextCompare) - 1)
    With PostMsg
        .ISO8583MsgBD StrPostMessage
        .ResetBitMaps
        
        Trace = "Message type: " & .MessageTypeID & vbNewLine
        
        
        If Left(.ProcessingCODE, 2) = "21" Or Left(.ProcessingCODE, 2) = "31" Or Left(.ProcessingCODE, 2) = "42" Then    'Debit
                 Debit = 0
        ElseIf Left(.ProcessingCODE, 2) = "00" Or Left(.ProcessingCODE, 2) = "01" Then
                 Debit = 0
        ElseIf Left(.ProcessingCODE, 2) = "32" Then
                Debit = 1
        End If
        
        SessionID = .SessionID
        TranRefnumber = .TranRefnumber 'new changes
        OriginalTranNumber = .OriginalTranRefnumber
        
        If .MessageTypeID = "0200" Or .MessageTypeID = "0420" Or .MessageTypeID = "0421" Then
          .CardAcceptorTermId = Right(.Pan, 8)
           AmntSrcCurr = .AmtTransaction
           SrcCurrencyCode = .CurrencyCodeTxn
           DstCountryCode = .ReceivingInstIdCode
           SrcCountry = .AcquiringInstIdCode
           
           
           inComingFee = Right(.AmtTxnFee, 8)
           
           'Does Countries Exists
           'DstCountryCode (customer country)
           'SrcCountry (Second party country or agent country)
           
           SrcCurrencyCode = SrcCountry
        
                 If DstCountryCode <> "" And SrcCountry <> "" Then
                  
                    If Left(.ProcessingCODE, 2) = 32 Or .MessageTypeID = "0420" Or .MessageTypeID = "0421" Then  'New change for forex
                    
                     Call CURRENCYPICK(SrcCountry, SrcCurrencyCode, AmntSrcCurr, DstCountryCode, ExchangeRate, DstCurrencyCode, AmntDstCurr, AmtBaseCurrency, DoesCountryExit)
                 
                            .CurrencyCodeSettle = .CurrencyCodeTxn: .CreatePBBitMap (50)
                            .CurrencyCodeTxn = DstCurrencyCode: .CreatePBBitMap (49)
                            .ConvRateSettle = Format(Val(ExchangeRate) * 100, "00000000"): .CreatePBBitMap (9)
                            .DateSettle = .DateLocTxn: .CreatePBBitMap (15)
                            .DateConversion = .DateLocTxn: .CreatePBBitMap (16)
                            
                            .CardAcceptorNameLoc = Left(.CardAcceptorNameLoc, 38) & Left(.CardAcceptorNameLoc, 2)
                            
'                              Call CURRENCYPICK(.AcquiringInstIdCode, SrcCurrencyCode, inComingFee, DstCountryCode, ExchangeRate, DstCurrencyCode, outGoingFee, AmtBaseFeeCurrency, DoesCountryExit)
'
'                             .AmtTxnFee = "D" & Right(outGoingFee, 8)
                    Else
                           
                           strSQL = "select amount_req, amount_base,conversion_rate from em_agent_trans_1_a where acq_inst_id = '" & .AcquiringInstIdCode & "' and second_ref_nr = '" & SessionID & "' and rec_inst_id = '" & .ReceivingInstIdCode & "'"
                           rstObj.Open strSQL, dbConnection
                            
                            If rstObj.EOF = False Then
                                 AmntSrcCurr = rstObj!amount_req
                                 AmtBaseCurrency = rstObj!amount_base
                                .ConvRateSettle = rstObj!conversion_rate
                                 AmntDstCurr = .AmtTransaction
                                 DoesCountryExit = True
                                 rstObj.Close
                            Else
                                Call AddAGENTTransaction(99, .Pan, .DateExpiry, .MessageTypeID, .ProcessingCODE, .AmtTransaction, _
                                            .DatetimeTransmission, .SysTraceAuditNum, .TimeLocTxn, .DateLocTxn, .AcquiringInstIdCode, .RetrievalRefNum, _
                                            .CardAcceptorTermId, .CardAcceptorIdCode, .CardAcceptorNameLoc, .CurrencyCodeTxn, .EchoData, .AccIdOne, .AccIdTwo, .ReceivingInstIdCode, AgentID, "", .ConvRateSettle, Right(.AmtTxnFee, 8), "", .RetrievalRefNum, IndexKey, AmtBaseCurrency, Status)
                                                        
                                                     
                               DoesCountryExit = False
                               rstObj.Close
                               GoTo routeError
                               
                            End If
                            
                    End If
                     
                    
                                        
                     Call AddAGENTTransaction(1, .Pan, .DateExpiry, .MessageTypeID, .ProcessingCODE, AmntSrcCurr, _
                                              .DatetimeTransmission, .SysTraceAuditNum, .TimeLocTxn, .DateLocTxn, .AcquiringInstIdCode, TranRefnumber, _
                                              .CardAcceptorTermId, .CardAcceptorIdCode, .CardAcceptorNameLoc, SrcCurrencyCode, .EchoData, .AccIdOne, .AccIdTwo, .ReceivingInstIdCode, AgentID, Left(AmntDstCurr, 10) & "00", .ConvRateSettle, inComingFee, outGoingFee, SessionID, IndexKey, AmtBaseCurrency, Status)
                                                        
                        
                     If Debit = 1 Then  'currency request (32)
                        .AmtTransaction = AmntSrcCurr: .CreatePBBitMap (4)
                        .AmtSettlement = Left(AmntDstCurr, 10) & "00": .CreatePBBitMap (5)
                        
                     ElseIf Debit = 0 Then  'debit (00,01,42)
                       .AmtTransaction = Left(AmntDstCurr, 10) & "00": .CreatePBBitMap (4)
                       .AmtSettlement = AmntSrcCurr: .CreatePBBitMap (5)
                     End If
                        
                            If .PinData <> "" Then 'Determine if PIN translation is needed
                                If DstCountryCode <> "" And SrcCountry <> "" And .Pan <> "" Then
                                
                                End If
                            End If
                
                   Else
                
                     Call AddAGENTTransaction(99, .Pan, .DateExpiry, .MessageTypeID, .ProcessingCODE, .AmtTransaction, _
                                              .DatetimeTransmission, .SysTraceAuditNum, .TimeLocTxn, .DateLocTxn, .AcquiringInstIdCode, .RetrievalRefNum, _
                                              .CardAcceptorTermId, .CardAcceptorIdCode, .CardAcceptorNameLoc, .CurrencyCodeTxn, .EchoData, .AccIdOne, .AccIdTwo, .ReceivingInstIdCode, AgentID, "", .ConvRateSettle, Right(.AmtTxnFee, 8), "", .RetrievalRefNum, IndexKey, AmtBaseCurrency, Status)
                                                        
                                                     
                     DoesCountryExit = False
                
                 End If
                 
        End If
        
        If Status < 1 Then
           .MessageTypeID = "0210"
           .RespCode = "96"
           .AmtTransaction = AmntSrcCurr
        End If
routeError:
        If DoesCountryExit = False Then 'return message
           .MessageTypeID = "0210"
           .RespCode = "92"
           .AmtTransaction = AmntSrcCurr
        End If
        
        
        
        
         If .Pan <> "" Then .CreatePBBitMap (2): Trace = Trace & "Field 002: " & .Pan & vbNewLine
         If .ProcessingCODE <> "" Then .CreatePBBitMap (3): Trace = Trace & "Field 003: " & .ProcessingCODE & vbNewLine
         If .AmtTransaction <> "" Then: .CreatePBBitMap (4): Trace = Trace & "Field 004: " & .AmtTransaction & vbNewLine
         If .AmtSettlement <> "" Then: .CreatePBBitMap (5): Trace = Trace & "Field 005: " & .AmtSettlement & vbNewLine
         If .DatetimeTransmission <> "" Then .CreatePBBitMap (7): Trace = Trace & "Field 007: " & .DatetimeTransmission & vbNewLine
         If .ConvRateSettle <> "" Then .CreatePBBitMap (9): Trace = Trace & "Field 009: " & .ConvRateSettle & vbNewLine
         If .SysTraceAuditNum <> "" Then .CreatePBBitMap (11): Trace = Trace & "Field 011: " & .SysTraceAuditNum & vbNewLine
         If .TimeLocTxn <> "" Then .CreatePBBitMap (12): Trace = Trace & "Field 012: " & .DateLocTxn & vbNewLine
         If .DateLocTxn <> "" Then .CreatePBBitMap (13): Trace = Trace & "Field 013: " & .TimeLocTxn & vbNewLine
         If .DateExpiry <> "" Then .CreatePBBitMap (14): Trace = Trace & "Field 014: " & .DateExpiry & vbNewLine
         If .DateSettle <> "" Then .CreatePBBitMap (15): Trace = Trace & "Field 015: " & .DateSettle & vbNewLine
         If .DateConversion <> "" Then .CreatePBBitMap (16): Trace = Trace & "Field 016: " & .DateConversion & vbNewLine
         If .MerchantType <> "" Then .CreatePBBitMap (18): Trace = Trace & "Field 018: " & .MerchantType & vbNewLine
         If .POSEntryMode <> "" Then .CreatePBBitMap (22): Trace = Trace & "Field 022: " & .POSEntryMode & vbNewLine
         If .CardSeqNum <> "" Then .CreatePBBitMap (23): Trace = Trace & "Field 023: " & .CardSeqNum & vbNewLine
         If .POSConditionCode <> "" Then .CreatePBBitMap (25): Trace = Trace & "Field 025: " & .POSConditionCode & vbNewLine
         If .POSPinCaptureCode <> "" Then .CreatePBBitMap (26): Trace = Trace & "Field 026: " & .POSPinCaptureCode & vbNewLine
         If .AmtTxnFee <> "" Then .CreatePBBitMap (28): Trace = Trace & "Field 028: " & .AmtTxnFee & vbNewLine
         If .AmtTxnProcessingFee <> "" Then .CreatePBBitMap (30): Trace = Trace & "Field 030: " & .AmtTxnProcessingFee & vbNewLine
         If .AcquiringInstIdCode <> "" Then .CreatePBBitMap (32): Trace = Trace & "Field 032: " & .AcquiringInstIdCode & vbNewLine
         If .ForwardingInstIdCode <> "" Then .CreatePBBitMap (33): Trace = Trace & "Field 033: " & .ForwardingInstIdCode & vbNewLine
         If .Track2Data <> "" Then .CreatePBBitMap (35): Trace = Trace & "Field 035: " & .Track2Data & vbNewLine
         If .RetrievalRefNum <> "" Then .CreatePBBitMap (37): Trace = Trace & "Field 037: " & .RetrievalRefNum & vbNewLine
         If .AuthIdResp <> "" Then .CreatePBBitMap (38): Trace = Trace & "Field 038: " & .AuthIdResp & vbNewLine
         If .RespCode <> "" Then .CreatePBBitMap (39): Trace = Trace & "Field 039: " & .RespCode & vbNewLine
         If .ServiceRestrictionCode <> "" Then .CreatePBBitMap (40): Trace = Trace & "Field 040: " & .ServiceRestrictionCode & vbNewLine
         If .CardAcceptorTermId <> "" Then .CreatePBBitMap (41): Trace = Trace & "Field 041: " & .CardAcceptorTermId & vbNewLine
         If .CardAcceptorIdCode <> "" Then .CreatePBBitMap (42): Trace = Trace & "Field 042: " & .CardAcceptorIdCode & vbNewLine
         If .CardAcceptorNameLoc <> "" Then .CreatePBBitMap (43): Trace = Trace & "Field 043: " & .CardAcceptorNameLoc & vbNewLine
         If .AdditionalRespData <> "" Then .CreatePBBitMap (44):: Trace = Trace & "Field 044: " & .AdditionalRespData & vbNewLine
         If .AdditionalData <> "" Then .CreatePBBitMap (48): Trace = Trace & "Field 048: " & .AdditionalData & vbNewLine
         If .CurrencyCodeTxn <> "" Then .CreatePBBitMap (49): Trace = Trace & "Field 049: " & .CurrencyCodeTxn & vbNewLine
         If .CurrencyCodeSettle <> "" Then .CreatePBBitMap (50): Trace = Trace & "Field 050: " & .CurrencyCodeSettle & vbNewLine
          '.PinData = "0123456789ABCDEF": .CreatePBBitMap (52): Trace = Trace & "Field 052: " & "****************" & vbNewLine
         If .AdditionalAmts <> "" Then .CreatePBBitMap (54): Trace = Trace & "Field 054: " & .AdditionalAmts & vbNewLine
         If .MsgReasonCode <> "" Then .CreatePBBitMap (56): Trace = Trace & "Field 056: " & .MsgReasonCode & vbNewLine
         
         .EchoData = Format(Status, "0000000000"): .CreatePBBitMap (59): Trace = Trace & "Field 059: " & .EchoData & vbNewLine
         If .OriginalTranRefnumber <> "" Then .CreatePBBitMap (60):  Trace = Trace & "Field 060: " & .OriginalDataElements & vbNewLine
         If .SessionID <> "" Then .CreatePBBitMap (61):  Trace = Trace & "Field 061: " & .SessionID & vbNewLine
         If .TranRefnumber <> "" Then .CreatePBBitMap (62):  Trace = Trace & "Field 062: " & .TranRefnumber & vbNewLine
         If .NetMangtInfoCode <> "" Then .CreatePBBitMap (70): Trace = Trace & "Field 070: " & .NetMangtInfoCode & vbNewLine
         If .OriginalDataElements <> "" Then .CreatePBBitMap (90): Trace = Trace & "Field 090: " & .OriginalDataElements & vbNewLine
         If .ReplacementAmts <> "" Then .CreatePBBitMap (95): Trace = Trace & "Field 095: " & .ReplacementAmts & vbNewLine
         If .Payee <> "" Then .CreatePBBitMap (98): Trace = Trace & "Field 098: " & .Payee & vbNewLine
         If .ReceivingInstIdCode <> "" Then .CreatePBBitMap (100): Trace = Trace & "Field 100: " & .ReceivingInstIdCode & vbNewLine
         If .AccIdOne <> "" Then .CreatePBBitMap (102): Trace = Trace & "Field 102: " & .AccIdOne & vbNewLine
         If .AccIdTwo <> "" Then .CreatePBBitMap (103): Trace = Trace & "Field 103: " & .AccIdTwo
         
                
                
         

         StrMessage = .CREATEMsgISO8538
         
         If List1.ListCount < 20 Then
         List1.AddItem "INCOMING REQ: CUST 1" & .AccIdOne & " CUST 2:" & .AccIdTwo & " TRAN: " & Left(.ProcessingCODE, 2) & " AMT: " & Val(.AmtTransaction) / 100 & " CURNCY: " & .CurrencyCodeTxn, 0
         
         Else
         List1.RemoveItem (19)
         List1.AddItem "INCOMING REQ: CUST 1:" & .AccIdOne & " CUST 2:" & .AccIdTwo & " TRAN: " & Left(.ProcessingCODE, 2) & " AMT: " & Val(.AmtTransaction) / 100 & " CURNCY: " & .CurrencyCodeTxn, 0
         
         End If
         
         If Trace_Flag = 1 Then
                  FrmTrace.Text1 = FrmTrace.Text1 & vbNewLine & "Message from WebService Source" & vbNewLine & StrMsgToSend
                  FrmTrace.Text1 = FrmTrace.Text1 & vbNewLine & Trace
         End If
         
        If .MessageTypeID = "0800" Then 'return message
          .MessageTypeID = "0810"
          .RespCode = "00": .CreatePBBitMap (39)
           StrMessage = .CREATEMsgISO8538
           SendMessageToMobileApp StrMessage, IndexKey
           Exit Sub
        End If
                        
        If Left(.ProcessingCODE, 2) = "32" Then 'return message
          .MessageTypeID = "0210"
          .RespCode = "00": .CreatePBBitMap (39)
           StrMessage = .CREATEMsgISO8538
           SendMessageToMobileApp StrMessage, IndexKey
           Exit Sub
        End If
                        
        If DoesCountryExit = False Then 'return message
           strSQL = "select pindex, ip_address, port,mode,node_name from em_merchant_pos_index where bin_code = '" & .AcquiringInstIdCode & "'"
                    rstObj.Open strSQL, dbConnection
                     
                            .RespCode = "92": .CreatePBBitMap (39)
                            .MessageTypeID = "0210"
                            StrMessage = .CREATEMsgISO8538
'                            If rstObj.EOF = False Then
'
'                                 OutLetIndex = rstObj!Pindex
'                                 OutLetMode = rstObj!Mode
'                                 DstNodeName = rstObj!Node_Name
'
'                                 If OutLetIndex <> 0 And OutLetMode = 1 Then
'                                   SendMessageToSwitch strMessage, OutLetIndex, MessageSentIndicator
'                                 ElseIf OutLetIndex <> 0 And OutLetMode = 0 Then
'                                   SendMessageToMerchant strMessage, IndexKey, MessageSentIndicator 'GetIndexOut(OutLetIndex)
'                                 End If
'
'                            End If
'                            rstObj.Close
    
    
    SendMessageToMobileApp StrMessage, IndexKey
           dbConnection.Execute "update em_agent_trans_1_a set state = 99, resp_code = '92' where tran_nr = '" & Status & "'"
           Exit Sub
        End If
            'Determine Routing;;;;;;
            
                        
         If .MessageTypeID = "0200" Or .MessageTypeID = "0221" Or .MessageTypeID = "0420" Or .MessageTypeID = "0421" Or .MessageTypeID = "0520" Or .MessageTypeID = "0521" Then
                     
                       If Debit = 0 Then
                       strSQL = "select pindex, ip_address, port,mode,node_name from em_merchant_pos_index where bin_code = '" & .ReceivingInstIdCode & "'"
                       ElseIf Debit = 1 Then
                       strSQL = "select pindex, ip_address, port,mode,node_name from em_merchant_pos_index where bin_code = '" & .AcquiringInstIdCode & "'"
                       End If
                       
                        rstObj.Open strSQL, dbConnection
                            
                            If rstObj.EOF = False Then
                                 OutLetIndex = rstObj!Pindex
                                 OutLetMode = rstObj!Mode
                                 DstNodeName = rstObj!Node_Name
                       
                                 
                            Else
                             'ProcEvents = "Transaction reference number:" & .RetrievalRefNum & " system trace audit number " & .SysTraceAuditNum & " cannot routed. Destination offline"
                                  .RespCode = "91": .CreatePBBitMap (39)
                                    
                                   dbConnection.Execute "update em_agent_trans_1_a set state = 99, resp_code = '91' where TRAN_NR = " & Status
                
                                    
                                    If .MessageTypeID = "0200" Then
                                    .MessageTypeID = "0210"
                                    ElseIf .MessageTypeID = "0420" Then
                                    .MessageTypeID = "0430"
                                    ElseIf .MessageTypeID = "0421" Then
                                    .MessageTypeID = "0430"
                                    ElseIf .MessageTypeID = "0520" Then
                                    .MessageTypeID = "0530"
                                    ElseIf .MessageTypeID = "0521" Then
                                    .MessageTypeID = "0530"
                                    End If
                                    
                                    StrMessage = .CREATEMsgISO8538
                                    
                                    
                             End If
                             rstObj.Close
                    Else
                        ProcEvents = "Transaction reference number:" & .RetrievalRefNum & " system trace audit number " & .SysTraceAuditNum & " cannot routed. No receiving institution ID"
                        .RespCode = "92": .CreatePBBitMap (39)
                        
                                    dbConnection.Execute "update em_agent_trans_1_a set state = 99, resp_code = '92' where tran_nr = " & Status
                                    
                                    If .MessageTypeID = "0200" Then
                                    .MessageTypeID = "0210"
                                    ElseIf .MessageTypeID = "0420" Then
                                    .MessageTypeID = "0430"
                                    If .MessageTypeID = "0421" Then
                                    .MessageTypeID = "0430"
                                    ElseIf .MessageTypeID = "0520" Then
                                    .MessageTypeID = "0530"
                                     ElseIf .MessageTypeID = "0521" Then
                                    .MessageTypeID = "0530"
                                    End If
                                    StrMessage = .CREATEMsgISO8538
                                    
                    End If
                              
                End If
                   
            
                 'Get Agent's Country Institution ID
                
           
           If .MessageTypeID = "0210" Or .MessageTypeID = "0430" Or .MessageTypeID = "0810" Then
              SendMessageToMobileApp StrMessage, IndexKey
              Exit Sub
           Else  '0200,0420,0421,0520      'Request Message to Sink
           
                 
           
           
                If OutLetIndex <> 0 And OutLetMode = 1 Then
                   SendMessageToSwitch StrMessage, OutLetIndex, MessageSentIndicator
                ElseIf OutLetIndex <> 0 And OutLetMode = 0 Then
                   SendMessageToMerchant StrMessage, GetIndexOut(OutLetIndex), MessageSentIndicator
                End If
                
               
                If MessageSentIndicator = 1 Then
                  Dim Timer_Number As Integer
                  SendMessageToPostilion StrMessage, MsgSentIndicator 'forward message
                  
                  
                  Timer_Number = GetTranTimerIndex
                  TransTimers(Timer_Number) = 1
                  Load TransTmr(Timer_Number)
                  TransTmr(Timer_Number).Tag = .EchoData
                  TransTmr(Timer_Number).Enabled = True
                  
                 
                  If Trace_Flag = 1 And DstNodeName = FrmTrace.Combo1.List(FrmTrace.Combo1.ListIndex) Then
                  FrmTrace.Text1 = FrmTrace.Text1 & vbNewLine & "Message To " & DstNodeName & vbNewLine & StrMsgToSend
                  FrmTrace.Text1 = FrmTrace.Text1 & vbNewLine & Trace
                  End If
                
                Else
                   
                    dbConnection.Execute "update em_agent_trans_1_a set state = 99, resp_code = '91' where tran_nr = " & Status
                
                    .MessageTypeID = "0210"
                    .RespCode = "91": .CreatePBBitMap (39)
                    StrMessage = .CREATEMsgISO8538
                    
                    SendMessageToMobileApp StrMessage, IndexKey
                    
'                     strSQL = "select pindex, ip_address, port,mode,node_name from em_merchant_pos_index where bin_code = '" & .AcquiringInstIdCode & "'"
'                     rstObj.Open strSQL, dbConnection
'
'
'                            If rstObj.EOF = False Then
'
'                                 OutLetIndex = rstObj!Pindex
'                                 OutLetMode = rstObj!Mode
'                                 DstNodeName = rstObj!Node_Name
'
'                                 If OutLetIndex <> 0 And OutLetMode = 1 Then
'                                   SendMessageToSwitch strMessage, OutLetIndex, MessageSentIndicator
'                                 ElseIf OutLetIndex <> 0 And OutLetMode = 0 Then
'                                   SendMessageToMerchant strMessage, GetIndexOut(OutLetIndex), MessageSentIndicator
'                                 End If
'
'                            End If
'                            rstObj.Close
'
                    Exit Sub
                    
                    
                  If Trace_Flag = 1 And DstNodeName = FrmTrace.Combo1.List(FrmTrace.Combo1.ListIndex) Then
                  FrmTrace.Text1 = FrmTrace.Text1 & vbNewLine & "Message to " & DstNodeName & vbNewLine & StrMsgToSend
                  FrmTrace.Text1 = FrmTrace.Text1 & vbNewLine & "Message to  " & DstNodeName & ".Interchange is offline."
                  
                  End If
                End If
           
             End If
        
        
        End With
        
        
        'Determine ASA Port to send message
        
                
 Exit Sub
            
ErrorTrap:
txt_log.Text = txt_log.Text & vbNewLine & "Process ProcessMerchantRequest " & err.Description
EventsTrap = err.Description
                        
  
End Sub

Public Sub GetTransactionDetails(ByVal Tran_nr As String)
    Dim RecSet As New ADODB.Recordset
    Dim rstObj As New ADODB.Recordset
    Dim tranNumber As Variant
    Dim Msg_type As Variant
    Dim Pan As Variant
    Dim Exp_date As Variant
    Dim Proc_code As Variant
    Dim Amount As Variant
    Dim Auth_code As Variant
    Dim Tran_datetime As Variant
    Dim Debit As Integer
    Dim poststring As String
    
    Dim PostZapmessage As New PostBridgeISO8583
    
    On Error GoTo error_handle
    
    RecSet.Open "select * from em_agent_trans_1_a where ref_nr = '" & Tran_nr & "'", dbConnection
      If RecSet.EOF = False Then
      
        If Left(RecSet!Proc_code, 2) = "21" Or Left(RecSet!Proc_code, 2) = "31" Or Left(RecSet!Proc_code, 2) = "38" Then   'Debit
                 Debit = 1
        ElseIf Left(RecSet!Proc_code, 2) = "00" Or Left(RecSet!Proc_code, 2) = "01" Or Left(RecSet!Proc_code, 2) = "42" Then
                 Debit = 0
        End If
                
      
        With PostZapmessage
                      poststring = ""
                     .ResetBitMaps
                     .MessageTypeID = "0420"
                     .CreatePBBitMap (2):  .Pan = RecSet!Pan
                    
                     .CreatePBBitMap (3): .ProcessingCODE = RecSet!Proc_code
                     If Debit = 1 Then
                     .CreatePBBitMap (4):  .AmtTransaction = RecSet!amount_req
                     .CreatePBBitMap (28): .AmtTxnFee = RecSet!tran_fee_req
                     
                     
                     Else
                     .CreatePBBitMap (4):  .AmtTransaction = RecSet!Amount_forward
                     .CreatePBBitMap (28): .AmtTxnFee = RecSet!tran_fee_forward
                     
                     
                     End If
                     
                     
                     
            
                     .CreatePBBitMap (7):  .DatetimeTransmission = RecSet!date_transmission
                     .CreatePBBitMap (11): .SysTraceAuditNum = RecSet!sys_trace_nr
                     .CreatePBBitMap (12): .TimeLocTxn = RecSet!time_local
                     .CreatePBBitMap (13): .DateLocTxn = RecSet!date_local
                     .CreatePBBitMap (14): .DateExpiry = "2012"
                     .CreatePBBitMap (22): .POSEntryMode = "000"
                     .CreatePBBitMap (25): .POSConditionCode = "05"
                     .CreatePBBitMap (26): .POSPinCaptureCode = "12"
                     .CreatePBBitMap (32): .AcquiringInstIdCode = RecSet!Acq_inst_id
                     .CreatePBBitMap (37): .RetrievalRefNum = RecSet!ref_nr
                     .CreatePBBitMap (33): .ForwardingInstIdCode = "254"
                     .CreatePBBitMap (41): .CardAcceptorTermId = RecSet!terminal_id
                     .CreatePBBitMap (42): .CardAcceptorIdCode = RecSet!Card_Accept_ID
                     .CreatePBBitMap (43): .CardAcceptorNameLoc = RecSet!Card_Accept_Loc
                     .CreatePBBitMap (49): .CurrencyCodeTxn = RecSet!currency_code
                     .CreatePBBitMap (100): .ReceivingInstIdCode = RecSet!Rec_Inst_id
                     .CreatePBBitMap (102): .AccIdOne = RecSet!Account_id1
                     .CreatePBBitMap (103): .AccIdTwo = RecSet!Account_id2
                     
                     
                     
                     poststring = .CREATEMsgISO8538
                    
                     Dim strSQL As String
                     Dim OutLetIndex As Integer
                     Dim OutLetMode As Integer
                     Dim DstNodeName As Variant
                     Dim MessageSentIndicator As Integer
                     
                     If Debit = 0 Then
                       strSQL = "select pindex, ip_address, port,mode,node_name from em_merchant_pos_index where bin_code = '" & .ReceivingInstIdCode & "'"
                       ElseIf Debit = 1 Then
                       strSQL = "select pindex, ip_address, port,mode,node_name from em_merchant_pos_index where bin_code = '" & .AcquiringInstIdCode & "'"
                       End If
                       
                        rstObj.Open strSQL, dbConnection
                            
                          If rstObj.EOF = False Then
                                 OutLetIndex = rstObj!Pindex
                                 OutLetMode = rstObj!Mode
                                 DstNodeName = rstObj!Node_Name
                           
                            If OutLetIndex <> 0 And OutLetMode = 1 Then
                               SendMessageToSwitch poststring, OutLetIndex, MessageSentIndicator
                            ElseIf OutLetIndex <> 0 And OutLetMode = 0 Then
                               SendMessageToMerchant poststring, GetIndexOut(OutLetIndex), MessageSentIndicator
                            End If
                          End If
               
            End With
            
            TmrTran_counter = 0 'reset counter
        End If
           
    
 Exit Sub
     
error_handle: txt_log.Text = txt_log.Text & vbLf & "Process GetTransactionDetails: " & err.Description

End Sub

Private Sub DbConnection_Monitor()
 
On Error GoTo ExitSub

Dim StrCon As String
Dim RecSet As New ADODB.Recordset

RecSet.Open "select top 1 * from em_agent_trans_1_a", dbConnection
If RecSet.EOF = False Then

End If
   
Exit Sub

ExitSub:
    'dbConnection.Close
    txt_log.Text = txt_log.Text & vbNewLine & err.Description & vbNewLine & "Process: DbConnection monitor"
    Call DbCon
End Sub

Private Sub DbCon()
On Error GoTo Quit

    
    Set dbConnection = New ADODB.Connection
    dbConnection.Open "Provider=SQLNCLI;" & _
    "Data Source=" & EM_SERVER & ";" & _
    "Initial Catalog=" & DB & ";" & _
    "User ID=" & USER_ID & ";" & _
    "Password=" & PSW
Quit:

End Sub
Public Sub AddAGENTTransaction( _
            ByVal State As Integer, _
            ByVal Pan As String, _
            ByVal expiry_date As String, _
            ByVal Msg_type As String, _
            ByVal Proc_code As String, _
            ByVal Amount As String, _
            ByVal Date_time As String, _
            ByVal stan As String, _
            ByVal time_local As String, _
            ByVal date_local As String, _
            ByVal acq_inst As String, _
            ByVal ref As String, _
            ByVal Term_id As String, _
            ByVal card_acc_id As String, _
            ByVal card_acc_loc As String, _
            ByVal Curr_code As String, _
            ByVal Echo_data As String, _
            ByVal Account_1 As String, _
            ByVal Account_2 As String, _
            ByVal Account_3 As String, _
            ByVal AgentID As String, _
            ByVal amountTxnFee As String, ByVal AmountProcFee As String, ByVal ExciseTax As String, ByVal WithHoldingTax As String, ByVal ref2 As String, ByVal Index As Variant, ByVal AmtBaseCurrency As String, ByRef Status As Long)

    'TmrProcessor.Enabled = True
'    TmrProcessor.Interval = 500
'    TmrTran_counter = 0
            
    Dim RstCommand As ADODB.Command
    Set RstCommand = New ADODB.Command
On Error GoTo err:
    With RstCommand
        .ActiveConnection = dbConnection
        .CommandType = adCmdStoredProc
        .CommandText = "[em_agent_tran_insert_1]"
        .Parameters("@state") = State
        .Parameters("@pan") = Pan
        .Parameters("@expiry_date") = expiry_date
        .Parameters("@message_type") = Msg_type
        .Parameters("@proc_code") = Proc_code
        .Parameters("@tran_amount_original") = Amount
        .Parameters("@tran_amount_base") = AmtBaseCurrency
        .Parameters("@transmission_datetime") = Date_time
        .Parameters("@stan") = stan
        .Parameters("@time_local") = time_local
        .Parameters("@date_local") = date_local
        .Parameters("@acq_inst_id") = acq_inst
        .Parameters("@ret_ref_nr") = ref
        .Parameters("@terminal_id") = Term_id
        .Parameters("@card_acceptor_id") = card_acc_id
        .Parameters("@card_acceptor_loc") = card_acc_loc
        .Parameters("@curr_code") = Curr_code
        .Parameters("@echo_data") = Echo_data
        .Parameters("@acc_code") = Account_1
        .Parameters("@acc_code2") = Account_2
        .Parameters("@acc_code3") = Account_3
        .Parameters("@agentID") = AgentID
        .Parameters("@amountTxnFee") = amountTxnFee
        .Parameters("@amountProcFee") = AmountProcFee
        .Parameters("@ExciseTax") = ExciseTax
        .Parameters("@WithHoldingTax") = WithHoldingTax
        .Parameters("@mrrn") = ref2
        .Parameters("@index") = Index
       
        .Execute
        Status = .Parameters("@status").Value
        
       
    End With
    Set RstCommand = Nothing
    Exit Sub
    Status = 0
err:     txt_log.Text = txt_log.Text & vbLf & "Process AddAGENTTransaction:" & err.Description

    
End Sub



Private Sub AgencyCWD(ByVal Message As String)
    Dim IsoMessage As PostBridgeISO8583
    Set IsoMessage = New PostBridgeISO8583
    Dim RespMessageString As String
    Dim stractured_data_info As String
    Dim ForwardMessage As Integer
'    Dim B_start, B_end, C_start, C_end As Integer
'    Dim Buffer_B, Buffer_C As String
    Dim Status As Long
    On Error GoTo ErraTrap
     ForwardMessage = 0
     IsoMessage.ISO8583MsgBD Message
     With IsoMessage
     
     
'                    stractured_data_info = .PStructuredData.StructuredData
'                    B_start = InStr(1, stractured_data_info, "<BufferB>")
'                    B_end = InStr(1, stractured_data_info, "</BufferB>")
'                    C_start = InStr(1, stractured_data_info, "<BufferC>")
'                    C_end = InStr(1, stractured_data_info, "</BufferC>")
                    
                    'Determine if POS/Agency EXISTS
          
                                       Dim RecsetE As New ADODB.Recordset
                                       Dim RecsetC As New ADODB.Recordset
                                       Dim AgentAccount As String
                                       Dim AgentCommissionAccount As String
                                       Dim AgentID As String
                                       Dim ExciseTax As String
                                       Dim WithHoldingTax As String
                                       Dim CommissionDueAgentREAL As String
                                       Dim CommissionDueAgent As String
                                       Dim CommissionDueFBL As String
                                       Dim CustomerPhone As String
                                       Dim AmountAtransaction As Double
                                       
                                       
                RecsetE.Open "Select agent_account,agent_id,agent_commission_account from em_Agents where terminal_id = '" & .CardAcceptorTermId & "'", dbConnection
                 If RecsetE.EOF = False Then
                 
                        AgentAccount = RecsetE.Fields(0).Value
                        AgentID = RecsetE.Fields(1).Value
                        AgentCommissionAccount = RecsetE.Fields(2).Value
                        ForwardMessage = 1
                        
                     Dim str As String
                     str = "Select commission from em_agent_commission where min_amount <= " & CDbl(.AmtTransaction) / 100 & " and max_amount >= " & CDbl(.AmtTransaction) / 100 & " and  tran_code = 'CWD'"
                     RecsetC.Open str, dbConnection
                      If RecsetC.EOF = False Then
                           CommissionDueAgent = "D" & Format(RecsetC.Fields(0).Value / 2 * 100, "00000000")
                           CommissionDueFBL = "D" & Format(RecsetC.Fields(0).Value / 2 * 100, "00000000")
                           ExciseTax = Format(RecsetC.Fields(0).Value / 10 * 100, "000000000000")
                           WithHoldingTax = Format((RecsetC.Fields(0).Value / 2) * 5, "00000000")
                           CommissionDueAgentREAL = Format((RecsetC.Fields(0).Value / 2) * 95, "000000000000")
                           
                           ForwardMessage = 1
                        Else
                           .RespCode = "12"
                           ForwardMessage = 0
                        End If
                        RecsetC.Close
                 Else
                        .RespCode = "03"
                         ForwardMessage = 0
                 End If
                 RecsetE.Close
                If ForwardMessage = 1 Then   'Agent exits
                                
                                                              
                         Call AddAGENTTransaction(1, .Pan, .DateExpiry, .MessageTypeID, .ProcessingCODE, .AmtTransaction, _
                                    .DatetimeTransmission, .SysTraceAuditNum, .TimeLocTxn, .DateLocTxn, .AcquiringInstIdCode & "-POS", .RetrievalRefNum, _
                                    .CardAcceptorTermId, .CardAcceptorIdCode, .CardAcceptorNameLoc, .CurrencyCodeTxn, .EchoData, .AccIdOne, AgentAccount, AgentCommissionAccount, AgentID, CommissionDueAgentREAL, Right(CommissionDueFBL, 8), ExciseTax, WithHoldingTax, .RetrievalRefNum, "000000000000", 1, Status)
                                              
                                            
                                
                    If Status = 1 Then
                        .ResetBitMaps
                        .MessageTypeID = "0200"
                        .CreatePBBitMap (2): .Pan = "639485035555555557"  '"639485035000017280"   '639485035555555557
                        .CreatePBBitMap (3): .ProcessingCODE = "030000"
                        If .AmtTransaction <> "" Then .CreatePBBitMap (4)
                        If .DatetimeTransmission <> "" Then .CreatePBBitMap (7)
                        If .SysTraceAuditNum <> "" Then .CreatePBBitMap (11)
                        If .TimeLocTxn <> "" Then .CreatePBBitMap (12)
                        If .DateLocTxn <> "" Then .CreatePBBitMap (13)
                        .CreatePBBitMap (14): .DateExpiry = "2012"
                        If .DateExpiry <> "" Then .CreatePBBitMap (14)
                        If .DateSettle <> "" Then .CreatePBBitMap (15)
                        If .MerchantType <> "" Then .CreatePBBitMap (18)
                        If .CardSeqNum <> "" Then .CreatePBBitMap (23)
                        .CreatePBBitMap (22): .POSEntryMode = "000"
                        .CreatePBBitMap (25): .POSConditionCode = "05"
                        .CreatePBBitMap (26): .POSPinCaptureCode = "12"
                        .CreatePBBitMap (28): .AmtTxnFee = CommissionDueAgent
                        .CreatePBBitMap (30): .AmtTxnProcessingFee = CommissionDueAgent
                        If .AcquiringInstIdCode <> "" Then .CreatePBBitMap (32)
                        If .ForwardingInstIdCode <> "" Then .CreatePBBitMap (33)
                        'If .Track2Data <> "" Then .CreatePBBitMap (35)
                        If .RetrievalRefNum <> "" Then .CreatePBBitMap (37)
                        If .AuthIdResp <> "" Then .CreatePBBitMap (38)
                        If .RespCode <> "" Then .CreatePBBitMap (39)
                        If .ServiceRestrictionCode <> "" Then .CreatePBBitMap (40)
                        If .CardAcceptorTermId <> "" Then .CreatePBBitMap (41)
                        If .CardAcceptorIdCode <> "" Then .CreatePBBitMap (42)
                        If .CardAcceptorNameLoc <> "" Then .CreatePBBitMap (43)
                        If .AdditionalRespData <> "" Then .CreatePBBitMap (44)
                        If .AdditionalData <> "" Then .CreatePBBitMap (48)
                        If .CurrencyCodeTxn <> "" Then .CreatePBBitMap (49)
                        If .PinData <> "" Then .CreatePBBitMap (52)
                        If .AdditionalAmts <> "" Then .CreatePBBitMap (54)
                        If .MsgReasonCode <> "" Then .CreatePBBitMap (56)
                        If .NetMangtInfoCode <> "" Then .CreatePBBitMap (70)
                        If .OriginalDataElements <> "" Then .CreatePBBitMap (90)
                        If .ReplacementAmts <> "" Then .CreatePBBitMap (95)
                        If .ReceivingInstIdCode <> "" Then .CreatePBBitMap (100)
                        If .AccIdOne <> "" Then .CreatePBBitMap (102)
                        .CreatePBBitMap (103): .AccIdTwo = AgentAccount
                        
                        .CreatePBBitMap (123): .POSDataCode = "000000000000090"
                                                                            
                        RespMessageString = .CREATEMsgISO8538
                        'SendMessageToAgencyB RespMessageString 'Send message to Postilion
                   End If
                Else 'FORWARD DECLINED
                                                                                                          
                                                                        
                         Call AddAGENTTransaction(99, .Pan, .DateExpiry, .MessageTypeID, .ProcessingCODE, .AmtTransaction, _
                                    .DatetimeTransmission, .SysTraceAuditNum, .TimeLocTxn, .DateLocTxn, .AcquiringInstIdCode & "-POS", .RetrievalRefNum, _
                                    .CardAcceptorTermId, .CardAcceptorIdCode, .CardAcceptorNameLoc, .CurrencyCodeTxn, .EchoData, .AccIdOne, AgentAccount, AgentID, AgentCommissionAccount, CommissionDueAgentREAL, Right(CommissionDueFBL, 8), ExciseTax, WithHoldingTax, .RetrievalRefNum, 1, "000000000000", Status)
                                                                                                       
                                                                                                          
                        .ResetBitMaps
                        .MessageTypeID = Left(.MessageTypeID, 2) & "10"
                        If .Pan <> "" Then .CreatePBBitMap (2)
                        If .ProcessingCODE <> "" Then .CreatePBBitMap (3)
                        If .AmtTransaction <> "" Then .CreatePBBitMap (4)
                        If .DatetimeTransmission <> "" Then .CreatePBBitMap (7)
                        If .SysTraceAuditNum <> "" Then .CreatePBBitMap (11)
                        If .TimeLocTxn <> "" Then .CreatePBBitMap (12)
                        If .DateExpiry <> "" Then .CreatePBBitMap (14)
                        If .DateExpiry <> "" Then .CreatePBBitMap (14)
                        If .DateSettle <> "" Then .CreatePBBitMap (15)
                        If .MerchantType <> "" Then .CreatePBBitMap (18)
                        If .CardSeqNum <> "" Then .CreatePBBitMap (23)
                        If .AcquiringInstIdCode <> "" Then .CreatePBBitMap (32)
                        If .ForwardingInstIdCode <> "" Then .CreatePBBitMap (33)
                        If .Track2Data <> "" Then .CreatePBBitMap (35)
                        If .RetrievalRefNum <> "" Then .CreatePBBitMap (37)
                        If .AuthIdResp <> "" Then .CreatePBBitMap (38)
                        If .RespCode <> "" Then .CreatePBBitMap (39)
                        If .ServiceRestrictionCode <> "" Then .CreatePBBitMap (40)
                        If .CardAcceptorTermId <> "" Then .CreatePBBitMap (41)
                        If .CardAcceptorIdCode <> "" Then .CreatePBBitMap (42)
                        If .CardAcceptorNameLoc <> "" Then .CreatePBBitMap (43)
                        If .AdditionalRespData <> "" Then .CreatePBBitMap (44)
                        If .AdditionalData <> "" Then .CreatePBBitMap (48)
                        If .CurrencyCodeTxn <> "" Then .CreatePBBitMap (49)
                        If .PinData <> "" Then .CreatePBBitMap (52)
                        If .AdditionalAmts <> "" Then .CreatePBBitMap (54)
                        If .MsgReasonCode <> "" Then .CreatePBBitMap (56)
                        If .EchoData <> "" Then .CreatePBBitMap (59)
                        If .NetMangtInfoCode <> "" Then .CreatePBBitMap (70)
                        If .OriginalDataElements <> "" Then .CreatePBBitMap (90)
                        If .ReplacementAmts <> "" Then .CreatePBBitMap (95)
                        If .ReceivingInstIdCode <> "" Then .CreatePBBitMap (100)
                        If .AccIdOne <> "" Then .CreatePBBitMap (102)
                        If .AccIdTwo <> "" Then .CreatePBBitMap (103)
                                               
                                                                            
                        RespMessageString = .CREATEMsgISO8538
                        'SendMessageToAgencyA RespMessageString 'Send message to Postilion
                End If
                                        
              End With
    
    Exit Sub
ErraTrap:
  txt_log.Text = txt_log.Text & vbNewLine & "Process AgencyCWD: " & err.Description
End Sub


Private Sub PostilionSck_DataArrival(ByVal bytesTotal As Long)
 Dim strData As String
    Dim ServaData As String
    PostilionSck.GetData strData
    ServaData = ServaData & strData
    'If bytesTotal = 8096 Then DoEvent
    Dim str As String
    Dim Strace As String
    MTSOutGoingMessage ServaData, str, Strace
    
End Sub

Private Sub PostilionSck_Error(ByVal Number As Integer, Description As String, ByVal Scode As Long, ByVal Source As String, ByVal HelpFile As String, ByVal HelpContext As Long, CancelDisplay As Boolean)
    PostilionSck.Close
    strStatusBarText = Replace(strStatusBarText, "=online", "=offline", , , vbTextCompare)
    StatusBar.SimpleText = strStatusBarText
    'PostTxt.Text = "Error in connection"
    PostilionSck.Connect ZAP_IP, ZAP_PORT
End Sub



Private Sub Form_Load()

 If App.PrevInstance Then
  MsgBox "Emserv is running", vbInformation
    End
  End If
    Set Encyptor = New EBL_Encryption.clsEncryption
    'add icon to tray

    AddIconToTray
    StatusBar.Enabled = True
    strStatusBarText = "switch=offline; Mobilenode=disconnected; db server=<unknown>; processing=idle"
    StatusBar.SimpleText = strStatusBarText
            
    If ReadIni(App.Path & "\zapbridge.ini") = False Then
        MsgBox "File zapbridge.ini is missing or is incorrectly formatted, please check", vbCritical, "File Error"
        End
        End If
    TmrTran_counter = 0
    Set dbConnection = New ADODB.Connection
    'Set dbConnection = New ADODB.Connection
    
    
    
    On Error GoTo err:
    'dbPwd = Encyptor.EncryptString("DES", dbPwd, "XXXXX", True)
    PSW = Encyptor.DecryptString("DES", PSW, "XXXXX", True)
    
    
    '1."Provider=SQLNCLI10.1;Integrated Security="";Persist Security Info=False;User ID=admin;Initial Catalog=DB_APP;Data Source=NET-BRAIN;Initial File Name="";Server SPN="""
      
    '2.dbConnection.Open "Provider=SQLOLEDB.1;Password=password;Persist Security Info=True;User ID=admin;Initial Catalog=db_app;Data Source=net-brain"
     
    '3. Provider=MSDASQL.1;Password=logmein;Persist Security Info=True;User ID=sa;Extended Properties="DSN=NET-BRAIN;UID=admin;PWD=mudslinger;APP=Microsoft Windows Operating System;WSID=BPOOR-16D68FBC7D;DATABASE=DB_App;Network=DBMSSOCN";Initial Catalog=DB_App
      
     dbConnection.Open "Provider=SQLOLEDB;" & _
    "Data Source=" & EM_SERVER & ";" & _
    "Initial Catalog=" & DB & ";" & _
    "User ID=" & USER_ID & ";" & _
    "Password=" & PSW
      
      
'    dbConnection.Open "Provider=SQLNCLI;" & _
'    "Data Source=" & EM_SERVER & ";" & _
'    "Initial Catalog=" & DB & ";" & _
'    "User ID=" & USER_ID & ";" & _
'    "Password=" & PSW

        
    'OPEN THE SERVER PORT AND LISTENING INCOMING MOBILE CONNECTIONS
     
     Dim RecSet As New ADODB.Recordset
     RecSet.Open "select * from em_hsm", dbConnection
     If RecSet.EOF = False Then
        HSM_PORT = RecSet!Port
        HSM_IP = RecSet!ip_address
        
        If HsmSck.State <> 7 Then
          HsmSck.Connect HSM_IP, HSM_PORT
        End If
        
     Else
       EventsTrap = EventsTrap & vbNewLine & "No HSM service is configured. Transaction requiring PINBLOCK calculations will be declined."
     End If
     RecSet.Close
    Call ResetIndex
    Call CreateMonitors
    Call IsCreateMonitors
    
    'Create timers
    Dim i As Integer
    ReDim MaxTransLiveTime(200) As String
    For i = 0 To 200
    MaxTransLiveTime(i) = ""
    Next i
    
    
     'OPEN THE SERVER PORT AND LISTENING INCOMING MOBILE CONNECTIONS
   
     RecSet.Open "select top 1 port from em_mob_param", dbConnection
     If RecSet.EOF = False Then
     LOCAL_MOBILE_PORT = RecSet!Port
     
            MobileSocket(0).LocalPort = RecSet!Port
            MobileSocket(0).Listen
            Call UpdateUptime("USSD Service", 0)
    Else
    MsgBox "No Webserver application has been configured", vbCritical
    End If
    RecSet.Close
    
    Dim pnlX As Panel 'Approved trans
    Dim pnlX2 As Panel 'Declined trans
    Dim pnlX3 As Panel 'Errog log
    Dim pnlX4 As Panel
    
    Set pnlX = StatusBar.Panels.Add()
    Set pnlX2 = StatusBar.Panels.Add()
    Set pnlX3 = StatusBar.Panels.Add()
    Set pnlX4 = StatusBar.Panels.Add()
    
     pnlX.Width = 3500
     pnlX2.Width = 3500
     pnlX3.Width = 3500
     pnlX4.Width = 3500
     
    pnlX4.Text = "Start date:" & Now
    
    pnlX.Text = "Transaction Counts:"
    pnlX2.Text = "Declined Transaction Counts:"
    pnlX3.Text = "Refresh rate (instant)"
   
    
   dbConnection.Execute "update em_issuer_sap set mode = 0"
   
   RecSet.Open "select * from em_issuer_sap", dbConnection
     Do While RecSet.EOF = False


    Shell App.Path & "\iGateway.exe", vbMinimizedFocus
    RecSet.MoveNext
     SlowDown (500)
    Loop
    RecSet.Close
    
    Exit Sub
    
     
err:
    EventsTrap = EventsTrap & vbNewLine & "Process System Initialization: " & err.Description
    
End Sub


Public Function ReadIni(ByVal strFileName As String) As Boolean
    Dim intFileNo As Integer
    Dim strReadLine As String
    
    On Error GoTo Quit:
    
    intFileNo = CInt(Mid(Format(Time, "ms"), 2, 1))
    
    If Dir(strFileName) <> "" Then
        Open strFileName For Input Shared As #intFileNo
            
            ' parse file
            Do While Not EOF(intFileNo)
                Input #intFileNo, strReadLine
                
                If InStr(1, UCase(strReadLine), UCase("MT_IP"), vbTextCompare) > 0 Then
                    ZAP_IP = GetValue(strReadLine, "=")
                ElseIf InStr(1, UCase(strReadLine), UCase("MT_PORT"), vbTextCompare) > 0 Then
                    ZAP_PORT = GetValue(strReadLine, "=")
                ElseIf InStr(1, UCase(strReadLine), UCase("ASA_IP"), vbTextCompare) > 0 Then
                    POSTILION_IP = GetValue(strReadLine, "=")
                ElseIf InStr(1, UCase(strReadLine), UCase("ASA_PORT"), vbTextCompare) > 0 Then
                    POSTILION_PORT = GetValue(strReadLine, "=")
                ElseIf InStr(1, UCase(strReadLine), UCase("DBN"), vbTextCompare) > 0 Then
                    DB = GetValue(strReadLine, "=")
                ElseIf InStr(1, UCase(strReadLine), UCase("USER_ID"), vbTextCompare) > 0 Then
                    USER_ID = GetValue(strReadLine, "=")
                ElseIf InStr(1, UCase(strReadLine), UCase("PSW"), vbTextCompare) > 0 Then
                    PSW = GetValue(strReadLine, "=")
                ElseIf InStr(1, UCase(strReadLine), UCase("EM_SERVER"), vbTextCompare) > 0 Then
                    EM_SERVER = GetValue(strReadLine, "=")
                ElseIf InStr(1, UCase(strReadLine), UCase("LOCAL_MOBILE_PORT"), vbTextCompare) > 0 Then
                 LOCAL_MOBILE_PORT = GetValue(strReadLine, "=")
                 
                End If
                                

            Loop
        
        Close #intFileNo
    End If
    
    If DB <> "" And _
    USER_ID <> "" And _
    PSW <> "" Then
        ReadIni = True
    Else
        ReadIni = False
    End If
Quit:
End Function
Public Function GetValue(ByVal strText As String, ByVal strSearchString As String) As String
    On Error GoTo error_handle
    
    GetValue = Trim(Mid(strText, InStr(1, strText, strSearchString, vbTextCompare) + 1, Len(strText) - InStr(1, strText, strSearchString, vbTextCompare) + 1))
    
    Exit Function
error_handle:
    GetValue = ""
End Function

Public Sub SendMessageToMerchant(ByVal PMessage As String, Index As Integer, ByRef MsgSentIndicator As Integer)
    On Error GoTo ExitSocket
    If MerchantSocket(Index).State = sckConnected Then
        MerchantSocket(Index).SendData PMessage
        MsgSentIndicator = 1
    Else
        MsgSentIndicator = 0
    End If
    Exit Sub
ExitSocket:
    EventsTrap = EventsTrap & vbNewLine & "Process SendMessageToServerSAPInterchange " & err.Description
    Image7.Visible = True
    Image5.Visible = False
    
End Sub
Public Sub SendMessageToSwitch(ByVal PMessage As String, ByVal Index As Variant, ByRef MsgSentIndicator As Integer)
    
    On Error GoTo ErrorTrap
   
    If SwitchSocket(Index).State = sckConnected Then
       SwitchSocket(Index).SendData PMessage
       MsgSentIndicator = 1
    Else
      MsgSentIndicator = 0
    End If
Exit Sub
ErrorTrap:
EventsTrap = EventsTrap & vbNewLine & "Process SendMessageToClientSAPInterchange " & err.Description
Image8.Visible = True
Image6.Visible = False

End Sub

Public Sub MessageDecompose(ByVal str As String)
        Dim MsgToProc As String
        Dim PostMessag As String
        Dim byte2 As String
        Dim Msglen As Integer
        
        MsgToProc = str
        
    On Error GoTo ErrorHandle
    
    Do While Len(MsgToProc) > 0
        'get first 2 bytes to calculate msg length
        byte2 = Mid(MsgToProc, 1, 2)
        Msglen = Val(Asc(Mid(byte2, 1, 1))) * 256 + Val(Asc(Mid(byte2, 2, 1))) + 2
        
        'Get exact message from the length
        PostMessag = ""
        If Len(MsgToProc) >= Msglen Then
            PostMessag = Mid(MsgToProc, 1, Msglen)
            Else
            MsgToProc = ""
            Exit Do
        End If
        SlowDown (50)
        'ProcessMerchantMessage PostMessag
        
       If Len(MsgToProc) > Msglen Then 'Theres still more to process
            MsgToProc = Mid(MsgToProc, Msglen + 1, Len(MsgToProc) - Msglen)
        Else
            MsgToProc = ""
        End If
                
    Loop
    
    Exit Sub
ErrorHandle:
    On Error Resume Next
End Sub

Public Sub SlowDown(MilliSeconds As Long)

Dim lngTickStore As Long
lngTickStore = GetTickCount()
Do While lngTickStore + MilliSeconds > GetTickCount()
DoEvents
Loop

End Sub
Public Sub AddNewTransaction_Merchant( _
            ByVal State As Integer, _
            ByVal Pan As String, _
            ByVal Msg_type As String, _
            ByVal Proc_code As String, _
            ByVal Amount As String, ByVal surcharge As Double, _
            ByVal Date_time As String, _
            ByVal stan As String, _
            ByVal time_local As String, _
            ByVal date_local As String, _
            ByVal acq_inst As String, _
            ByVal ref As String, _
            ByVal Rsp As Variant, _
            ByVal Term_id As String, _
            ByVal card_acc_id As String, _
            ByVal card_acc_loc As String, _
            ByVal Curr_code As String, _
            ByRef Tran_nr As Long, _
            Optional ByVal pin_data As Variant, _
            Optional ByVal Echo_data As String, _
            Optional ByVal msisdn_user As String, _
            Optional ByVal msisdn_user2 As String, _
            Optional ByVal Approval_code As String, _
            Optional ByVal Issuer As Variant, _
            Optional ByVal Index As String)

        '    TmrProcessor.Enabled = True
        '    TmrProcessor.Interval = 200
        '    TmrTran_counter = 0
    On Error GoTo ErrTrap
    
    If pin_data = "" Then pin_data = "000000"
    If card_acc_id = "" Then card_acc_id = "00000000000000"
    
    Dim RstCommand As ADODB.Command
    Set RstCommand = New ADODB.Command
    
    With RstCommand
        .ActiveConnection = dbConnection
        .CommandType = adCmdStoredProc
        .CommandText = "[em_merchant_trans_req]"
        .Parameters("@state") = State
        .Parameters("@pan") = Pan
        .Parameters("@message_type") = Msg_type
        .Parameters("@proc_code") = Proc_code
        .Parameters("@tran_amount_original") = Amount
        .Parameters("@surcharge") = surcharge
        .Parameters("@transmission_datetime") = Date_time
        .Parameters("@stan") = stan
        .Parameters("@time_local") = time_local
        .Parameters("@date_local") = date_local
        .Parameters("@acq_inst_id") = acq_inst
        .Parameters("@ret_ref_nr") = ref
        .Parameters("@scr_response") = Rsp
        .Parameters("@terminal_id") = Term_id
        .Parameters("@card_acceptor_id") = card_acc_id
        .Parameters("@card_acceptor_loc") = card_acc_loc
        .Parameters("@curr_code") = Curr_code
        .Parameters("@pin_data") = pin_data
        .Parameters("@echo_data") = Echo_data
        .Parameters("@msisdn") = msisdn_user
        .Parameters("@msisdn2") = msisdn_user2
        .Parameters("@approval_code") = "00" 'Approval_code
        .Parameters("@issuer") = Issuer
        .Parameters("@index") = Index
       
        .Execute
        Tran_nr = .Parameters("@tran_nr").Value
    End With
    
    Set RstCommand = Nothing
Exit Sub
ErrTrap:
   EventsTrap = EventsTrap & vbNewLine & "Process AddNewTransaction_Merchant " & err.Description

End Sub
Public Sub AddNewTransaction_MerchantEval_Reg( _
            ByVal Msisdn As Variant, _
            ByVal Msisdn2 As Variant, _
            ByVal TransmissionDatetime As Variant, _
            ByVal stan As Variant, _
            ByVal Reg_Info As Variant, _
            ByVal Amount As Double, _
            ByVal reg_location As Variant, _
            ByVal ref As Variant, _
            ByVal Tran_type As Variant, _
            ByVal merchant_id As Variant, _
            ByRef Resp_code As Variant, _
            Optional ByRef Auth_code As Variant, _
            Optional ByVal merchant_loc As Variant, _
            Optional ByVal Index As Variant)
            
            Dim Encrypt As New EBL_Encryption.clsEncryption
            Dim RecSet As New ADODB.Recordset
            Dim First_name As Variant
            Dim Mid_name As Variant
            Dim SurName As Variant
            Dim Nat_ID As Variant
            Dim DateBirth As Variant
            Dim Mbase As Variant
            Dim Rbase As Variant
            Dim DateTime As Variant
            Dim Serial_number As Variant
            Dim mlen As Integer
            Dim CheckValue As Long
            Dim result As Integer
            
            On Error GoTo Err_Handle
            
                '            If Reg_Info <> "" Then
                '
                '                 If InStr(1, Reg_Info, "<FName>") > 0 Then
                '                   First_name = Mid(Reg_Info, InStr(1, Reg_Info, "<FName>") + 7, InStr(1, Reg_Info, "</FName>") - (InStr(1, Reg_Info, "<FName>") + 7))
                '                 Else
                '                  Resp_code = "21"
                '                 End If
                '                 If InStr(1, Reg_Info, "<MName>") > 0 Then
                '                    Mid_name = Mid(Reg_Info, InStr(1, Reg_Info, "<MName>") + 7, InStr(1, Reg_Info, "</MName>") - (InStr(1, Reg_Info, "<MName>") + 7))
                '                 End If
                '                 If InStr(1, Reg_Info, "<Surname>") > 0 Then
                '                    Surname = Mid(Reg_Info, InStr(1, Reg_Info, "<Surname>") + 9, InStr(1, Reg_Info, "</Surname>") - (InStr(1, Reg_Info, "<Surname>") + 9))
                '                 Else
                '                  Resp_code = "21"
                '                 End If
                '                 If InStr(1, Reg_Info, "<NationalID>") > 0 Then
                '                    NAT_ID = Mid(Reg_Info, InStr(1, Reg_Info, "<NationalID>") + 12, InStr(1, Reg_Info, "</NationalID>") - (InStr(1, Reg_Info, "<NationalID>") + 12))
                '                 Else
                '                  Resp_code = "21"
                '                 End If
                '                 If InStr(1, Reg_Info, "<DateBirth>") > 0 Then
                '                    DateBirth = Mid(Reg_Info, InStr(1, Reg_Info, "<DateBirth>") + 11, InStr(1, Reg_Info, "</DateBirth>") - (InStr(1, Reg_Info, "<DateBirth>") + 11))
                '                 Else
                '                  Resp_code = "21"
                '                 End If
                '
                '            Else
                '             Resp_code = "21"
                '            'Format === <FName>Ezekiel</FName><MName>M.</MName><Surname>Kimanthi</Surname><NationalID>22882773</NationalID><DateBirth>07-05-1982</DateBirth>
                '           End If
           
           If Msisdn2 <> "" Then
              RecSet.Open ("Select top 1 msisdn,auth_offset,auth_offset_2 from dbo.em_merchant_reg_evalue where msisdn = '" & Msisdn2 & "' and status = 1 order by record_nr desc"), dbConnection
                If RecSet.EOF = True Then
                
                CheckValue = Val(Right(Msisdn2, 9))
                Serial_number = Generate_Code(CheckValue)
            
                Auth_code = Mid$(Serial_number, 1, 9)
                Serial_number = Mid$(Serial_number, 11, Len(Serial_number) - 10)
                Rbase = Val(Mid$(Serial_number, 1, InStr(1, Serial_number, ":") - 1))
                      
                Mbase = Val(Mid$(Serial_number, InStr(1, Serial_number, ":") + 1, Len(Serial_number) - InStr(1, Serial_number, ":")))
                DateTime = Year(Date) & "-" & Format(Month(Date), "00") & "-" & Format(Day(Date), "00") & " " & Format(Hour(Time), "00") & ":" & Format(Minute(Time), "00") & ":" & Format(Second(Time), "00")
                If Len(Rbase) < 4 Then
                  Rbase = Format(Rbase, "0000")
                End If
                If Len(Mbase) < 4 Then
                Mbase = Format(Mbase, "0000")
                End If
                Auth_code = GetID(Auth_code)
               Else
               Mbase = RecSet!auth_offset_2
               Rbase = RecSet!auth_offset
               Auth_code = "000000"
               DateTime = Year(Date) & "-" & Format(Month(Date), "00") & "-" & Format(Day(Date), "00") & " " & Format(Hour(Time), "00") & ":" & Format(Minute(Time), "00") & ":" & Format(Second(Time), "00")
                
               End If
               RecSet.Close
     Dim Xdata As String
     Xdata = Msisdn2 & "D" & TransmissionDatetime & "D" & CStr(Amount)
     Xdata = Encrypt.EncryptString("DES", Xdata, XKEY, True)
        
    'On Error GoTo ErrTrap
    Dim RstCommand As ADODB.Command
    Set RstCommand = New ADODB.Command
    With RstCommand
        .ActiveConnection = dbConnection
        .CommandType = adCmdStoredProc
        .CommandText = "[em_merchant_eval_registration]"
        .Parameters("@msisdn") = Msisdn2
        .Parameters("@TxnDatetime") = TransmissionDatetime
        .Parameters("@Stan") = stan
        .Parameters("@first_name") = Msisdn
        .Parameters("@mid_name") = "NULL"
        .Parameters("@surname") = "NULL"
        .Parameters("@national_id") = "NULL"
        .Parameters("@date_of_birth") = Format(Now, "YYYY-MM-DD")
        .Parameters("@reg_location") = reg_location
        .Parameters("@Ref") = ref
        .Parameters("@status") = 1
        .Parameters("@tran_type") = Tran_type
        .Parameters("@auth_offset") = Rbase
        .Parameters("@auth_offset_2") = Mbase
        .Parameters("@amount") = Amount
        .Parameters("@date_time_reg") = DateTime
        .Parameters("@merchant_id") = merchant_id
        .Parameters("@merchant_location") = merchant_loc
        .Parameters("@dataref") = Xdata 'Encrypt.EncryptString("DES", "0733151523D1115094433D4560", "24ABC1234DED1234", True)
        .Execute
         result = .Parameters("@result").Value
      End With
    
    
     
    If result = 1 Then

    RecSet.Open ("Select  msisdn,Source_TransDateTime,eval_amount_bal from dbo.em_merchant_reg_evalue where msisdn = '" & Msisdn2 & "' and status = 1 order by record_nr desc"), dbConnection
    If RecSet.EOF = False Then
      Xdata = RecSet!Msisdn & "D" & RecSet!Source_TransDateTime & "D" & CStr(RecSet!eval_amount_bal)
      Xdata = Encrypt.EncryptString("DES", Xdata, XKEY, True)
      dbConnection.Execute "UPDATE em_merchant_reg_evalue set dataxreference = '" & Xdata & "' where msisdn = '" & Msisdn2 & "'"
      RecSet.Close
    End If
    End If
    Set RstCommand = Nothing
    End If
Exit Sub
Err_Handle:
'ErrTrap:
   EventsTrap = EventsTrap & vbNewLine & "Process AddNewTransaction_MerchantEval_Reg " & err.Description

End Sub
Public Sub AddNewTransaction_Mobile_Req( _
            ByVal message_type As String, _
            ByVal Tran_type As String, _
            ByRef Tran_ref As String, _
            ByVal Msisdn As String, _
            ByVal amount_transaction As String, _
            ByVal account_id As String, _
            ByVal DateTime As String, _
            ByVal Issuer As String, _
            ByRef Error_Flag As Integer, _
            Optional Msisdn2 As String)
            
            Dim State As Integer
            State = 99
           
    On Error GoTo ErrTrap
    
    
    Dim RstCommand As ADODB.Command
    Set RstCommand = New ADODB.Command
    
    With RstCommand
        .ActiveConnection = dbConnection
        .CommandType = adCmdStoredProc
        .CommandText = "em_payserv_mobile_trans_req"
        .Parameters("@state") = State
        .Parameters("@msisdn") = Msisdn
        .Parameters("@msisdn2") = Msisdn2
        .Parameters("@tran_type") = Tran_type
        .Parameters("@amount_transaction") = amount_transaction
        .Parameters("@account_id") = account_id
        .Parameters("@transmission_datetime") = DateTime
        .Parameters("@issuer") = Issuer
        .Execute
        Tran_ref = .Parameters("@ref_nr")
    End With
    Error_Flag = 0
    Set RstCommand = Nothing
    Exit Sub
ErrTrap:
    Error_Flag = 1
    EventsTrap = EventsTrap & vbNewLine & "Process AddNewTransactions_Mobile_Req " & err.Description
End Sub

Public Sub AddNewTransaction_Authocode( _
            ByVal State As Integer, _
            ByVal msisdn_prime As String, _
            ByVal msisdn_secondary As String, _
            ByVal nBase As String, _
            ByVal Mbase As String, _
            ByVal amount_ceiling As String, _
            ByVal date_time_req As String, _
            ByVal Tran_type As String, _
            ByVal Issuer As String, _
            Optional account_id As Variant)
 
    On Error GoTo ErrTrap
    Dim expiry_date_time As String
    
    Dim RstCommand As ADODB.Command
    Set RstCommand = New ADODB.Command
    
    With RstCommand
        .ActiveConnection = dbConnection
        .CommandType = adCmdStoredProc
        .CommandText = "em_mobile_trans_authcode_req"
        .Parameters("@state") = State
        .Parameters("@msisdn_prime") = msisdn_prime
        .Parameters("@msisdn_secondary") = msisdn_secondary
        .Parameters("@tran_type") = Tran_type
        .Parameters("@nBase") = nBase
        .Parameters("@mBase") = Mbase
        .Parameters("@amount_ceiling") = amount_ceiling
        .Parameters("@account_id") = account_id
        .Parameters("@date_time_req") = date_time_req
        .Parameters("@issuer") = Issuer
        .Execute
    End With
    
    Set RstCommand = Nothing
Exit Sub
ErrTrap:
   EventsTrap = EventsTrap & vbNewLine & "Process AddNewTransaction_Authocode " & err.Description

End Sub

Public Sub GetTransactionsDetails_From_MobileReq(ByVal Tran_type As Variant, _
ByVal Msisdn As Variant, ByVal Msisdn2 As Variant, ByVal Amount As Variant, ByVal account_id As Variant, ByVal Issuer As Variant, ByVal Tran_ref As Variant)
   
    Dim TranString As String
    Dim State As Variant
    Dim DateTime As Variant
    Dim Serial_number As Variant
    Dim Auth_code As Variant
    Dim Rbase As String
    Dim Mbase As String
    Dim Mobile_resp As String
    Dim mlen As Integer
        
    On Error GoTo Err_Handle
    If Tran_type = "00" Then
        Serial_number = Generate_Code(Msisdn)
    ElseIf Tran_type = "42" Then
       Serial_number = Generate_Code(Msisdn2)
    End If
        Auth_code = Mid$(Serial_number, 1, 9)
        Serial_number = Mid$(Serial_number, 11, Len(Serial_number) - 10)
        Rbase = Val(Mid$(Serial_number, 1, InStr(1, Serial_number, ":") - 1))
              
        Mbase = Val(Mid$(Serial_number, InStr(1, Serial_number, ":") + 1, Len(Serial_number) - InStr(1, Serial_number, ":")))
        DateTime = Year(Date) & "-" & Format(Month(Date), "00") & "-" & Format(Day(Date), "00") & " " & Format(Hour(Time), "00") & ":" & Format(Minute(Time), "00") & ":" & Format(Second(Time), "00")
        If Len(Rbase) < 4 Then
          Rbase = Format(Rbase, "0000")
        End If
        If Len(Mbase) < 4 Then
        Mbase = Format(Mbase, "0000")
        End If
        
        Call AddNewTransaction_Authocode(0, Msisdn, Msisdn2, Rbase, Mbase, Val(Amount), DateTime, Tran_type, Issuer, account_id)
      
    
        Mobile_resp = "SARP|" & Tran_type & "|" & Format(Tran_ref, "000000000000") & _
         "|" & Msisdn & "|" & Msisdn2 & "|" & Amount & "|" & account_id & "|" & Auth_code
         
            mlen = Len(Mobile_resp)
            Mobile_resp = Format(mlen, "0000") + "|" & Mobile_resp
 
       Call SendMessageToMobileApp(Mobile_resp, 0)
     
   
    Exit Sub
Err_Handle:
    EventsTrap = EventsTrap & vbNewLine & "Process GetTransactionsDetails_From_MobileReq " & err.Description
End Sub
Public Sub UpdateRespTransaaction( _
            ByVal Msg_type As String, _
            ByVal Proc_code As String, _
            ByVal stan As String, _
            ByVal Msisdn As String, _
            ByVal ref_nr As String, _
            ByVal RSP_Code As String, _
            ByVal EchoData As String, _
            ByVal Index As Integer, ByRef SwitchKey As Variant)
 
    Dim RstCommand As ADODB.Command
    Set RstCommand = New ADODB.Command
    On Error GoTo ErrTrap
    With RstCommand
        .ActiveConnection = dbConnection
        .CommandType = adCmdStoredProc
        .CommandText = "em_merchant_trans_update"
        .Parameters("@message_type") = Msg_type
        .Parameters("@stan") = stan
        .Parameters("@msisdn") = "0" & Right(Msisdn, 9)
        .Parameters("@ret_ref_nr") = ref_nr
        .Parameters("@resp_code") = RSP_Code
        .Parameters("@echoData") = EchoData
        .Parameters("@additional_resp") = "000000000000"
        .Execute
         SwitchKey = .Parameters("@source_node_key").Value
    End With
    
    Set RstCommand = Nothing
   Exit Sub
ErrTrap:
   EventsTrap = EventsTrap & vbNewLine & "Process UpdateRespTransaction " & err.Description
End Sub

Public Sub UpdateUptime( _
            ByVal Interchange As String, _
            ByVal Status As Integer)
 
    Dim RstCommand As ADODB.Command
    Set RstCommand = New ADODB.Command
    On Error GoTo ErrTrap
    With RstCommand
        .ActiveConnection = dbConnection
        .CommandType = adCmdStoredProc
        .CommandText = "em_uptime_set"
        .Parameters("@interchange") = Interchange
        .Parameters("@status") = Status
        .Execute
    End With
    
    Set RstCommand = Nothing
   Exit Sub
ErrTrap:
   EventsTrap = EventsTrap & vbNewLine & "Process UpdateUptime " & err.Description
End Sub

Private Sub MobileSocket_Close(Index As Integer)
  On Error Resume Next
    MobileSocket(Index).Close
    Unload MobileSocket(Index)
    MobileSocketArray(Index) = 0
    'Call UpdateUptime("USSD Service", 0)
End Sub

Private Sub MobileSocket_ConnectionRequest(Index As Integer, ByVal requestID As Long)

   mobileConnectionCounter = GetMobIndex()

    Load MobileSocket(mobileConnectionCounter)

    MobileSocket(mobileConnectionCounter).Accept requestID
    MobileSocketArray(mobileConnectionCounter) = 1
    'Call UpdateUptime("USSD Service", 1)
End Sub

Private Sub MobileSocket_DataArrival(Index As Integer, ByVal bytesTotal As Long)
    Dim MsgStr As String
    Dim MessageFromMobile As String
    Dim StrMessageTOProcess As String
    Dim intStreamLen As Integer
    Dim intMsgLength As Integer
    On Error GoTo Quit
    MobileSocket(Index).GetData MsgStr
    MessageFromMobile = MsgStr
    
    Do While MessageFromMobile <> ""
                     
                     intStreamLen = Len(MessageFromMobile)
                     intMsgLength = GetMsgLen(Mid(MessageFromMobile, 1, 4))         ' get message length
                     
                     StrMessageTOProcess = Mid(MessageFromMobile, 1, intMsgLength)
                     ' get message from stream
                     ProcessUSSDMessage StrMessageTOProcess, Index & "_WebServer", "WEB SERVER"
                     'ProcessMerchantMessage0200 StrMessageTOProcess, Index & "_WebServer", "WEB SERVER" 'steve
                                          
                     MessageFromMobile = Mid(MessageFromMobile, intMsgLength + 1, intStreamLen - intMsgLength)  ' return rest of the stream
                             
    Loop

       
     MsgStr = ""
Quit:

End Sub

Private Sub MobileSocket_Error(Index As Integer, ByVal Number As Integer, Description As String, ByVal Scode As Long, ByVal Source As String, ByVal HelpFile As String, ByVal HelpContext As Long, CancelDisplay As Boolean)
   On Error Resume Next
    MobileSocket(Index).Close
    Unload MobileSocket(Index)
    MobileSocketArray(Index) = 0
End Sub
Public Sub SendMessageToMobileApp(ByVal MRspMessage As String, ByVal Index As Integer)
     
'    If MobileSocket(GetMobSocketIndex).State = sckConnected Then
'        MobileSocket(GetMobSocketIndex).SendData MRspMessage
'
'    End If
                 
    If MobileSocket(Index).State = sckConnected Then
        MobileSocket(Index).SendData MRspMessage
         
    End If
End Sub



Public Function Generate_Code(ByVal Msisdn As Long) As Variant

Dim Dbase As Long
Dim Qbase As Integer
Dim nCode As Variant
Dim nRand As Integer
nRand = RandomNumber(9999, 1)
Dbase = Msisdn \ nRand
Qbase = Msisdn Mod nRand
nCode = Format(Dbase, "000000000")
Dim alpha As Variant
Dim l As Integer
Dim m As Integer
Dim alpha_code As Variant
l = 1
m = 0
While Mid$(nCode, l, 1) = "0"
      m = m + 1
      nCode = Right(nCode, Len(nCode) - 1)
Wend

For l = 1 To m
Select Case RandomNumber(26, 1):
            Case 1:  alpha = "A"
            Case 2:  alpha = "B"
            Case 3:  alpha = "C"
            Case 4:  alpha = "D"
            Case 5:  alpha = "E"
            Case 6:  alpha = "F"
            Case 7:  alpha = "G"
            Case 8:  alpha = "H"
            Case 9:  alpha = "I"
            Case 10: alpha = "J"
            Case 11: alpha = "K"
            Case 12: alpha = "L"
            Case 13: alpha = "M"
            Case 14: alpha = "N"
            Case 15: alpha = "O"
            Case 16: alpha = "P"
            Case 17: alpha = "Q"
            Case 18: alpha = "R"
            Case 19: alpha = "S"
            Case 20: alpha = "T"
            Case 21: alpha = "U"
            Case 22: alpha = "V"
            Case 23: alpha = "W"
            Case 24: alpha = "X"
            Case 25: alpha = "Y"
            Case 26: alpha = "Z"

  
  End Select
 alpha_code = alpha_code & alpha
 Next l
 '----------------------
'rand = nRand
'modula = Qbase
'nCode = alpha & nCode
'------------------------------
Generate_Code = alpha_code & nCode & ":" & nRand & ":" & Qbase

End Function

Public Function RandomNumber(Upper As Integer, _
     Lower As Integer) As Integer
    'Generates a Random Number BETWEEN the LOWER and UPPER values
    Randomize
    RandomNumber = Int((Upper - Lower + 1) * Rnd + Lower)
End Function


Public Function Verify_Code(ByVal Msisdn As Variant, ByVal auCode As Variant, ByVal nRandom As Integer, ByVal nModular As Integer, Optional ByVal NATID As Variant) As Boolean
Dim IntCode As Double

Dim l As Integer
Dim m As Integer
Dim alpha_code As Variant
l = 1
m = 0
While IsNumeric(Mid$(auCode, l, 1)) = False
      m = m + 1
      auCode = Right(auCode, Len(auCode) - 1)
           
Wend

IntCode = CStr((Val(auCode) * nRandom) + nModular)

If Val(NATID) <> 0 Then
   If CStr(CLng(Msisdn) + CLng(NATID)) = IntCode Then
     Verify_Code = True
    Else
    Verify_Code = False
    End If
Else
   If Msisdn = "0" & IntCode Then
     Verify_Code = True
    Else
    Verify_Code = False
  End If
End If
End Function


Private Sub CreateMonitors()
 Dim rstObj As ADODB.Recordset
 Dim strSQL As String
 Dim str2 As String
 Set rstObj = New ADODB.Recordset
 Dim i As Integer
 Dim col As Long
 Dim J As Integer
 i = 1
 col = 120
 
 On Error GoTo Err1
 'str2 = "select count(*) from em_merchants"
 dbConnection.Execute "delete from em_merchant_pos_index"
 strSQL = "select merchant_name, ipaddress, port,bin_code from em_merchants where connection_mode = 0 order by record_no asc"
 'rstObj.Open str2, dbConnection
 

 
' If rstObj.Fields(0).value > 0 Then
'    For j = 1 To rstObj.Fields(0).value
'       If IsObject(Label5(j)) Then
'
'       'Unload Label5(j)
'
'       End If
'    Next j
' End If
'
' rstObj.Close
 rstObj.Open strSQL, dbConnection
  
 Do While Not rstObj.EOF
    
    Load MchntLabel(i)
    Load MchControl(i)
    Load Line1(i)
    
'    Load MerchantSocket(i)
'    MerchantSocket(i).LocalPort = rstObj.Fields(2).Value
'    MerchantSocket(i).RemoteHost = rstObj.Fields(1).Value
'    MerchantSocket(i).Listen
'
        
    MchntLabel(i).Caption = rstObj.Fields(0).Value
    MchControl(i).Caption = "Start Service"
    MchntLabel(i).Visible = True
    MchControl(i).Visible = True
    
     MchntLabel(i).Left = col
     
     MchntLabel(i).Top = MchntLabel(i - 1).Top + 215
    
     MchControl(i).Top = MchControl(i - 1).Top + 215
     Line1(i).Y1 = MchControl(i - 1).Top + 215 + 100
     Line1(i).Y2 = MchControl(i - 1).Top + 215 + 100
     
     Line1(i).X1 = MchControl(i - 1).Width + MchControl(i - 1).Left
     Line1(i).X2 = Line1(i).X1 + 2000
     Line1(i).Visible = True
     
    MchControl(i).BackColor = &HFF&
    MchntLabel(i).Appearance = 1
    MchntLabel(i).BackColor = &HFFC0C0
    MchControl(i).Value = vbChecked
    
    dbConnection.Execute ("INSERT INTO em_merchant_pos_index VALUES(" & i & "," & rstObj!Port & ",'" & rstObj!merchant_name & "','" & rstObj!IpAddress & "','" & rstObj!bin_code & "',0,0)")
    Call UpdateUptime(rstObj!merchant_name, 0)
     
    rstObj.MoveNext
    i = i + 1
 Loop
 rstObj.Close
 
 Exit Sub
Err1:
  EventsTrap = EventsTrap & vbNewLine & "Process CreateMonitors " & err.Description
 
End Sub
Private Sub InsertNewCon(ByVal ip As String)
 On Error GoTo ErrTrap
 Dim rstCom As ADODB.Command
 Dim strSQL As String
 
 strSQL = "INSERT INTO pos_branch " & _
          " VALUES (" & "'" & ip & "',null,null) "

 dbConnection.Execute strSQL
Exit Sub
ErrTrap:

EventsTrap = EventsTrap & vbNewLine & "Process InsertNewCon " & err.Description
 
End Sub

Private Sub Rates_Click()
If frmODBCLogon.LOGINSUCCESS = 1 Then
currload.Show
Else
frmODBCLogon.FORMNAME = 2
frmODBCLogon.Show
End If
End Sub

Private Sub Settings_Click()
Encrypt.Show vbModal
End Sub

Private Sub Stop_Click()
On Error GoTo Quit
Dim RecSet As New ADODB.Recordset
RecSet.Open "select node_name from em_merchant_pos_index", dbConnection
Do While RecSet.EOF = False

Call UpdateUptime(RecSet!Node_Name, 0)
RecSet.MoveNext
Loop

Shell "taskkill.exe /f /t /im iGateway.exe"
Quit:
End
End Sub

Private Sub switchedIn_Click()

If frmODBCLogon.LOGINSUCCESS = 1 Then
Interface.Show

Else
frmODBCLogon.FORMNAME = 5
frmODBCLogon.Show

End If

End Sub

Private Sub Timer1_Timer()
Call ConnectionPolling
Call IsConnectionPolling
Call DbConnection_Monitor
End Sub

Private Sub viewMerchant_Click()
'Frame5.Visible = True
'Command1.Visible = False
'Adodc1.Visible = True
End Sub

Public Sub ResetIndex()
    Dim i As Integer
    
    'initialize array bit to zero
    Erase DisConPointerArray()
    Erase IssConPointerArray()
    Erase MobileSocketArray()
    Erase TransTimers()
    ReDim DisConPointerArray(1 To 2000)
    ReDim IssConPointerArray(1 To 600)
    ReDim MobileSocketArray(1 To 600)
    ReDim TransTimers(1 To 600)
    ReDim TRACEFILE(1 To 600)
    For i = 1 To 600
        MobileSocketArray(i) = 0
        DisConPointerArray(i) = 0
        IssConPointerArray(i) = 0
        TransTimers(i) = 0
        TRACEFILE(i) = 0
    Next i
End Sub
Public Function GetMobIndex() As Integer
    Dim i As Integer
    Dim J As Integer
    GetMobIndex = 1
    For i = 1 To 600
        J = MobileSocketArray(i)
        If J = 0 Then
        GetMobIndex = i
        i = 600
        Exit Function
        End If
    Next i
End Function


Public Function GetMobSocketIndex() As Integer
    Dim i As Integer
    Dim J As Integer
    GetMobSocketIndex = 1
    For i = 1 To 600
        J = MobileSocketArray(i)
        If J = 1 Then
        GetMobSocketIndex = i
        i = 600
        Exit Function
        End If
    Next i
End Function

Public Function GetIndex(ByVal baseIndex As Integer) As Integer
    Dim i As Long
    Dim J As Long
    
'    If baseIndex = 1 Then
'        For i = (baseIndex + 1) To (baseIndex * 199)
'            J = DisConPointerArray(i)
'            If J = 0 Then
'            GetIndex = i
'            i = 200 'baseIndex * 10 + 10
'            Exit Function
'            End If
'        Next i
'    ElseIf baseIndex = 2 Then
'        For i = (baseIndex * 100 + 1) To (baseIndex * 100 + 200 - 1)    ' baseIndex * 10 +1 to (baseIndex * 10 +10)
'            J = DisConPointerArray(i)
'            If J = 0 Then
'            GetIndex = i
'            i = baseIndex * 100 + 200
'            Exit Function
'            End If
'        Next i
'    Else
        For i = (baseIndex * 1 * 10 - 10 + 1) To (baseIndex * 1 * 10) ' baseIndex * 10 +1 to (baseIndex * 10 +10)
            J = DisConPointerArray(i)
            If J = 0 Then
            GetIndex = i
            i = baseIndex * 1 * 10  ' i = baseIndex * 2 * 200
            Exit Function
            End If
        Next i
    'End If
End Function
Public Function GetIsIndex(ByVal baseIndex As Integer) As Integer
    Dim i As Integer
    Dim J As Integer
    For i = (baseIndex * 10 + 1) To (baseIndex * 10) + 10
        J = IssConPointerArray(i)
        If J = 0 Then
        GetIsIndex = i
        IssConPointerArray(i) = 1
        i = baseIndex * 10 + 10
        Exit Function
        End If
    Next i
End Function

Public Function GetIndexOut(ByVal baseIndex As Integer) As Integer
    Dim i As Integer
    Dim J As Integer
    For i = (baseIndex * 1 * 10 - 10 + 1) To (baseIndex * 1 * 10)
        J = DisConPointerArray(i)
        If J = 1 Then
        GetIndexOut = i
        i = baseIndex * 1 * 10
        Exit Function
        End If
    Next i
End Function


Public Function GetTranTimerIndex() As Integer
    Dim i As Integer
    Dim J As Integer
    GetTranTimerIndex = 1
    For i = 1 To 600
        J = TransTimers(i)
        If J = 0 Then
        GetTranTimerIndex = i
        i = 600
        Exit Function
        End If
    Next i
End Function

Public Sub ConnectionPolling()
Dim i As Integer
Dim J As Integer
Dim State As Boolean
'state = False
On Error GoTo ErrTrap
For i = 1 To MchControl.UBound
State = False
  For J = i * 10 - 10 + 2 To i * 10

       If DisConPointerArray(J) = 1 Then
       State = True
       J = i * 10
       End If
   
      If State = True Then
      MchControl(i).Caption = "Online"
      MchControl(i).BackColor = &HFFC0C0    '&H8000000F
      Line1(i).BorderColor = &H404040
      ElseIf State = False And MchControl(i).Value = vbChecked Then
      MchControl(i).Caption = "Offline"
      MchControl(i).BackColor = &HFF&
      Line1(i).BorderColor = &HFF&
      'Call UpdateUptime(MchntLabel(i).Caption, 0)
       
      ElseIf State = False And MchControl(i).Value = vbUnchecked Then
      MchControl(i).Caption = "Start Service"
      MchControl(i).BackColor = &HFF&
      Line1(i).BorderColor = &HFF&
      
      'Call UpdateUptime(MchntLabel(i).Caption, 0)
     End If

    Next J

  
  Next i
Exit Sub
ErrTrap:
EventsTrap = EventsTrap & vbNewLine & " Process ConnectionPolling: " & err.Description


End Sub

Private Sub MchControl_Click(Index As Integer)
 On Error GoTo Err1
 Dim J As Integer
 Dim K As Integer
  If MchControl(Index).Value = vbUnchecked Then
    For J = Index * 1 * 100 - 100 + 1 To Index * 1 + 100
      If DisConPointerArray(J) > 0 Then
         MerchantSocket(J).Close
         Unload MerchantSocket(J)
         DisConPointerArray(J) = 0
'          MerchantSocket(Index).Close
'          Unload MerchantSocket(Index)
'          DisConPointerArray(Index) = 0
      End If
      
    Next J
    
    MchControl(Index).Caption = "Start Service"
    MchControl(Index).BackColor = &HFF&
    Else
    
    Call StartServcie(Index)
    End If
    Exit Sub
Err1:
    EventsTrap = EventsTrap & vbNewLine & "Process MchControl_Click " & err.Description
    MchControl(Index).Caption = "Start Service"
    MchControl(Index).BackColor = &HFF&

End Sub
Private Sub StartServcie(ByVal Index As Integer)
 Dim rstObj As ADODB.Recordset
 Dim strSQL As String
 Dim str2 As String
 Set rstObj = New ADODB.Recordset
 Dim i As Integer
 Dim col As Long
 Dim J As Integer
 i = 1
 col = 120
 On Error GoTo ErrHandler5
 
 strSQL = "select merchant_name, ipaddress, port from em_merchants where merchant_name = " & "'" & MchntLabel(Index).Caption & "'"
 
 rstObj.Open strSQL, dbConnection
  
 Do While Not rstObj.EOF
    J = GetIndex(Index)
    Load MerchantSocket(J)
    MerchantSocket(J).LocalPort = rstObj.Fields(2).Value
    MerchantSocket(J).Listen
    DisConPointerArray(J) = 2
    
'    Load MerchantSocket(Index)
'    MerchantSocket(Index).LocalPort = rstObj.Fields(2).value
'    MerchantSocket(Index).Listen
'    DisConPointerArray(Index) = 0
    
    
    rstObj.MoveNext
 Loop
 rstObj.Close
 
 Exit Sub
ErrHandler5:
  EventsTrap = EventsTrap & vbNewLine & "Process StartService " & err.Description
 
End Sub
Public Function SelectTransQuery(ByVal Constr As Connection, ByVal str As String) As Recordset
   On Error GoTo eRRW
    Dim rstTarget As ADODB.Recordset
    Set rstTarget = New ADODB.Recordset
    
    rstTarget.Open str, Constr, adOpenStatic, adLockReadOnly
    Set SelectTransQuery = rstTarget.Clone

    rstTarget.Close
    Set rstTarget = Nothing
    
eRRW:
txt_log.Text = txt_log.Text & vbNewLine & "Process SelectTransQuery " & err.Description
End Function
Public Sub Fire_SQL1(ByVal Constr As Connection, ByVal str As String, ByVal Ctype As Integer, ByRef RecST As Recordset, ByRef Error_Flag As Integer)
On Error GoTo eRRW1
    If Ctype = 1 Then
    Set RecST = SelectTransQuery(Constr, str)
    ElseIf Ctype = 0 Then
    Constr.Execute str
    End If
Error_Flag = 0
Exit Sub
eRRW1:
txt_log.Text = txt_log.Text & vbNewLine & "Process Fire_SQL1 " & err.Description
Error_Flag = 1
End Sub

Private Sub SwitchSocket_Close(Index As Integer)
On Error GoTo ErrorTrap
dbConnection.Execute ("update  em_merchant_pos_index set status = 0 WHERE pindex = " & Left(Index, 1) & " and mode = 1")
SwitchSocket(Index).Close

Dim RecSet As New ADODB.Recordset

RecSet.Open "Select * from em_merchant_pos_index where pindex = " & Left(Index, 1) & " and mode= 1", dbConnection
If RecSet.EOF = False Then
    Call UpdateUptime(RecSet!Node_Name, 0)
End If

ErrorTrap:

End Sub

Private Sub SwitchSocket_Connect(Index As Integer)
Dim i As Integer
Dim col As Integer
Dim ip As String
Dim Port As Long

Dim RecSet As New ADODB.Recordset
i = GetIsIndex(Index)
On Error GoTo ErrorTrap

dbConnection.Execute ("update  em_merchant_pos_index set status = 0 WHERE pindex = " & Left(i, 1) & " and mode = 1")

RecSet.Open "Select * from em_merchant_pos_index where pindex = " & Left(i, 1) & " and mode= 1", dbConnection
If RecSet.EOF = False Then
    Call UpdateUptime(RecSet!Node_Name, 1)
End If
  RecSet.Close

ErrorTrap:

End Sub

Private Sub SwitchSocket_DataArrival(Index As Integer, ByVal bytesTotal As Long)
    Dim SwtchResonse As String
    Dim MessageFromSwitch As String
    Dim StrMessageTOProcess As String
    Dim intStreamLen As Integer
    Dim intMsgLength As Integer
    On Error GoTo err
    Dim RecSet As New ADODB.Recordset
    SwitchSocket(Index).GetData SwtchResonse
    MessageFromSwitch = SwtchResonse
    
    Dim Recv_port As Long
    Dim Recv_ip As String
    Dim Source_Key As String
    
        Recv_port = SwitchSocket(Index).RemotePort
        Recv_ip = SwitchSocket(Index).RemoteHostIP
        
             RecSet.Open "Select node_Name from em_merchant_pos_index where ip_address = '" & Recv_ip & "' And Port =" & Recv_port & " and mode = 1", dbConnection
            If RecSet.EOF = False Then
                Source_Key = Index & "_" & RecSet!Node_Name & "_" & Recv_port & ":1"
                
                
                Do While MessageFromSwitch <> ""
                     
                     intStreamLen = Len(MessageFromSwitch)
                     intMsgLength = GetMsgLen(Mid(MessageFromSwitch, 1, 4))           ' get message length
                     
                     StrMessageTOProcess = Mid(MessageFromSwitch, 1, intMsgLength)    ' get message from stream
                     
                     If Mid(StrMessageTOProcess, 5, 4) = "0200" Then
                     ProcessMerchantMessage0200 StrMessageTOProcess, Source_Key, RecSet!Node_Name
                     ElseIf Mid(StrMessageTOProcess, 5, 4) = "0210" Then
                     ProcessMerchantMessage0210 StrMessageTOProcess, Source_Key, RecSet!Node_Name
                     ElseIf Mid(StrMessageTOProcess, 5, 4) = "0230" Then
                     ProcessMerchantMessage0230 StrMessageTOProcess, Source_Key, RecSet!Node_Name
                     ElseIf Mid(StrMessageTOProcess, 5, 4) = "0430" Then
                     ProcessMerchantMessage0430 StrMessageTOProcess, Source_Key, RecSet!Node_Name
                     ElseIf Mid(StrMessageTOProcess, 5, 4) = "0420" Then
                     ProcessMerchantMessage0420 StrMessageTOProcess, Source_Key, RecSet!Node_Name
                     End If
                     
                     MessageFromSwitch = Mid(MessageFromSwitch, intMsgLength + 1, intStreamLen - intMsgLength)  ' return rest of the stream
                    MessageFromSwitch = ""
                Loop
                            
                'Switch_Message_Processor MessageFromSwitch, Index
                SwtchResonse = ""
                End If
  Exit Sub
err:
  txt_log.Text = txt_log.Text & vbNewLine & "Process SwitchSocket_DataArrival " & err.Description
End Sub

Private Sub SwitchSocket_Error(Index As Integer, ByVal Number As Integer, Description As String, ByVal Scode As Long, ByVal Source As String, ByVal HelpFile As String, ByVal HelpContext As Long, CancelDisplay As Boolean)
   SwitchSocket(Index).Close
   'Unload SwitchSocket(Index)
   'IssConPointerArray(Index) = 0


End Sub
Public Sub IsConnectionPolling()
Dim i As Integer
Dim J As Integer
Dim State As Boolean
'state = False
On Error GoTo ErrHandler5
For i = 1 To IsControl.UBound
State = False
  
'    If IssConPointerArray(i) > 0 Then
'         State = True
'    End If
'
'    If State = True Then
       If SwitchSocket(i).State <> sckConnected Then
      
              Dim rstObj As New ADODB.Recordset
              Dim strSQL As String
              
              
              IsControl(i).Caption = "Offline"
              IsControl(i).BackColor = &HFF&
              IsControl(i).Value = vbUnchecked
              Line2(i).BorderColor = &HFF&
              
              strSQL = "select merchant_name, ipaddress, port,bin_code from em_merchants where connection_mode = 1 and merchant_name = " & "'" & IssLabel(i).Caption & "'"
              'Call UpdateUptime(IssLabel(i).Caption, 0)
                                                                              'strSQL = "select top 1 node_name, ipaddress, port from em_ISSUERS where merchant_name = " & "'" & IssLabel(i).Caption & "'"
              rstObj.Open strSQL, dbConnection
        
              If rstObj.EOF = False Then
              'Load SwitchSocket(Index)
              SwitchSocket(i).Close
              SwitchSocket(i).RemotePort = rstObj.Fields(2).Value
              SwitchSocket(i).RemoteHost = rstObj.Fields(1).Value
              SwitchSocket(i).Connect
              IssConPointerArray(i) = 1
              rstObj.Close
              
              
              End If
        Else
            IsControl(i).Value = vbChecked
            IsControl(i).Caption = "Online"
            IsControl(i).BackColor = &HFFC0C0
            Line2(i).BorderColor = &H404040
        End If
'     ElseIf State = False And IsControl(i).value = vbChecked Then
'      IsControl(i).Caption = "Offline"
'      IsControl(i).BackColor = &HFF&
'
'     ElseIf State = False And IsControl(i).value = vbUnchecked Then
'      IsControl(i).Caption = "Start Service"
'      IsControl(i).BackColor = &HFF&
'
'    End If
    
  Next i
Exit Sub

ErrHandler5:
EventsTrap = EventsTrap & vbNewLine & "Process IsConnectionPolling " & err.Description
End Sub

Private Sub IsControl_Click(Index As Integer)
'On Error GoTo Err1
 Dim J As Integer
 Dim K As Integer
'   If IsControl(Index).Value = vbUnchecked Then
'
'    SwitchSocket(Index).Close
'    Unload SwitchSocket(Index)
'    IsControl(Index).Caption = "Start Service"
'    IsControl(Index).BackColor = &HFF&
'    IssConPointerArray(Index) = 0
'    Else
'
'    Call IsStartServcie(Index)
'    End If
Exit Sub
Err1:
    EventsTrap = EventsTrap & vbNewLine & err.Description
    IsControl(Index).Caption = "Start Service"
    IsControl(Index).BackColor = &HFF&

End Sub
Private Sub IsStartServcie(ByVal Index As Integer)
 Dim rstObj As ADODB.Recordset
 Dim strSQL As String
 Dim str2 As String
 Set rstObj = New ADODB.Recordset
 Dim i As Integer
 Dim col As Long
 Dim J As Integer
 i = 1
 col = 120
 On Error GoTo ErrHandler5
 
 strSQL = "select merchant_name, ipaddress, port from em_merchants where merchant_name = " & "'" & IssLabel(Index).Caption & "'"
  'strSQL = "select node_name, ipaddress, port from em_merchants where node_name = " & "'" & IssLabel(Index).Caption & "'"
  rstObj.Open strSQL, dbConnection
  
 Do While Not rstObj.EOF
        
    Load SwitchSocket(Index)
    SwitchSocket(Index).RemotePort = rstObj.Fields(2).Value
    SwitchSocket(Index).RemoteHost = rstObj.Fields(1).Value
    SwitchSocket(Index).Connect
    IssConPointerArray(Index) = 1
    IsControl(i).Value = vbChecked
    
    rstObj.MoveNext
 Loop
 rstObj.Close
 
 Exit Sub
ErrHandler5:
  EventsTrap = EventsTrap & vbNewLine & "Process IsStartService " & err.Description
 
End Sub

Private Sub IsCreateMonitors()
 Dim rstObj As ADODB.Recordset
 Dim strSQL As String
 Dim str2 As String
 Set rstObj = New ADODB.Recordset
 Dim i As Integer
 Dim col As Long
 Dim J As Integer
 i = 1
 col = 120
' str2 = "select count(*) from em_isseurs"
' dbConnection.Execute "delete from em_Issuer_pos_index"
 'strSQL = "select node_name, ipaddress, port from em_issuers order by record_no asc"
 
 On Error GoTo ErrTrap
 
 
  strSQL = "select merchant_name, ipaddress, port,bin_code from em_merchants where connection_mode = 1 order by record_no asc"
  rstObj.Open strSQL, dbConnection
  
 While Not rstObj.EOF
    
    Load IssLabel(i)
    Load IsControl(i)
    Load Line2(i)
    IssLabel(i).Caption = rstObj.Fields(0).Value
    IsControl(i).Caption = "Offline"
    IssLabel(i).Visible = True
    IsControl(i).Visible = True
    
     IssLabel(i).Left = col
     
     IssLabel(i).Top = IssLabel(i - 1).Top + 215
    'End If
     IsControl(i).Top = IsControl(i - 1).Top + 215
     IsControl(i).BackColor = &HFF&
        IssLabel(i).Appearance = 1
        IssLabel(i).BackColor = &HFFC0C0
        
        Load SwitchSocket(i)
        SwitchSocket(i).RemotePort = rstObj.Fields(2).Value
        SwitchSocket(i).RemoteHost = rstObj.Fields(1).Value
        SwitchSocket(i).Connect
        IssConPointerArray(i) = 1
        
        
     Line2(i).Y1 = IsControl(i - 1).Top + 215 + 100
     Line2(i).Y2 = IsControl(i - 1).Top + 215 + 100
     Line2(i).X1 = IsControl(i - 1).Width + IsControl(i - 1).Left
     Line2(i).X2 = Line2(i).X1 + 2000
     Line2(i).Visible = True
                
       dbConnection.Execute ("INSERT INTO em_merchant_pos_index VALUES(" & i & "," & rstObj!Port & ",'" & rstObj!merchant_name & "','" & rstObj!IpAddress & "','" & rstObj!bin_code & "',1,0)")
       Call UpdateUptime(rstObj!merchant_name, 0)
       
    rstObj.MoveNext
    i = i + 1
 Wend
 rstObj.Close
 
 Exit Sub
 
ErrTrap:
  EventsTrap = EventsTrap & vbNewLine & "Process IsCreateMonitor " & err.Description
 
End Sub

'Private Sub RoutingProcessing(ByVal strStream As String)
'    Dim strMessageStream As String
'    Dim strMessageToProcess As String
'    Dim StrMessageToSend As String
'    Dim intMsgLength As Integer
'    Dim intStreamLen As Integer
'    Dim Trace As String
'    On Error GoTo ErrorTrap
'
'    strMessageStream = strStream
'    Do While strMessageStream <> ""
'        intStreamLen = Len(strMessageStream)
'        intMsgLength = GetMsgLen(Mid(strMessageStream, 1, 2))           ' get message length
'
'        strMessageToProcess = Mid(strMessageStream, 1, intMsgLength)    ' get message from stream
'
'        ' process message
'        Select Case Mid(strMessageToProcess, 5, 2)
'            Case "00", "20", "21"  'all ksw Cards requests
'                'Call PostilionMessage(strMessageToProcess, StrMessageToSend, Trace)
'                'SendMessageToKenswitch StrMessageToSend
'            Case "10", "30"
'                'SendMessageToKenswitch strMessageToProcess
'                Case Else
'            ' not handled
'        End Select
'
''        If FrmTrace.Command1.Caption = "Stop" And Trace <> "" Then
''          FrmTrace.Text1 = FrmTrace.Text1 & "Message To Kenswitch: " & vbNewLine & Trace
''        End If
''        ' process rest of stream
'        strMessageStream = Mid(strMessageStream, intMsgLength + 1, intStreamLen - intMsgLength)  ' return rest of the stream
'
'
'    Loop
'
'
'    Exit Sub
'ErrorTrap:
'    Text1.Text = Text1.Text & vbNewLine & err.Description
'End Sub


Private Sub TmrProcessor_Timer()
If EventsTrap <> "" Then
Command4.BackColor = &HFF
Else
Command4.BackColor = &HE0E0E0
End If
  
End Sub

Private Function GetID(ByVal cust_id As String) As Long
       Dim strTest As String
       Dim strOutput As Variant
       Dim i As Integer
      
       strTest = cust_id
       'loop trough the string strTest'
       For i = 1 To Len(strTest)
         'using the ascii code for the numbers only (they are from 48 to 57) we filter them and add them to output string'
          If (Asc(Mid$(strTest, i, 1)) > 47) And (Asc(Mid$(strTest, i, 1)) < 58) Then
              strOutput = strOutput & Mid$(strTest, i, 1)
          End If
       Next i
      'display the output string'
      GetID = Val(strOutput)
End Function
Private Sub SoapMessageFormatter(ByRef Message As String, ByVal Source_Key As String)
 Dim MSoap As New SoapProjectDll.Mpesa
 With MSoap
 .field_002_Pan = "5555555345777776"
 .field_004_AmountTransaction = "200"
 .field_007_TransmissionDateTime = "1126164513"
 .field_011_TraceNumber = "000234"
 .field_012_LocalTransactionTime = "164513"
 .field_013_LocalTransactionDate = "1126"
 .field_015_SettlementDate = "1127"
 .field_018_MerchantCategoryCode = "6011"
 .field_032_AcquirerBIN = "565767"
 .field_037_ReferenceNumber = "000000012345"
 .field_041_TerminalID = "10100181"
 .field_042_TerminalLocation = "12345678912345"
 .field_043_TerminalAddress = "Nakumatt Junction Supermarket"
 .field_046_Fees = "15"
 .field_049_CurrencyCode = "404"
 .field_MessageType = "0200"
 .field_VMT_MSISDN = "0720677928"
 .field_VMT_ShortCode = "555555"
 .field_VMT_TerminalType = "PPT 045"
 .field_VTM_AcquirerName = "PESAPOINT"
 Message = .BuildSoapMessage("0200", "01", "http://www.payme.com/payserv", "4754")
  
 
 End With

End Sub

Private Sub Command1_Click()
On Error GoTo ErrTrap
 Dim rstObj As ADODB.Recordset
 Dim strSQL As String
 Dim str2 As String
 Set rstObj = New ADODB.Recordset
 Dim i As Integer
 Dim col As Long
 Dim J As Integer
 i = MchntLabel.UBound + 1
 col = 120
 strSQL = "select merchant_name, ipaddress, port,bin_code from em_merchants where connection_mode = 0 and bin_code not in (select bin_code from em_merchant_pos_index where mode  = 0) ORDER BY record_no asc"
 rstObj.Open strSQL, dbConnection
  
 Do While Not rstObj.EOF
    
    Load MchntLabel(i)
    Load MchControl(i)
        
    MchntLabel(i).Caption = rstObj.Fields(0).Value
    MchControl(i).Caption = "Start Service"
    MchntLabel(i).Visible = True
    MchControl(i).Visible = True
    
     MchntLabel(i).Left = col
     
     MchntLabel(i).Top = MchntLabel(i - 1).Top + 215
    'End If
     MchControl(i).Top = MchControl(i - 1).Top + 215
    MchControl(i).BackColor = &HFF&
    MchntLabel(i).Appearance = 1
    MchntLabel(i).BackColor = &HFFC0C0
    
    dbConnection.Execute ("INSERT INTO em_merchant_pos_index VALUES(" & i & "," & rstObj!Port & ",'" & rstObj!merchant_name & "','" & rstObj!IpAddress & "','" & rstObj!bin_code & "',0,0)")
          
    rstObj.MoveNext
    i = i + 1
 Loop
 rstObj.Close
 
 
  i = IssLabel.UBound + 1
 
  strSQL = "select merchant_name, ipaddress, port,bin_code from em_merchants where connection_mode = 1 and bin_code not in (select bin_code from em_merchant_pos_index where mode  = 1) ORDER BY record_no asc"
  rstObj.Open strSQL, dbConnection
  
 While Not rstObj.EOF
    
    Load IssLabel(i)
    Load IsControl(i)
        
    IssLabel(i).Caption = rstObj.Fields(0).Value
    IsControl(i).Caption = "Offline"
    IssLabel(i).Visible = True
    IsControl(i).Visible = True
    
     IssLabel(i).Left = col
     
     IssLabel(i).Top = IssLabel(i - 1).Top + 215
    'End If
     IsControl(i).Top = IsControl(i - 1).Top + 215
     IsControl(i).BackColor = &HFF&
        IssLabel(i).Appearance = 1
        IssLabel(i).BackColor = &HFFC0C0
        
        Load SwitchSocket(i)
        SwitchSocket(i).RemotePort = rstObj.Fields(2).Value
        SwitchSocket(i).RemoteHost = rstObj.Fields(1).Value
        SwitchSocket(i).Connect
        IssConPointerArray(i) = 1
                
       dbConnection.Execute ("INSERT INTO em_merchant_pos_index VALUES(" & i & "," & rstObj!Port & ",'" & rstObj!merchant_name & "','" & rstObj!IpAddress & "','" & rstObj!bin_code & "',1,0)")
            
    rstObj.MoveNext
    i = i + 1
 Wend
 rstObj.Close
Exit Sub
ErrTrap:
 EventsTrap = txt_log.Text & vbNewLine & "Process Recync New Server Sockets " & err.Description
    

End Sub

Private Sub sckClientPostilion_Close()
    
    sckClientPostilion.Close
    sckClientPostilion.RemoteHost = POSTILION_IP
    sckClientPostilion.RemotePort = POSTILION_PORT
End Sub

Private Sub sckClientPostilion_Connect()
If sckClientPostilion.State = sckConnected Then
   'Text1.Text = Text1.Text & vbNewLine & "POSTILION KENSWITCH INTERCHANGE CONNECTED"
End If
End Sub

Private Sub sckClientPostilion_DataArrival(ByVal bytesTotal As Long)
    Dim strData As String
    Dim ServaData As String
    sckClientPostilion.GetData strData
    ServaData = ServaData & strData
    If bytesTotal = 8096 Then DoEvents ' excess data, more incoming datagrams
    
    'ProcessPostilionStream ServaData
End Sub

Private Sub sckClientPostilion_Error(ByVal Number As Integer, Description As String, ByVal Scode As Long, ByVal Source As String, ByVal HelpFile As String, ByVal HelpContext As Long, CancelDisplay As Boolean)
     ' close socket forcefully
    sckClientPostilion.Close
        
    ' set server parameters
    sckClientPostilion.RemoteHost = POSTILION_IP
    sckClientPostilion.RemotePort = POSTILION_PORT
    'Text1.Text = IIf(Text1.Text <> "", Text1.Text & vbNewLine, "") & "Positilion Kenswitch Socket Error" & vbNewLine & Description
End Sub

Private Sub ProcessPostilionStream(ByVal strStream As String)
    Dim strMessageStream As String
    Dim StrMessageTOProcess As String
    Dim StrMessageToSend As String
    Dim intMsgLength As Integer
    Dim intStreamLen As Integer
    Dim Trace As String
    Dim LenMSG As Integer
    Dim Raw_Trace As String
    On Error GoTo ErrorTrap
    
    strMessageStream = strStream
'     Do While strMessageStream <> ""
'        LenMSG = Len(strMessageStream)
'        intStreamLen = Len(strMessageStream)
'        intMsgLength = GetMsgLen(Mid(strMessageStream, 1, 2))           ' get message length
'
        StrMessageTOProcess = Mid(strMessageStream, 1, intMsgLength)    ' get message from stream
        'Raw_Trace = Mid(strMessageToProcess, 23, Len(strMessageToProcess) - 22)
        ' process message
       ' Select Case Mid(strMessageToProcess, 5, 2)
            
                Call PostilionMessage(strMessageStream, StrMessageToSend, Trace)
                           
        'End Select
        
      ' Loop
    
    
    Exit Sub
ErrorTrap:
    EventsTrap = txt_log.Text & vbNewLine & "Process ProcessPostilionStream " & err.Description
    
End Sub

Private Sub PostilionMessage(ByVal Message As String, ByRef StrMsgToSend As String, Optional ByRef Trace As String)
    On Error GoTo ErrorTrap
    Dim PostMsg As PostBridgeISO8583
    Dim strNewMessage As String
    Trace = ""
    Set PostMsg = New PostBridgeISO8583
    
    
    With PostMsg
        .ISO8583MsgBD Message
        .ResetBitMaps
        
        If .MessageTypeID = "0210" Or .MessageTypeID = "0430" Then
        .AmtTransaction = .AmtSettlement
        .CurrencyCodeTxn = .CurrencyCodeSettle
        End If
        
        ' add rest of the required fields
        Trace = "Message type: " & .MessageTypeID & vbNewLine
        If .Pan <> "" Then .CreatePBBitMap (2): Trace = Trace & "Field 002: " & .Pan & vbNewLine
        If .ProcessingCODE <> "" Then .CreatePBBitMap (3): Trace = Trace & "Field 003: " & .ProcessingCODE & vbNewLine
        If .AmtTransaction <> "" Then .CreatePBBitMap (4)
        If .DatetimeTransmission <> "" Then .CreatePBBitMap (7): Trace = Trace & "Field 007: " & .DatetimeTransmission & vbNewLine
        If .SysTraceAuditNum <> "" Then .CreatePBBitMap (11): Trace = Trace & "Field 011: " & .SysTraceAuditNum & vbNewLine
        If .TimeLocTxn <> "" Then .CreatePBBitMap (12): Trace = Trace & "Field 012: " & .DateLocTxn & vbNewLine
        If .DateLocTxn <> "" Then .CreatePBBitMap (13): Trace = Trace & "Field 013: " & .TimeLocTxn & vbNewLine
        If .DateExpiry <> "" Then .CreatePBBitMap (14): Trace = Trace & "Field 014: " & .DateExpiry & vbNewLine
        If .DateSettle <> "" Then .CreatePBBitMap (15): Trace = Trace & "Field 015: " & .DateSettle & vbNewLine
        If .MerchantType <> "" Then .CreatePBBitMap (18): Trace = Trace & "Field 018: " & .MerchantType & vbNewLine
        If .POSEntryMode <> "" Then .CreatePBBitMap (22): Trace = Trace & "Field 022: " & .POSEntryMode & vbNewLine
        If .CardSeqNum <> "" Then .CreatePBBitMap (23): Trace = Trace & "Field 023: " & .CardSeqNum & vbNewLine
        If .POSConditionCode <> "" Then .CreatePBBitMap (25): Trace = Trace & "Field 025: " & .POSConditionCode & vbNewLine
        If .POSPinCaptureCode <> "" Then .CreatePBBitMap (26): Trace = Trace & "Field 026: " & .POSPinCaptureCode & vbNewLine
        If .AmtTxnFee <> "" Then .CreatePBBitMap (28): .AmtTxnFee = "C00000000": Trace = Trace & "Field 028: " & .AmtTxnFee & vbNewLine
        If .AmtTxnProcessingFee <> "" Then .CreatePBBitMap (30): Trace = Trace & "Field 030: " & .AmtTxnProcessingFee & vbNewLine
        If .AcquiringInstIdCode <> "" Then .CreatePBBitMap (32): Trace = Trace & "Field 032: " & .AcquiringInstIdCode & vbNewLine
        If .ForwardingInstIdCode <> "" Then .CreatePBBitMap (33): Trace = Trace & "Field 033: " & .ForwardingInstIdCode & vbNewLine
        If .Track2Data <> "" Then .CreatePBBitMap (35): Trace = Trace & "Field 035: " & .Track2Data & vbNewLine
        If .RetrievalRefNum <> "" Then .CreatePBBitMap (37): Trace = Trace & "Field 037: " & .RetrievalRefNum & vbNewLine
        If .AuthIdResp <> "" Then .CreatePBBitMap (38): Trace = Trace & "Field 038: " & .AuthIdResp & vbNewLine
        If .RespCode <> "" Then .CreatePBBitMap (39): Trace = Trace & "Field 039: " & .RespCode & vbNewLine
        If .ServiceRestrictionCode <> "" Then .CreatePBBitMap (40): Trace = Trace & "Field 040: " & .ServiceRestrictionCode & vbNewLine
        If .CardAcceptorTermId <> "" Then .CreatePBBitMap (41): Trace = Trace & "Field 041: " & .CardAcceptorTermId & vbNewLine
            
        If .CardAcceptorIdCode <> "" Then .CreatePBBitMap (42): Trace = Trace & "Field 042: " & .CardAcceptorIdCode & vbNewLine
        If .CardAcceptorNameLoc <> "" Then .CreatePBBitMap (43): Trace = Trace & "Field 043: " & .CardAcceptorNameLoc & vbNewLine
        If .AdditionalRespData <> "" Then .CreatePBBitMap (44):: Trace = Trace & "Field 044: " & .AdditionalRespData & vbNewLine
        If .AdditionalData <> "" Then .CreatePBBitMap (48): Trace = Trace & "Field 048: " & .AdditionalData & vbNewLine
        If .CurrencyCodeTxn <> "" Then .CreatePBBitMap (49): Trace = Trace & "Field 049: " & .CurrencyCodeTxn & vbNewLine
        If .PinData <> "" Then .CreatePBBitMap (52): Trace = Trace & "Field 052: " & "****************" & vbNewLine
        If .AdditionalAmts <> "" Then .CreatePBBitMap (54): Trace = Trace & "Field 054: " & .AdditionalAmts & vbNewLine
        If .MsgReasonCode <> "" Then .CreatePBBitMap (56): Trace = Trace & "Field 056: " & .MsgReasonCode & vbNewLine
        If .EchoData <> "" Then .CreatePBBitMap (59): Trace = Trace & "Field 059: " & .EchoData & vbNewLine
        If .NetMangtInfoCode <> "" Then .CreatePBBitMap (70): Trace = Trace & "Field 070: " & .NetMangtInfoCode & vbNewLine
        If .OriginalDataElements <> "" Then .CreatePBBitMap (90): Trace = Trace & "Field 090: " & .OriginalDataElements & vbNewLine
        If .ReplacementAmts <> "" Then .CreatePBBitMap (95): Trace = Trace & "Field 095: " & .ReplacementAmts & vbNewLine
        If .ReceivingInstIdCode <> "" Then .CreatePBBitMap (100): Trace = Trace & "Field 100: " & .ReceivingInstIdCode & vbNewLine
        If .AccIdOne <> "" Then .CreatePBBitMap (102): Trace = Trace & "Field 102: " & .AccIdOne & vbNewLine
        If .AccIdTwo <> "" Then .CreatePBBitMap (103): Trace = Trace & "Field 103: " & .AccIdTwo & vbNewLine
        If .POSDataCode <> "" Then .CreatePBBitMap (123): Trace = Trace & "Field 123: " & .POSDataCode & vbNewLine
                      
                    
        StrMsgToSend = .CREATEMsgISO8538
                     
              
        If .MessageTypeID = "0210" Or .MessageTypeID = "0430" Or .MessageTypeID = "0810" Then

           Dim Source_Key As String
           
           Source_Key = .AdditionalRespData
           
           If Source_Key <> "" Then
              If Right(Source_Key, 1) = 0 Then 'Merchant Socket Node
                        Source_Key = Left(Source_Key, Len(Source_Key) - 2)
                        'Call SendMessageToMerchant(StrMsgToSend, Val(Mid(SOURCE_KEY, 1, Len(SOURCE_KEY) - InStr(1, SOURCE_KEY, "_"))))

              ElseIf Right(Source_Key, 1) = 1 Then
                        Source_Key = Left(Source_Key, Len(Source_Key) - 2)
                        'Call SendMessageToSwitch(StrMsgToSend, Val(Mid(SOURCE_KEY, 1, Len(SOURCE_KEY) - InStr(1, SOURCE_KEY, "_"))))

              End If
 
           End If
       Else
       EventsTrap = txt_log.Text & vbNewLine & "Unsuported message type " & .MessageTypeID & " received from ASA"
       End If
                
        End With
        Exit Sub
ErrorTrap:

EventsTrap = txt_log.Text & vbNewLine & "Process ASAMessage " & err.Description
     
End Sub


Public Sub SendMessageToPostilion(ByVal PMessage As String, ByRef MsgSentIndicator As Integer)
''AttemptToSend:
On Error GoTo ErrorTrap
    If sckClientPostilion.State = sckConnected And PMessage <> "" Then
        sckClientPostilion.SendData PMessage
        MsgSentIndicator = 1
    Else
        If sckClientPostilion.State <> sckListening Then
           sckClientPostilion.Close
           sckClientPostilion.Connect POSTILION_IP, POSTILION_PORT
           MsgSentIndicator = 0
           ''GoTo AttemptToSend
        End If
    End If
ErrorTrap:

End Sub

Public Sub SendMessageToHSM(ByVal PMessage As String, ByRef MsgSentIndicator As Integer)
''AttemptToSend:
On Error GoTo ErrorTrap
    If HsmSck.State = sckConnected And PMessage <> "" Then
        HsmSck.SendData PMessage
        MsgSentIndicator = 1
    Else
       
           HsmSck.Close
           HsmSck.Connect HSM_IP, HSM_PORT
           MsgSentIndicator = 0
           
    End If
ErrorTrap:

End Sub

Public Sub CURRENCYPICK(ByVal SOURCE_COUNTRY_CODE As String, ByVal SOURCE_CURRENCY_CODE As String, ByVal SOURCE_AMOUNT As String, ByVal DESTINATION_COUNTRY_CODE As String, ByRef ExRate As String, ByRef DESTINANTION_CURRENCY_CODE As String, ByRef DESTINANTION_AMOUNT As String, ByRef BASE_AMOUNT As String, ByRef EXISTS As Boolean)
''AttemptToSend:

On Error GoTo ErrorTrap
Dim RecSet As New ADODB.Recordset
Dim Exchange1, Exchange2 As Double
Dim BaseCurrencyAmount As Double
Dim DestinationCurrencyAmount As Double
Dim Qstr As String
Qstr = "select fx_rate from em_currency where country_code = '" & SOURCE_COUNTRY_CODE & "'"
RecSet.Open Qstr, dbConnection
If RecSet.EOF = False Then
    Exchange1 = RecSet.Fields(0).Value
    BaseCurrencyAmount = Val(SOURCE_AMOUNT) / RecSet.Fields(0).Value
    BASE_AMOUNT = Format(BaseCurrencyAmount, "000000000000")
    
    EXISTS = True
    Else
    DESTINANTION_CURRENCY_CODE = SOURCE_CURRENCY_CODE
    DESTINANTION_AMOUNT = Format(SOURCE_AMOUNT, "000000000000")
    BASE_AMOUNT = Format(SOURCE_AMOUNT, "000000000000")
    
    EXISTS = False
    Exit Sub
End If
RecSet.Close

RecSet.Open "select * from em_currency  where country_code = '" & DESTINATION_COUNTRY_CODE & "'", dbConnection
If RecSet.EOF = False Then
  'DESTINATION_COUNTRY_CODE = Recset.Fields(0).value
  DESTINANTION_CURRENCY_CODE = RecSet.Fields(0).Value
  Exchange2 = RecSet.Fields(3).Value
  DESTINANTION_AMOUNT = Format(CLng(RecSet.Fields(3).Value * Val(BaseCurrencyAmount)), "000000000000")
  ExRate = Format(Exchange2 / Exchange1, "0.00")
   EXISTS = True
Else
  DESTINANTION_CURRENCY_CODE = SOURCE_CURRENCY_CODE
  DESTINANTION_AMOUNT = Format(BaseCurrencyAmount, "000000000000")
  EXISTS = False
End If
RecSet.Close
Exit Sub
ErrorTrap:
 EventsTrap = EventsTrap & vbNewLine & "Process CurrencyPick: " & err.Description
 EXISTS = False
 
End Sub

Private Sub Trace_Click()
FrmTrace.Show
FrmTrace.WindowState = 2
'statusbar.ShowTips
End Sub

Private Sub MTSOutGoingMessage(ByVal Message As String, ByRef StrMsgToSend As String, Optional ByRef Trace As String)
    On Error GoTo ErrorTrap
    Dim PostMsg As PostBridgeISO8583
    Dim strNewMessage As String
    Trace = ""
    Set PostMsg = New PostBridgeISO8583
    Dim ProcEvents As String
    
    
    Dim RecInstID As String
    Dim rstObj As ADODB.Recordset
    Dim strSQL As String
    Set rstObj = New ADODB.Recordset
    Dim OutLetIndex As Integer
    Dim OutLetMode As Integer
    Dim DstNodeName As Integer
    
    OutLetIndex = 0
    OutLetMode = 2
    
    'Only 0200, 0220,0221,0420,0421,0520,0521 expected
    '//////////////////////////////////////////////////////////////////////////////
    'No responses should be processed from this path.
    
    With PostMsg
         .ISO8583MsgBD Message
         .ResetBitMaps
         Trace = "Message type: " & .MessageTypeID & vbNewLine
        
                             
            'Get Customer's Country Institution ID
            If .MessageTypeID = "0200" Or .MessageTypeID = "0221" Or .MessageTypeID = "0420" Or .MessageTypeID = "0421" Or .MessageTypeID = "0520" Or .MessageTypeID = "0521" Then
                     If .AcquiringInstIdCode <> "" Then
                       RecInstID = .AcquiringInstIdCode
                       strSQL = "select pindex, ip_address, port,mode,node_name from em_merchant_pos_index where bin_code = '" & RecInstID & "'"
                        rstObj.Open strSQL, dbConnection
                            
                            If rstObj.EOF = False Then
                                 OutLetIndex = rstObj!Pindex
                                 OutLetMode = rstObj!Mode
                                 DstNodeName = rstObj!Node_Name
                            Else
                             ProcEvents = "Transaction reference number:" & .RetrievalRefNum & " system trace audit number " & .SysTraceAuditNum & " cannot routed. Destination offline"
                             .RespCode = "91"
                             
                                    If .MessageTypeID = "0200" Then
                                    .MessageTypeID = "0210"
                                    ElseIf .MessageTypeID = "0420" Then
                                    .MessageTypeID = "0430"
                                    ElseIf .MessageTypeID = "0421" Then
                                    .MessageTypeID = "0430"
                                    ElseIf .MessageTypeID = "0520" Then
                                    .MessageTypeID = "0530"
                                    ElseIf .MessageTypeID = "0521" Then
                                    .MessageTypeID = "0530"
                                    End If
                             End If
                             rstObj.Close
                    Else
                        ProcEvents = "Transaction reference number:" & .RetrievalRefNum & " system trace audit number " & .SysTraceAuditNum & " cannot routed. No receiving institution ID"
                        .RespCode = "92": .CreatePBBitMap (39)
                                    If .MessageTypeID = "0200" Then
                                    .MessageTypeID = "0210"
                                    ElseIf .MessageTypeID = "0420" Then
                                    .MessageTypeID = "0430"
                                    If .MessageTypeID = "0421" Then
                                    .MessageTypeID = "0430"
                                    ElseIf .MessageTypeID = "0520" Then
                                    .MessageTypeID = "0530"
                                     ElseIf .MessageTypeID = "0521" Then
                                    .MessageTypeID = "0530"
                                    End If
                    End If
                              
                  End If
           
                   
          
          'Get Agent's Country Institution ID
            ElseIf .MessageTypeID = "0210" And .RespCode = "00" Then
            
                     rstObj.Open "select * from em_agent_trans where ref_nr= '" & .RetrievalRefNum & "'", dbConnection
                     If rstObj.EOF = False Then
                        .MessageTypeID = "0220"
                        .AmtTransaction = rstObj!amount_req
                        .ReceivingInstIdCode = rstObj!Account_id3
                        .AccIdOne = rstObj!Account_id1
                        .AccIdTwo = rstObj!Account_id2
                                                
                     End If
                     rstObj.Close
                     
                    If .ReceivingInstIdCode <> "" Then
                       RecInstID = .ReceivingInstIdCode
                       strSQL = "select pindex, ip_address, port,mode,node_name from em_merchant_pos_index where bin_code = '" & RecInstID & "'"
                        rstObj.Open strSQL, dbConnection
                            
                            If rstObj.EOF = False Then
                                 OutLetIndex = rstObj!Pindex
                                 OutLetMode = rstObj!Mode
                                 DstNodeName = rstObj!Node_Name
                            Else
                             ProcEvents = "Transaction reference number:" & .RetrievalRefNum & " system trace audit number " & .SysTraceAuditNum & " cannot routed. Destination offline"
                             .RespCode = "91"
                             .MessageTypeID = "0420"
                                    
                             End If
                             rstObj.Close
                    Else
                        ProcEvents = "Transaction reference number:" & .RetrievalRefNum & " system trace audit number " & .SysTraceAuditNum & " cannot routed. No receiving institution ID"
                        .RespCode = "92": .CreatePBBitMap (39)
                        .MessageTypeID = "0420"
                    End If
                              
           End If
          
          
          'Build the message
        
        If .Pan <> "" Then .CreatePBBitMap (2): Trace = Trace & "Field 002: " & .Pan & vbNewLine
        If .ProcessingCODE <> "" Then .CreatePBBitMap (3): Trace = Trace & "Field 003: " & .ProcessingCODE & vbNewLine
        If .AmtTransaction <> "" Then .CreatePBBitMap (4): Trace = Trace & "Field 004: " & .AmtTransaction & vbNewLine
        If .AmtSettlement <> "" Then .CreatePBBitMap (5): Trace = Trace & "Field 005: " & .AmtSettlement & vbNewLine
        If .DatetimeTransmission <> "" Then .CreatePBBitMap (7): Trace = Trace & "Field 007: " & .DatetimeTransmission & vbNewLine
        If .ConvRateSettle <> "" Then .CreatePBBitMap (9): Trace = Trace & "Field 009: " & .ConvRateSettle & vbNewLine
        If .SysTraceAuditNum <> "" Then .CreatePBBitMap (11): Trace = Trace & "Field 011: " & .SysTraceAuditNum & vbNewLine
        If .TimeLocTxn <> "" Then .CreatePBBitMap (12): Trace = Trace & "Field 012: " & .DateLocTxn & vbNewLine
        If .DateLocTxn <> "" Then .CreatePBBitMap (13): Trace = Trace & "Field 013: " & .TimeLocTxn & vbNewLine
        If .DateExpiry <> "" Then .CreatePBBitMap (14): Trace = Trace & "Field 014: " & .DateExpiry & vbNewLine
        If .DateSettle <> "" Then .CreatePBBitMap (15): Trace = Trace & "Field 015: " & .DateSettle & vbNewLine
        If .MerchantType <> "" Then .CreatePBBitMap (18): Trace = Trace & "Field 018: " & .MerchantType & vbNewLine
        If .POSEntryMode <> "" Then .CreatePBBitMap (22): Trace = Trace & "Field 022: " & .POSEntryMode & vbNewLine
        If .CardSeqNum <> "" Then .CreatePBBitMap (23): Trace = Trace & "Field 023: " & .CardSeqNum & vbNewLine
        If .POSConditionCode <> "" Then .CreatePBBitMap (25): Trace = Trace & "Field 025: " & .POSConditionCode & vbNewLine
        If .POSPinCaptureCode <> "" Then .CreatePBBitMap (26): Trace = Trace & "Field 026: " & .POSPinCaptureCode & vbNewLine
        If .AmtTxnFee <> "" Then .CreatePBBitMap (28): Trace = Trace & "Field 028: " & .AmtTxnFee & vbNewLine
        If .AmtTxnProcessingFee <> "" Then .CreatePBBitMap (30): Trace = Trace & "Field 030: " & .AmtTxnProcessingFee & vbNewLine
        If .AcquiringInstIdCode <> "" Then .CreatePBBitMap (32): Trace = Trace & "Field 032: " & .AcquiringInstIdCode & vbNewLine
        If .ForwardingInstIdCode <> "" Then .CreatePBBitMap (33): Trace = Trace & "Field 033: " & .ForwardingInstIdCode & vbNewLine
        If .Track2Data <> "" Then .CreatePBBitMap (35): Trace = Trace & "Field 035: " & .Track2Data & vbNewLine
        If .RetrievalRefNum <> "" Then .CreatePBBitMap (37): Trace = Trace & "Field 037: " & .RetrievalRefNum & vbNewLine
        If .AuthIdResp <> "" Then .CreatePBBitMap (38): Trace = Trace & "Field 038: " & .AuthIdResp & vbNewLine
        If .RespCode <> "" Then .CreatePBBitMap (39): Trace = Trace & "Field 039: " & .RespCode & vbNewLine
        If .ServiceRestrictionCode <> "" Then .CreatePBBitMap (40): Trace = Trace & "Field 040: " & .ServiceRestrictionCode & vbNewLine
        If .CardAcceptorTermId <> "" Then .CreatePBBitMap (41): Trace = Trace & "Field 041: " & .CardAcceptorTermId & vbNewLine
        If .CardAcceptorIdCode <> "" Then .CreatePBBitMap (42): Trace = Trace & "Field 042: " & .CardAcceptorIdCode & vbNewLine
        If .CardAcceptorNameLoc <> "" Then .CreatePBBitMap (43): Trace = Trace & "Field 043: " & .CardAcceptorNameLoc & vbNewLine
        If .AdditionalRespData <> "" Then .CreatePBBitMap (44):: Trace = Trace & "Field 044: " & .AdditionalRespData & vbNewLine
        If .AdditionalData <> "" Then .CreatePBBitMap (48): Trace = Trace & "Field 048: " & .AdditionalData & vbNewLine
        If .CurrencyCodeTxn <> "" Then .CreatePBBitMap (49): Trace = Trace & "Field 049: " & .CurrencyCodeTxn & vbNewLine
        If .CurrencyCodeSettle <> "" Then .CreatePBBitMap (50): Trace = Trace & "Field 050: " & .CurrencyCodeSettle & vbNewLine
        If .PinData <> "" Then .CreatePBBitMap (52): Trace = Trace & "Field 052: " & "****************" & vbNewLine
        If .AdditionalAmts <> "" Then .CreatePBBitMap (54): Trace = Trace & "Field 054: " & .AdditionalAmts & vbNewLine
        If .MsgReasonCode <> "" Then .CreatePBBitMap (56): Trace = Trace & "Field 056: " & .MsgReasonCode & vbNewLine
        If .EchoData <> "" Then .CreatePBBitMap (59): Trace = Trace & "Field 059: " & .EchoData & vbNewLine
        If .NetMangtInfoCode <> "" Then .CreatePBBitMap (70): Trace = Trace & "Field 070: " & .NetMangtInfoCode & vbNewLine
        If .OriginalDataElements <> "" Then .CreatePBBitMap (90): Trace = Trace & "Field 090: " & .OriginalDataElements & vbNewLine
        If .ReplacementAmts <> "" Then .CreatePBBitMap (95): Trace = Trace & "Field 095: " & .ReplacementAmts & vbNewLine
        If .ReceivingInstIdCode <> "" Then .CreatePBBitMap (100): Trace = Trace & "Field 100: " & .ReceivingInstIdCode & vbNewLine
        If .AccIdOne <> "" Then .CreatePBBitMap (102): Trace = Trace & "Field 102: " & .AccIdOne & vbNewLine
        If .AccIdTwo <> "" Then .CreatePBBitMap (103): Trace = Trace & "Field 103: " & .AccIdTwo & vbNewLine
                     
          
        StrMsgToSend = .CREATEMsgISO8538
        
        'Responce Message to Source
        
        Dim MessageSentIndicator As Integer
        MessageSentIndicator = 0
           
        If .MessageTypeID = "0210" Or .MessageTypeID = "0430" Or .MessageTypeID = "0810" Then
           Dim Source_Key As String
           
           Source_Key = .AdditionalRespData
           
           If Source_Key <> "" Then
              If Right(Source_Key, 1) = 0 Then 'Merchant Socket Node
                        Source_Key = Left(Source_Key, Len(Source_Key) - 2)
                        Call SendMessageToMerchant(StrMsgToSend, Val(Mid(Source_Key, 1, Len(Source_Key) - InStr(1, Source_Key, "_"))), MessageSentIndicator)

              ElseIf Right(Source_Key, 1) = 1 Then
                        Source_Key = Left(Source_Key, Len(Source_Key) - 2)
                        Call SendMessageToSwitch(StrMsgToSend, Val(Mid(Source_Key, 1, Len(Source_Key) - InStr(1, Source_Key, "_"))), MessageSentIndicator)
              Else
              GoTo RouteBasedOnAcq
              End If
              
              
             If MessageSentIndicator = 1 Then
                If Trace_Flag = 1 And DstNodeName = FrmTrace.Combo1.List(FrmTrace.Combo1.ListIndex) Then
                FrmTrace.Text1 = FrmTrace.Text1 & vbNewLine & "Message to " & Source_Key & vbNewLine & StrMsgToSend
                FrmTrace.Text1 = FrmTrace.Text1 & vbNewLine & Trace
                End If
             Else
                If Trace_Flag = 1 And DstNodeName = FrmTrace.Combo1.List(FrmTrace.Combo1.ListIndex) Then
                FrmTrace.Text1 = FrmTrace.Text1 & vbNewLine & "Message to " & Source_Key & vbNewLine & StrMsgToSend
                FrmTrace.Text1 = FrmTrace.Text1 & vbNewLine & Trace
                FrmTrace.Text1 = FrmTrace.Text1 & vbNewLine & "Message to  " & Source_Key & ".Interchange is offline."
                End If
             End If
            
          Else
            
RouteBasedOnAcq:
             If .AcquiringInstIdCode <> "" Then
                       RecInstID = .AcquiringInstIdCode
                       strSQL = "select pindex, ip_address, port,mode,node_name from em_merchant_pos_index where bin_code = '" & RecInstID & "'"
                        rstObj.Open strSQL, dbConnection
                            
                            If rstObj.EOF = False Then
                                 OutLetIndex = rstObj!Pindex
                                 OutLetMode = rstObj!Mode
                                 DstNodeName = rstObj!Node_Name
                                                                 
                               If OutLetIndex <> 0 And OutLetMode = 1 Then
                               SendMessageToSwitch StrMsgToSend, OutLetIndex, MessageSentIndicator
                               ElseIf OutLetIndex <> 0 And OutLetMode = 0 Then
                               SendMessageToMerchant StrMsgToSend, GetIndexOut(OutLetIndex), MessageSentIndicator
                               End If
                               
                            If MessageSentIndicator = 1 Then
                               If Trace_Flag = 1 And DstNodeName = FrmTrace.Combo1.List(FrmTrace.Combo1.ListIndex) Then
                                FrmTrace.Text1 = FrmTrace.Text1 & vbNewLine & "Message To " & DstNodeName & vbNewLine & StrMsgToSend
                                FrmTrace.Text1 = FrmTrace.Text1 & vbNewLine & Trace
                                                              
                                End If
                             Else
                                If Trace_Flag = 1 And DstNodeName = FrmTrace.Combo1.List(FrmTrace.Combo1.ListIndex) Then
                                FrmTrace.Text1 = FrmTrace.Text1 & vbNewLine & "Message to " & DstNodeName & vbNewLine & StrMsgToSend
                                FrmTrace.Text1 = FrmTrace.Text1 & vbNewLine & Trace
                                FrmTrace.Text1 = FrmTrace.Text1 & vbNewLine & "Message to  " & DstNodeName & ".Interchange is offline."
                               End If
                            End If
                          End If
          
                  End If
           
           End If
            
           
         Else  '0200,0420,0421,0520
          
        'Request Message to Sink
          
           
           If OutLetIndex <> 0 And OutLetMode = 1 Then
              SendMessageToSwitch StrMsgToSend, OutLetIndex, MessageSentIndicator
           ElseIf OutLetIndex <> 0 And OutLetMode = 0 Then
              SendMessageToMerchant StrMsgToSend, GetIndexOut(OutLetIndex), MessageSentIndicator
           End If
                   
         
           If MessageSentIndicator = 1 Then
             If Trace_Flag = 1 And DstNodeName = FrmTrace.Combo1.List(FrmTrace.Combo1.ListIndex) Then
             FrmTrace.Text1 = FrmTrace.Text1 & vbNewLine & "Message To " & DstNodeName & vbNewLine & StrMsgToSend
             FrmTrace.Text1 = FrmTrace.Text1 & vbNewLine & Trace
             End If
           Else
             If Trace_Flag = 1 And DstNodeName = FrmTrace.Combo1.List(FrmTrace.Combo1.ListIndex) Then
             FrmTrace.Text1 = FrmTrace.Text1 & vbNewLine & "Message to " & DstNodeName & vbNewLine & StrMsgToSend
             FrmTrace.Text1 = FrmTrace.Text1 & vbNewLine & "Message to  " & DstNodeName & ".Interchange is offline."
             End If
           End If
           
        End If
        
       End With
       
        
    
    Exit Sub
       
ErrorTrap:
  
  EventsTrap = txt_log.Text & vbNewLine & "Process MTSOutGoingMessage: " & err.Description
  
     
End Sub

Public Function TranslatePIN(ByVal SOURCE_COUNTRY_CODE As String, ByVal DESTINATION_COUNTRY_CODE As String, ByVal SOURCE_PINBLOCK As String) As String

On Error GoTo ErrorTrap

Dim RecSet As New ADODB.Recordset
Dim SOURCE_ZPK_KEY, DESTINATION_ZPK_KEY As String

Dim Qstr As String
Qstr = "select * from em_hsm where key_code = '" & SOURCE_COUNTRY_CODE & "'"
RecSet.Open Qstr, dbConnection

If RecSet.EOF = False Then
    
    
Else
    
    Exit Function
End If
RecSet.Close

RecSet.Open "select * from em_hsm where key_code = '" & DESTINATION_COUNTRY_CODE & "'"
RecSet.Open Qstr, dbConnection

If RecSet.EOF = False Then


Else
  Exit Function
End If
RecSet.Close

TranslatePIN = ""

Exit Function
ErrorTrap:
End Function



Private Sub VerifyPinBlock(ByVal PINBlock As String, ByVal Pan As String, ByVal Action As String, ByVal ZPK As String)


        
            Dim Pin As String
            Dim nResult As Integer
            Dim Length(2)  As Byte
            Dim ByteMessage() As Byte
            Dim InMessage As String

            Dim StringByteMessage As String
            'set StringByteMessage = new StringBuilder(5000)
            Dim i As Integer

            ReDim ByteMessage(5000)

'            On Error GoTo ErrTrap
            
'                SocketTools.SocketWrench SocketConnection = new SocketTools.SocketWrench();
'                SocketConnection.Reset();
'                SocketConnection.Blocking = true;
'                SocketConnection.Secure = false;
'                SocketConnection.Timeout = 20;
'
'                SocketConnection.Connect(HSMIP, System.Convert.ToInt16(HSMPort));

                Dim Header As String
                Header = "0000"
 
                Dim HSM As String

                Dim Offset As String
                 'Offset = GetOffsetValue(Pan)

                '//PINBlock = des(PINBlock);




                'HSM = Header + "EA" + ZPK + PVK + "12" + PINBlock + "01" + "04" + Pan.Substring(3, 12) + DecimilizationTable + ValidationTable + Offset + "FFFFFFFF"




'                dim  mLength as integer= (byte)HSM.Length;
'
'                Length[0] = (byte)(mLength / 256);
'                Length[1] = (byte)(mLength % 256);

'                nResult = SocketConnection.Write(Length);
'                nResult = SocketConnection.Write(HSM);


'                nResult = SocketConnection.Read(ByteMessage);
'
'                //nResult = SocketConnection.Read(TestString);
'
'                byte[] IM1 = new byte[ByteMessage.Length];
'
'                for (i = 1; i <= nResult; i++)
'                {
'                    StringByteMessage.Append((char)ByteMessage[i - 1]);
'                    IM1[i - 1] = ByteMessage[i - 1];
'                }
'
'                InMessage = StringByteMessage.ToString();
'
'
'                Pin = "";
'                Pin = InMessage.Substring(8, 2);
'
'                if (Pin == "00" && Action == "93")
'                {
'                    bool x = updatedb(PAN, InMessage.Substring(InMessage.Length - 10, 4));
'                }
'
'                return Pin;
'            Exit Sub
'
'
'                nResult = 0;
'                return "05";
'
        End Sub

Private Sub TransHist_Click()
  If frmODBCLogon.LOGINSUCCESS = 1 Then
     frmHSM.Show
Else
frmODBCLogon.FORMNAME = 4
frmODBCLogon.Show

End If
End Sub

Private Sub TransTmr_Timer(Index As Integer)
 On Error GoTo Quit
  Dim RecSet As New ADODB.Recordset
  RecSet.Open "select * from em_agent_trans_1_a where ref_nr = '" & TransTmr(Index).Tag & "'", dbConnection
  If RecSet.EOF = False Then
     If RecSet!State = 1 Then
       dbConnection.Execute "update em_agent_trans_1_a set state = 4, resp_code = '91' where ref_nr = '" & TransTmr(Index).Tag & "'"
       
       GetTransactionDetails (TransTmr(Index).Tag)
       Unload TransTmr(Index)
       TransTimers(Index) = 0
       
     ElseIf RecSet!State = 2 And RecSet!Resp_code <> "00" Then
       dbConnection.Execute "update em_agent_trans_1_a set state = 99 where ref_nr = '" & TransTmr(Index).Tag & "'"
       Unload TransTmr(Index)
       TransTimers(Index) = 0
     Else
       Unload TransTmr(Index)
       TransTimers(Index) = 0
     End If
  End If
Quit:
  
End Sub

Private Sub Uptime_Click()
SwtFrm.Show
End Sub
